# NeoScan 系统数据模型设计

> 基于 NeoScan 产品需求文档 v1.0 和目录结构设计 pkg-v4.0
> 支持 Master-Agent 分布式架构的数据模型设计
> 设计日期：2025年8月

## 1. 数据模型架构概述

### 1.1 设计原则
- **分层设计**：按照业务领域划分模型层次
- **松耦合**：模型间依赖关系清晰，便于维护
- **可扩展**：支持功能扩展和业务变更
- **高性能**：优化数据结构，支持高并发访问
- **安全性**：敏感数据加密存储，访问权限控制

### 1.2 存储架构
- **MySQL**：主要业务数据存储
- **Redis**：缓存和会话存储
- **SQLite**：Agent节点本地存储
- **文件系统**：扫描结果和报告文件存储

### 1.3 模型分类
```
数据模型分类
├── Master节点模型
│   ├── 用户管理模型
│   ├── Agent管理模型
│   ├── 任务管理模型
│   ├── 资产管理模型
│   ├── 漏洞管理模型
│   ├── 插件管理模型
│   ├── 监控预警模型
│   └── 系统管理模型
├── Agent节点模型
│   ├── 本地任务模型
│   ├── 配置管理模型
│   ├── 扫描结果模型
│   └── 插件执行模型
└── 共享通信模型
    ├── gRPC通信模型
    ├── 消息队列模型
    └── WebSocket模型
```

## 2. Master节点数据模型

### 2.1 用户管理模型

#### 2.1.1 用户模型 (User)
**文件路径**: `neoMaster/internal/model/user.go`

```go
// User 用户基础信息模型
type User struct {
    ID          uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    Username    string    `gorm:"uniqueIndex;size:50;not null" json:"username"`     // 用户名
    Email       string    `gorm:"uniqueIndex;size:100" json:"email"`               // 邮箱
    Password    string    `gorm:"size:255;not null" json:"-"`                      // 密码哈希
    RealName    string    `gorm:"size:50" json:"real_name"`                        // 真实姓名
    Phone       string    `gorm:"size:20" json:"phone"`                            // 手机号
    Department  string    `gorm:"size:100" json:"department"`                      // 部门
    Position    string    `gorm:"size:50" json:"position"`                         // 职位
    Status      int       `gorm:"default:1" json:"status"`                         // 状态：1-正常，0-禁用
    LastLoginAt *time.Time `json:"last_login_at"`                                  // 最后登录时间
    CreatedAt   time.Time `json:"created_at"`                                      // 创建时间
    UpdatedAt   time.Time `json:"updated_at"`                                      // 更新时间
    
    // 关联关系
    Roles       []Role    `gorm:"many2many:user_roles;" json:"roles"`              // 用户角色
    Sessions    []Session `gorm:"foreignKey:UserID" json:"-"`                     // 用户会话
}
```

#### 2.1.2 角色模型 (Role)
**文件路径**: `neoMaster/internal/model/role.go`

```go
// Role 角色模型
type Role struct {
    ID          uint       `gorm:"primaryKey;autoIncrement" json:"id"`
    Name        string     `gorm:"uniqueIndex;size:50;not null" json:"name"`       // 角色名称
    DisplayName string     `gorm:"size:100" json:"display_name"`                   // 显示名称
    Description string     `gorm:"size:255" json:"description"`                    // 角色描述
    IsSystem    bool       `gorm:"default:false" json:"is_system"`                 // 是否系统角色
    Status      int        `gorm:"default:1" json:"status"`                        // 状态：1-启用，0-禁用
    CreatedAt   time.Time  `json:"created_at"`
    UpdatedAt   time.Time  `json:"updated_at"`
    
    // 关联关系
    Users       []User       `gorm:"many2many:user_roles;" json:"-"`               // 角色用户
    Permissions []Permission `gorm:"many2many:role_permissions;" json:"permissions"` // 角色权限
}
```

#### 2.1.3 权限模型 (Permission)
**文件路径**: `neoMaster/internal/model/permission.go`

```go
// Permission 权限模型
type Permission struct {
    ID          uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    Name        string    `gorm:"uniqueIndex;size:100;not null" json:"name"`      // 权限名称
    DisplayName string    `gorm:"size:100" json:"display_name"`                   // 显示名称
    Description string    `gorm:"size:255" json:"description"`                    // 权限描述
    Resource    string    `gorm:"size:50;not null" json:"resource"`               // 资源类型
    Action      string    `gorm:"size:50;not null" json:"action"`                 // 操作类型
    CreatedAt   time.Time `json:"created_at"`
    UpdatedAt   time.Time `json:"updated_at"`
    
    // 关联关系
    Roles       []Role    `gorm:"many2many:role_permissions;" json:"-"`          // 权限角色
}
```

#### 2.1.4 会话模型 (Session)
**文件路径**: `neoMaster/internal/model/session.go`

```go
// Session 用户会话模型
type Session struct {
    ID          string    `gorm:"primaryKey;size:128" json:"id"`                  // 会话ID
    UserID      uint      `gorm:"index;not null" json:"user_id"`                  // 用户ID
    Token       string    `gorm:"uniqueIndex;size:255;not null" json:"-"`        // 访问令牌
    RefreshToken string   `gorm:"uniqueIndex;size:255" json:"-"`                 // 刷新令牌
    IPAddress   string    `gorm:"size:45" json:"ip_address"`                      // IP地址
    UserAgent   string    `gorm:"size:500" json:"user_agent"`                     // 用户代理
    ExpiresAt   time.Time `gorm:"index" json:"expires_at"`                        // 过期时间
    CreatedAt   time.Time `json:"created_at"`
    UpdatedAt   time.Time `json:"updated_at"`
    
    // 关联关系
    User        User      `gorm:"foreignKey:UserID" json:"user"`                 // 关联用户
}
```

### 2.2 Agent管理模型

#### 2.2.1 Agent节点模型 (Agent)
**文件路径**: `neoMaster/internal/model/agent.go`

```go
// Agent Agent节点模型
type Agent struct {
    ID            uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    Name          string    `gorm:"size:100;not null" json:"name"`                 // Agent名称
    Hostname      string    `gorm:"size:100" json:"hostname"`                      // 主机名
    IPAddress     string    `gorm:"size:45;not null" json:"ip_address"`            // IP地址
    Port          int       `gorm:"default:8080" json:"port"`                      // 端口
    Version       string    `gorm:"size:20" json:"version"`                        // 版本号
    OS            string    `gorm:"size:50" json:"os"`                             // 操作系统
    Architecture  string    `gorm:"size:20" json:"architecture"`                   // 系统架构
    Region        string    `gorm:"size:50" json:"region"`                         // 地域
    Tags          string    `gorm:"type:text" json:"tags"`                         // 标签(JSON格式)
    Status        int       `gorm:"default:0" json:"status"`                       // 状态：0-离线，1-在线，2-忙碌，3-故障
    LastHeartbeat time.Time `json:"last_heartbeat"`                               // 最后心跳时间
    RegisteredAt  time.Time `json:"registered_at"`                                // 注册时间
    CreatedAt     time.Time `json:"created_at"`
    UpdatedAt     time.Time `json:"updated_at"`
    
    // 关联关系
    Tasks         []Task         `gorm:"foreignKey:AgentID" json:"-"`              // Agent任务
    Metrics       []AgentMetrics `gorm:"foreignKey:AgentID" json:"-"`              // Agent指标
    Configs       []AgentConfig  `gorm:"foreignKey:AgentID" json:"-"`              // Agent配置
}
```

#### 2.2.2 Agent指标模型 (AgentMetrics)
**文件路径**: `neoMaster/internal/model/agent_metrics.go`

```go
// AgentMetrics Agent性能指标模型
type AgentMetrics struct {
    ID              uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    AgentID         uint      `gorm:"index;not null" json:"agent_id"`             // Agent ID
    CPUUsage        float64   `json:"cpu_usage"`                                  // CPU使用率
    MemoryUsage     float64   `json:"memory_usage"`                               // 内存使用率
    DiskUsage       float64   `json:"disk_usage"`                                 // 磁盘使用率
    NetworkIn       uint64    `json:"network_in"`                                 // 网络入流量
    NetworkOut      uint64    `json:"network_out"`                                // 网络出流量
    ActiveTasks     int       `json:"active_tasks"`                               // 活跃任务数
    CompletedTasks  int       `json:"completed_tasks"`                            // 完成任务数
    FailedTasks     int       `json:"failed_tasks"`                               // 失败任务数
    CollectedAt     time.Time `gorm:"index" json:"collected_at"`                  // 采集时间
    CreatedAt       time.Time `json:"created_at"`
    
    // 关联关系
    Agent           Agent     `gorm:"foreignKey:AgentID" json:"agent"`           // 关联Agent
}
```

#### 2.2.3 Agent配置模型 (AgentConfig)
**文件路径**: `neoMaster/internal/model/agent_config.go`

```go
// AgentConfig Agent配置模型
type AgentConfig struct {
    ID          uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    AgentID     uint      `gorm:"index;not null" json:"agent_id"`               // Agent ID
    ConfigKey   string    `gorm:"size:100;not null" json:"config_key"`          // 配置键
    ConfigValue string    `gorm:"type:text" json:"config_value"`                // 配置值
    ConfigType  string    `gorm:"size:20;default:'string'" json:"config_type"`  // 配置类型
    Description string    `gorm:"size:255" json:"description"`                  // 配置描述
    IsEncrypted bool      `gorm:"default:false" json:"is_encrypted"`            // 是否加密
    Version     int       `gorm:"default:1" json:"version"`                     // 配置版本
    Status      int       `gorm:"default:1" json:"status"`                      // 状态：1-生效，0-失效
    CreatedAt   time.Time `json:"created_at"`
    UpdatedAt   time.Time `json:"updated_at"`
    
    // 关联关系
    Agent       Agent     `gorm:"foreignKey:AgentID" json:"agent"`             // 关联Agent
}
```

### 2.3 任务管理模型

#### 2.3.1 任务模型 (Task)
**文件路径**: `neoMaster/internal/model/task.go`

```go
// Task 扫描任务模型
type Task struct {
    ID            uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    Name          string    `gorm:"size:200;not null" json:"name"`               // 任务名称
    Description   string    `gorm:"type:text" json:"description"`                // 任务描述
    Type          string    `gorm:"size:50;not null" json:"type"`                // 任务类型
    Priority      int       `gorm:"default:5" json:"priority"`                   // 优先级：1-10
    Status        int       `gorm:"default:0" json:"status"`                     // 状态：0-待执行，1-执行中，2-已完成，3-失败，4-已取消
    Progress      float64   `gorm:"default:0" json:"progress"`                   // 执行进度
    AgentID       *uint     `gorm:"index" json:"agent_id"`                       // 分配的Agent ID
    CreatedBy     uint      `gorm:"index;not null" json:"created_by"`            // 创建者ID
    ScheduledAt   *time.Time `json:"scheduled_at"`                               // 计划执行时间
    StartedAt     *time.Time `json:"started_at"`                                 // 开始执行时间
    CompletedAt   *time.Time `json:"completed_at"`                               // 完成时间
    CreatedAt     time.Time `json:"created_at"`
    UpdatedAt     time.Time `json:"updated_at"`
    
    // 任务配置和结果
    Config        TaskConfig   `gorm:"foreignKey:TaskID" json:"config"`           // 任务配置
    Results       []TaskResult `gorm:"foreignKey:TaskID" json:"results"`          // 任务结果
    
    // 关联关系
    Agent         *Agent       `gorm:"foreignKey:AgentID" json:"agent"`           // 分配的Agent
    Creator       User         `gorm:"foreignKey:CreatedBy" json:"creator"`       // 创建者
    Assets        []Asset      `gorm:"many2many:task_assets;" json:"assets"`      // 关联资产
}
```

#### 2.3.2 任务配置模型 (TaskConfig)
**文件路径**: `neoMaster/internal/model/task_config.go`

```go
// TaskConfig 任务配置模型
type TaskConfig struct {
    ID              uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    TaskID          uint      `gorm:"uniqueIndex;not null" json:"task_id"`        // 任务ID
    ScanType        string    `gorm:"size:50;not null" json:"scan_type"`          // 扫描类型
    Targets         string    `gorm:"type:text;not null" json:"targets"`          // 扫描目标
    Ports           string    `gorm:"type:text" json:"ports"`                     // 端口范围
    Threads         int       `gorm:"default:10" json:"threads"`                 // 线程数
    Timeout         int       `gorm:"default:30" json:"timeout"`                 // 超时时间
    Plugins         string    `gorm:"type:text" json:"plugins"`                  // 使用的插件
    Options         string    `gorm:"type:text" json:"options"`                  // 其他选项(JSON格式)
    CreatedAt       time.Time `json:"created_at"`
    UpdatedAt       time.Time `json:"updated_at"`
    
    // 关联关系
    Task            Task      `gorm:"foreignKey:TaskID" json:"task"`             // 关联任务
}
```

#### 2.3.3 任务结果模型 (TaskResult)
**文件路径**: `neoMaster/internal/model/task_result.go`

```go
// TaskResult 任务结果模型
type TaskResult struct {
    ID          uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    TaskID      uint      `gorm:"index;not null" json:"task_id"`               // 任务ID
    Target      string    `gorm:"size:255;not null" json:"target"`             // 扫描目标
    ResultType  string    `gorm:"size:50;not null" json:"result_type"`         // 结果类型
    Status      string    `gorm:"size:20;not null" json:"status"`              // 结果状态
    Data        string    `gorm:"type:longtext" json:"data"`                   // 结果数据(JSON格式)
    RawOutput   string    `gorm:"type:longtext" json:"raw_output"`             // 原始输出
    ErrorMsg    string    `gorm:"type:text" json:"error_msg"`                  // 错误信息
    CreatedAt   time.Time `json:"created_at"`
    
    // 关联关系
    Task        Task      `gorm:"foreignKey:TaskID" json:"task"`               // 关联任务
    
    // 如果是漏洞结果，关联漏洞记录
    Vulnerabilities []Vulnerability `gorm:"foreignKey:TaskResultID" json:"vulnerabilities"`
}
```

### 2.4 资产管理模型

#### 2.4.1 资产模型 (Asset)
**文件路径**: `neoMaster/internal/model/asset.go`

```go
// Asset 资产模型
type Asset struct {
    ID            uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    Name          string    `gorm:"size:200" json:"name"`                        // 资产名称
    Type          string    `gorm:"size:50;not null" json:"type"`                // 资产类型：host, domain, url, ip
    Value         string    `gorm:"size:500;not null" json:"value"`              // 资产值
    Description   string    `gorm:"type:text" json:"description"`                // 资产描述
    Owner         string    `gorm:"size:100" json:"owner"`                       // 资产负责人
    Department    string    `gorm:"size:100" json:"department"`                  // 所属部门
    Importance    int       `gorm:"default:3" json:"importance"`                 // 重要性：1-5
    Status        int       `gorm:"default:1" json:"status"`                     // 状态：1-正常，0-下线
    Tags          string    `gorm:"type:text" json:"tags"`                       // 标签(JSON格式)
    LastScanAt    *time.Time `json:"last_scan_at"`                              // 最后扫描时间
    CreatedAt     time.Time `json:"created_at"`
    UpdatedAt     time.Time `json:"updated_at"`
    
    // 关联关系
    Services      []Service       `gorm:"foreignKey:AssetID" json:"services"`       // 资产服务
    Vulnerabilities []Vulnerability `gorm:"foreignKey:AssetID" json:"vulnerabilities"` // 资产漏洞
    Tasks         []Task          `gorm:"many2many:task_assets;" json:"-"`          // 关联任务
}
```

#### 2.4.2 服务模型 (Service)
**文件路径**: `neoMaster/internal/model/service.go`

```go
// Service 服务模型
type Service struct {
    ID          uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    AssetID     uint      `gorm:"index;not null" json:"asset_id"`              // 资产ID
    Protocol    string    `gorm:"size:20;not null" json:"protocol"`            // 协议类型
    Port        int       `gorm:"not null" json:"port"`                        // 端口号
    Service     string    `gorm:"size:100" json:"service"`                     // 服务名称
    Version     string    `gorm:"size:100" json:"version"`                     // 服务版本
    Product     string    `gorm:"size:100" json:"product"`                     // 产品名称
    Banner      string    `gorm:"type:text" json:"banner"`                     // 服务横幅
    State       string    `gorm:"size:20;default:'open'" json:"state"`         // 端口状态
    Confidence  int       `gorm:"default:0" json:"confidence"`                 // 识别置信度
    CreatedAt   time.Time `json:"created_at"`
    UpdatedAt   time.Time `json:"updated_at"`
    
    // 关联关系
    Asset       Asset     `gorm:"foreignKey:AssetID" json:"asset"`             // 关联资产
}
```

### 2.5 漏洞管理模型

#### 2.5.1 漏洞模型 (Vulnerability)
**文件路径**: `neoMaster/internal/model/vulnerability.go`

```go
// Vulnerability 漏洞模型
type Vulnerability struct {
    ID            uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    Title         string    `gorm:"size:500;not null" json:"title"`             // 漏洞标题
    CVE           string    `gorm:"size:20;index" json:"cve"`                   // CVE编号
    CNVD          string    `gorm:"size:20;index" json:"cnvd"`                  // CNVD编号
    CNNVD         string    `gorm:"size:20;index" json:"cnnvd"`                 // CNNVD编号
    Severity      string    `gorm:"size:20;not null" json:"severity"`           // 严重程度：critical, high, medium, low
    CVSS          float64   `gorm:"default:0" json:"cvss"`                      // CVSS评分
    Category      string    `gorm:"size:100" json:"category"`                   // 漏洞分类
    Description   string    `gorm:"type:text" json:"description"`               // 漏洞描述
    Solution      string    `gorm:"type:text" json:"solution"`                  // 修复建议
    References    string    `gorm:"type:text" json:"references"`                // 参考链接
    AssetID       *uint     `gorm:"index" json:"asset_id"`                      // 关联资产ID
    TaskResultID  *uint     `gorm:"index" json:"task_result_id"`                // 关联任务结果ID
    Status        int       `gorm:"default:1" json:"status"`                    // 状态：1-未修复，2-已修复，3-误报，4-忽略
    VerifiedAt    *time.Time `json:"verified_at"`                               // 验证时间
    FixedAt       *time.Time `json:"fixed_at"`                                  // 修复时间
    CreatedAt     time.Time `json:"created_at"`
    UpdatedAt     time.Time `json:"updated_at"`
    
    // 关联关系
    Asset         *Asset     `gorm:"foreignKey:AssetID" json:"asset"`            // 关联资产
    TaskResult    *TaskResult `gorm:"foreignKey:TaskResultID" json:"task_result"` // 关联任务结果
    POCs          []POC      `gorm:"foreignKey:VulnID" json:"pocs"`              // 关联POC
}
```

#### 2.5.2 POC模型 (POC)
**文件路径**: `neoMaster/internal/model/poc.go`

```go
// POC 漏洞验证代码模型
type POC struct {
    ID          uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    VulnID      *uint     `gorm:"index" json:"vuln_id"`                        // 关联漏洞ID
    Name        string    `gorm:"size:200;not null" json:"name"`               // POC名称
    Type        string    `gorm:"size:50;not null" json:"type"`                // POC类型：nuclei, xray, custom
    Content     string    `gorm:"type:longtext;not null" json:"content"`       // POC内容
    Author      string    `gorm:"size:100" json:"author"`                      // 作者
    Version     string    `gorm:"size:20" json:"version"`                      // 版本
    Tags        string    `gorm:"type:text" json:"tags"`                       // 标签
    Verified    bool      `gorm:"default:false" json:"verified"`              // 是否已验证
    Enabled     bool      `gorm:"default:true" json:"enabled"`                // 是否启用
    CreatedAt   time.Time `json:"created_at"`
    UpdatedAt   time.Time `json:"updated_at"`
    
    // 关联关系
    Vulnerability *Vulnerability `gorm:"foreignKey:VulnID" json:"vulnerability"`  // 关联漏洞
}
```

### 2.6 插件管理模型

#### 2.6.1 插件模型 (Plugin)
**文件路径**: `neoMaster/internal/model/plugin.go`

```go
// Plugin 插件模型
type Plugin struct {
    ID            uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    Name          string    `gorm:"uniqueIndex;size:100;not null" json:"name"`  // 插件名称
    DisplayName   string    `gorm:"size:200" json:"display_name"`               // 显示名称
    Version       string    `gorm:"size:20;not null" json:"version"`            // 插件版本
    Type          string    `gorm:"size:50;not null" json:"type"`               // 插件类型
    Category      string    `gorm:"size:50" json:"category"`                    // 插件分类
    Description   string    `gorm:"type:text" json:"description"`               // 插件描述
    Author        string    `gorm:"size:100" json:"author"`                     // 作者
    Homepage      string    `gorm:"size:500" json:"homepage"`                   // 主页
    Repository    string    `gorm:"size:500" json:"repository"`                 // 代码仓库
    FilePath      string    `gorm:"size:500" json:"file_path"`                  // 文件路径
    FileHash      string    `gorm:"size:64" json:"file_hash"`                   // 文件哈希
    Config        string    `gorm:"type:text" json:"config"`                    // 插件配置
    Dependencies  string    `gorm:"type:text" json:"dependencies"`              // 依赖关系
    Status        int       `gorm:"default:1" json:"status"`                    // 状态：1-启用，0-禁用
    IsOfficial    bool      `gorm:"default:false" json:"is_official"`           // 是否官方插件
    DownloadCount int       `gorm:"default:0" json:"download_count"`            // 下载次数
    InstallCount  int       `gorm:"default:0" json:"install_count"`             // 安装次数
    CreatedAt     time.Time `json:"created_at"`
    UpdatedAt     time.Time `json:"updated_at"`
    
    // 关联关系
    Installations []PluginInstallation `gorm:"foreignKey:PluginID" json:"-"`     // 插件安装记录
}
```

#### 2.6.2 插件安装模型 (PluginInstallation)
**文件路径**: `neoMaster/internal/model/plugin_installation.go`

```go
// PluginInstallation 插件安装记录模型
type PluginInstallation struct {
    ID          uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    PluginID    uint      `gorm:"index;not null" json:"plugin_id"`             // 插件ID
    AgentID     uint      `gorm:"index;not null" json:"agent_id"`              // Agent ID
    Version     string    `gorm:"size:20;not null" json:"version"`             // 安装版本
    Status      int       `gorm:"default:1" json:"status"`                     // 状态：1-已安装，0-已卸载，2-安装失败
    Config      string    `gorm:"type:text" json:"config"`                     // 安装配置
    InstallPath string    `gorm:"size:500" json:"install_path"`                // 安装路径
    ErrorMsg    string    `gorm:"type:text" json:"error_msg"`                  // 错误信息
    InstalledAt time.Time `json:"installed_at"`                                // 安装时间
    UpdatedAt   time.Time `json:"updated_at"`
    
    // 关联关系
    Plugin      Plugin    `gorm:"foreignKey:PluginID" json:"plugin"`          // 关联插件
    Agent       Agent     `gorm:"foreignKey:AgentID" json:"agent"`             // 关联Agent
}
```

### 2.7 监控预警模型

#### 2.7.1 监控规则模型 (MonitorRule)
**文件路径**: `neoMaster/internal/model/monitor_rule.go`

```go
// MonitorRule 监控规则模型
type MonitorRule struct {
    ID          uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    Name        string    `gorm:"size:200;not null" json:"name"`               // 规则名称
    Type        string    `gorm:"size:50;not null" json:"type"`                // 规则类型
    Description string    `gorm:"type:text" json:"description"`                // 规则描述
    Conditions  string    `gorm:"type:text;not null" json:"conditions"`        // 触发条件(JSON格式)
    Actions     string    `gorm:"type:text;not null" json:"actions"`           // 执行动作(JSON格式)
    Severity    string    `gorm:"size:20;not null" json:"severity"`            // 告警级别
    Enabled     bool      `gorm:"default:true" json:"enabled"`                // 是否启用
    CreatedBy   uint      `gorm:"index;not null" json:"created_by"`            // 创建者ID
    CreatedAt   time.Time `json:"created_at"`
    UpdatedAt   time.Time `json:"updated_at"`
    
    // 关联关系
    Creator     User      `gorm:"foreignKey:CreatedBy" json:"creator"`         // 创建者
    Alerts      []Alert   `gorm:"foreignKey:RuleID" json:"-"`                 // 产生的告警
}
```

#### 2.7.2 告警模型 (Alert)
**文件路径**: `neoMaster/internal/model/alert.go`

```go
// Alert 告警模型
type Alert struct {
    ID          uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    RuleID      uint      `gorm:"index;not null" json:"rule_id"`               // 规则ID
    Title       string    `gorm:"size:500;not null" json:"title"`             // 告警标题
    Content     string    `gorm:"type:text;not null" json:"content"`           // 告警内容
    Severity    string    `gorm:"size:20;not null" json:"severity"`            // 告警级别
    Status      int       `gorm:"default:1" json:"status"`                     // 状态：1-未处理，2-处理中，3-已处理，4-已忽略
    Source      string    `gorm:"size:100" json:"source"`                      // 告警来源
    SourceID    string    `gorm:"size:100" json:"source_id"`                   // 来源ID
    Data        string    `gorm:"type:text" json:"data"`                       // 告警数据(JSON格式)
    ProcessedBy *uint     `gorm:"index" json:"processed_by"`                   // 处理人ID
    ProcessedAt *time.Time `json:"processed_at"`                               // 处理时间
    CreatedAt   time.Time `json:"created_at"`
    UpdatedAt   time.Time `json:"updated_at"`
    
    // 关联关系
    Rule        MonitorRule `gorm:"foreignKey:RuleID" json:"rule"`             // 关联规则
    Processor   *User       `gorm:"foreignKey:ProcessedBy" json:"processor"`    // 处理人
}
```

### 2.8 系统管理模型

#### 2.8.1 系统配置模型 (SystemConfig)
**文件路径**: `neoMaster/internal/model/system_config.go`

```go
// SystemConfig 系统配置模型
type SystemConfig struct {
    ID          uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    Category    string    `gorm:"size:50;not null" json:"category"`            // 配置分类
    ConfigKey   string    `gorm:"size:100;not null" json:"config_key"`         // 配置键
    ConfigValue string    `gorm:"type:text" json:"config_value"`               // 配置值
    DataType    string    `gorm:"size:20;default:'string'" json:"data_type"`   // 数据类型
    Description string    `gorm:"size:255" json:"description"`                 // 配置描述
    IsEncrypted bool      `gorm:"default:false" json:"is_encrypted"`           // 是否加密
    IsReadonly  bool      `gorm:"default:false" json:"is_readonly"`            // 是否只读
    UpdatedBy   uint      `gorm:"index" json:"updated_by"`                     // 更新者ID
    CreatedAt   time.Time `json:"created_at"`
    UpdatedAt   time.Time `json:"updated_at"`
    
    // 关联关系
    Updater     User      `gorm:"foreignKey:UpdatedBy" json:"updater"`         // 更新者
}
```

#### 2.8.2 审计日志模型 (AuditLog)
**文件路径**: `neoMaster/internal/model/audit_log.go`

```go
// AuditLog 审计日志模型
type AuditLog struct {
    ID          uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    UserID      *uint     `gorm:"index" json:"user_id"`                        // 用户ID
    Action      string    `gorm:"size:100;not null" json:"action"`             // 操作动作
    Resource    string    `gorm:"size:100;not null" json:"resource"`           // 操作资源
    ResourceID  string    `gorm:"size:100" json:"resource_id"`                 // 资源ID
    Method      string    `gorm:"size:10" json:"method"`                       // 请求方法
    Path        string    `gorm:"size:500" json:"path"`                        // 请求路径
    IPAddress   string    `gorm:"size:45" json:"ip_address"`                   // IP地址
    UserAgent   string    `gorm:"size:500" json:"user_agent"`                  // 用户代理
    RequestData string    `gorm:"type:text" json:"request_data"`               // 请求数据
    ResponseCode int      `json:"response_code"`                               // 响应码
    ErrorMsg    string    `gorm:"type:text" json:"error_msg"`                  // 错误信息
    Duration    int64     `json:"duration"`                                    // 执行时长(毫秒)
    CreatedAt   time.Time `json:"created_at"`
    
    // 关联关系
    User        *User     `gorm:"foreignKey:UserID" json:"user"`              // 关联用户
}
```

## 3. Agent节点数据模型

### 3.1 本地任务模型

#### 3.1.1 Agent任务模型 (AgentTask)
**文件路径**: `neoAgent/internal/model/task.go`

```go
// AgentTask Agent本地任务模型
type AgentTask struct {
    ID          string    `gorm:"primaryKey;size:36" json:"id"`                // 任务ID(UUID)
    MasterTaskID uint     `gorm:"index" json:"master_task_id"`                 // Master任务ID
    Name        string    `gorm:"size:200;not null" json:"name"`               // 任务名称
    Type        string    `gorm:"size:50;not null" json:"type"`                // 任务类型
    Priority    int       `gorm:"default:5" json:"priority"`                   // 优先级
    Status      int       `gorm:"default:0" json:"status"`                     // 状态：0-待执行，1-执行中，2-已完成，3-失败，4-已取消
    Progress    float64   `gorm:"default:0" json:"progress"`                   // 执行进度
    Config      string    `gorm:"type:text;not null" json:"config"`            // 任务配置(JSON格式)
    StartedAt   *time.Time `json:"started_at"`                                 // 开始时间
    CompletedAt *time.Time `json:"completed_at"`                               // 完成时间
    CreatedAt   time.Time `json:"created_at"`
    UpdatedAt   time.Time `json:"updated_at"`
    
    // 关联关系
    Results     []AgentTaskResult `gorm:"foreignKey:TaskID" json:"results"`       // 任务结果
}
```

#### 3.1.2 Agent任务结果模型 (AgentTaskResult)
**文件路径**: `neoAgent/internal/model/result.go`

```go
// AgentTaskResult Agent任务结果模型
type AgentTaskResult struct {
    ID          uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    TaskID      string    `gorm:"index;not null" json:"task_id"`               // 任务ID
    Target      string    `gorm:"size:255;not null" json:"target"`             // 扫描目标
    ResultType  string    `gorm:"size:50;not null" json:"result_type"`         // 结果类型
    Status      string    `gorm:"size:20;not null" json:"status"`              // 结果状态
    Data        string    `gorm:"type:longtext" json:"data"`                   // 结果数据(JSON格式)
    RawOutput   string    `gorm:"type:longtext" json:"raw_output"`             // 原始输出
    ErrorMsg    string    `gorm:"type:text" json:"error_msg"`                  // 错误信息
    Synced      bool      `gorm:"default:false" json:"synced"`                // 是否已同步到Master
    CreatedAt   time.Time `json:"created_at"`
    
    // 关联关系
    Task        AgentTask `gorm:"foreignKey:TaskID" json:"task"`               // 关联任务
}
```

### 3.2 Agent配置模型

#### 3.2.1 Agent本地配置模型 (AgentLocalConfig)
**文件路径**: `neoAgent/internal/model/config.go`

```go
// AgentLocalConfig Agent本地配置模型
type AgentLocalConfig struct {
    ID          uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    ConfigKey   string    `gorm:"uniqueIndex;size:100;not null" json:"config_key"` // 配置键
    ConfigValue string    `gorm:"type:text" json:"config_value"`               // 配置值
    DataType    string    `gorm:"size:20;default:'string'" json:"data_type"`   // 数据类型
    Source      string    `gorm:"size:20;default:'local'" json:"source"`       // 配置来源：local, master
    Version     int       `gorm:"default:1" json:"version"`                    // 配置版本
    IsEncrypted bool      `gorm:"default:false" json:"is_encrypted"`           // 是否加密
    Description string    `gorm:"size:255" json:"description"`                 // 配置描述
    CreatedAt   time.Time `json:"created_at"`
    UpdatedAt   time.Time `json:"updated_at"`
}
```

### 3.3 Agent插件模型

#### 3.3.1 Agent插件模型 (AgentPlugin)
**文件路径**: `neoAgent/internal/model/plugin.go`

```go
// AgentPlugin Agent插件模型
type AgentPlugin struct {
    ID          uint      `gorm:"primaryKey;autoIncrement" json:"id"`
    Name        string    `gorm:"uniqueIndex;size:100;not null" json:"name"`  // 插件名称
    Version     string    `gorm:"size:20;not null" json:"version"`            // 插件版本
    Type        string    `gorm:"size:50;not null" json:"type"`               // 插件类型
    FilePath    string    `gorm:"size:500;not null" json:"file_path"`         // 文件路径
    FileHash    string    `gorm:"size:64" json:"file_hash"`                   // 文件哈希
    Config      string    `gorm:"type:text" json:"config"`                    // 插件配置
    Status      int       `gorm:"default:1" json:"status"`                    // 状态：1-启用，0-禁用，2-错误
    LastUsed    *time.Time `json:"last_used"`                                 // 最后使用时间
    UsageCount  int       `gorm:"default:0" json:"usage_count"`              // 使用次数
    ErrorMsg    string    `gorm:"type:text" json:"error_msg"`                 // 错误信息
    CreatedAt   time.Time `json:"created_at"`
    UpdatedAt   time.Time `json:"updated_at"`
}
```

## 4. 共享通信模型

### 4.1 gRPC通信模型

#### 4.1.1 gRPC消息模型
**文件路径**: `neoMaster/internal/grpc/proto/agent.proto` 和 `neoAgent/internal/grpc/proto/agent.proto`

```protobuf
// Agent注册请求
message RegisterRequest {
    string name = 1;
    string hostname = 2;
    string ip_address = 3;
    int32 port = 4;
    string version = 5;
    string os = 6;
    string architecture = 7;
    string region = 8;
    map<string, string> tags = 9;
}

// Agent注册响应
message RegisterResponse {
    bool success = 1;
    string message = 2;
    string agent_id = 3;
    string token = 4;
}

// 心跳请求
message HeartbeatRequest {
    string agent_id = 1;
    AgentMetrics metrics = 2;
    repeated TaskStatus task_status = 3;
}

// 心跳响应
message HeartbeatResponse {
    bool success = 1;
    repeated TaskCommand commands = 2;
    repeated ConfigUpdate config_updates = 3;
}

// 任务分发请求
message TaskDispatchRequest {
    string task_id = 1;
    string task_name = 2;
    string task_type = 3;
    int32 priority = 4;
    string config = 5; // JSON格式的任务配置
}

// 任务执行结果
message TaskResultReport {
    string task_id = 1;
    string status = 2;
    float progress = 3;
    repeated TaskResult results = 4;
    string error_message = 5;
}
```

### 4.2 消息队列模型

#### 4.2.1 RabbitMQ消息模型
**文件路径**: `neoMaster/internal/repository/rabbitmq/message.go`

```go
// QueueMessage 队列消息模型
type QueueMessage struct {
    ID          string                 `json:"id"`           // 消息ID
    Type        string                 `json:"type"`         // 消息类型
    Source      string                 `json:"source"`       // 消息来源
    Target      string                 `json:"target"`       // 消息目标
    Priority    int                    `json:"priority"`     // 消息优先级
    Data        map[string]interface{} `json:"data"`         // 消息数据
    Timestamp   time.Time              `json:"timestamp"`    // 时间戳
    Retry       int                    `json:"retry"`        // 重试次数
    MaxRetry    int                    `json:"max_retry"`    // 最大重试次数
}

// TaskMessage 任务消息模型
type TaskMessage struct {
    TaskID      string                 `json:"task_id"`      // 任务ID
    AgentID     string                 `json:"agent_id"`     // Agent ID
    Action      string                 `json:"action"`       // 操作类型：create, update, cancel
    Config      map[string]interface{} `json:"config"`       // 任务配置
    Timestamp   time.Time              `json:"timestamp"`    // 时间戳
}

// ResultMessage 结果消息模型
type ResultMessage struct {
    TaskID      string                 `json:"task_id"`      // 任务ID
    AgentID     string                 `json:"agent_id"`     // Agent ID
    Status      string                 `json:"status"`       // 任务状态
    Progress    float64                `json:"progress"`     // 执行进度
    Results     []interface{}          `json:"results"`      // 结果数据
    Error       string                 `json:"error"`        // 错误信息
    Timestamp   time.Time              `json:"timestamp"`    // 时间戳
}
```

### 4.3 WebSocket模型

#### 4.3.1 WebSocket消息模型
**文件路径**: `neoMaster/internal/websocket/message.go`

```go
// WSMessage WebSocket消息模型
type WSMessage struct {
    Type      string      `json:"type"`       // 消息类型
    Channel   string      `json:"channel"`    // 频道
    Data      interface{} `json:"data"`       // 消息数据
    Timestamp time.Time   `json:"timestamp"`  // 时间戳
    RequestID string      `json:"request_id"` // 请求ID
}

// WSClient WebSocket客户端模型
type WSClient struct {
    ID       string          `json:"id"`        // 客户端ID
    UserID   uint            `json:"user_id"`   // 用户ID
    Conn     *websocket.Conn `json:"-"`         // WebSocket连接
    Send     chan WSMessage  `json:"-"`         // 发送通道
    Channels []string        `json:"channels"`  // 订阅频道
    LastPing time.Time       `json:"last_ping"` // 最后ping时间
}
```

## 5. 数据库设计

### 5.1 MySQL数据库设计

#### 5.1.1 数据库配置
**文件路径**: `neoMaster/configs/database.yaml`

```yaml
mysql:
  host: localhost
  port: 3306
  database: neoscan
  username: neoscan
  password: "${MYSQL_PASSWORD}"
  charset: utf8mb4
  collation: utf8mb4_unicode_ci
  max_idle_conns: 10
  max_open_conns: 100
  conn_max_lifetime: 3600
  log_level: warn
  slow_threshold: 200ms
```

#### 5.1.2 数据库迁移
**文件路径**: `neoMaster/cmd/migrate/main.go`

```go
// 数据库迁移主函数
func main() {
    // 自动迁移所有模型
    db.AutoMigrate(
        &model.User{},
        &model.Role{},
        &model.Permission{},
        &model.Session{},
        &model.Agent{},
        &model.AgentMetrics{},
        &model.AgentConfig{},
        &model.Task{},
        &model.TaskConfig{},
        &model.TaskResult{},
        &model.Asset{},
        &model.Service{},
        &model.Vulnerability{},
        &model.POC{},
        &model.Plugin{},
        &model.PluginInstallation{},
        &model.MonitorRule{},
        &model.Alert{},
        &model.SystemConfig{},
        &model.AuditLog{},
    )
}
```

### 5.2 Redis缓存设计

#### 5.2.1 缓存键设计
**文件路径**: `neoMaster/internal/repository/redis/keys.go`

```go
// Redis键名常量
const (
    // 会话缓存
    SessionPrefix     = "session:"
    UserSessionPrefix = "user_session:"
    
    // Agent状态缓存
    AgentStatusPrefix   = "agent_status:"
    AgentMetricsPrefix  = "agent_metrics:"
    
    // 任务队列缓存
    TaskQueuePrefix     = "task_queue:"
    TaskStatusPrefix    = "task_status:"
    
    // 配置缓存
    SystemConfigPrefix  = "system_config:"
    AgentConfigPrefix   = "agent_config:"
    
    // 统计缓存
    StatsPrefix         = "stats:"
    DashboardPrefix     = "dashboard:"
)
```

### 5.3 SQLite本地存储设计

#### 5.3.1 Agent本地数据库
**文件路径**: `neoAgent/configs/database.yaml`

```yaml
sqlite:
  database: "./storage/agent.db"
  max_idle_conns: 5
  max_open_conns: 10
  conn_max_lifetime: 3600
  log_level: warn
  pragma:
    journal_mode: WAL
    synchronous: NORMAL
    cache_size: 1000
    foreign_keys: true
```

## 6. 模型关系图

### 6.1 Master节点模型关系

```
User ──┬── Session
       ├── Role ── Permission
       ├── Task
       ├── MonitorRule
       ├── Alert (处理人)
       ├── SystemConfig (更新者)
       └── AuditLog

Agent ──┬── Task
        ├── AgentMetrics
        ├── AgentConfig
        └── PluginInstallation

Task ──┬── TaskConfig
       ├── TaskResult ── Vulnerability
       └── Asset

Asset ──┬── Service
        ├── Vulnerability
        └── Task

Vulnerability ── POC

Plugin ── PluginInstallation

MonitorRule ── Alert
```

### 6.2 Agent节点模型关系

```
AgentTask ── AgentTaskResult

AgentLocalConfig (独立)

AgentPlugin (独立)
```

## 7. 总结

本数据模型设计涵盖了NeoScan系统的所有核心功能模块，包括：

1. **Master节点模型**：完整的用户管理、Agent管理、任务管理、资产管理、漏洞管理、插件管理、监控预警和系统管理模型
2. **Agent节点模型**：轻量化的本地任务、配置和插件管理模型
3. **通信模型**：支持gRPC、消息队列和WebSocket的通信协议模型
4. **存储设计**：MySQL主存储、Redis缓存和SQLite本地存储的完整方案

所有模型都标明了在目录结构中的对应路径，便于开发时的代码组织和维护。模型设计遵循了分层架构原则，支持系统的高性能、高可用和可扩展性要求。