# NeoScan 产品需求文档 v2.0 (Master集群化版本)

## 1. 项目概述

### 1.1 系统名称
NeoScan - 综合性自动扫描信息收集系统

### 1.2 系统定位
综合性自动扫描信息收集系统，提供以下核心功能：
- 自动资产扫描（系统识别、指纹识别、中间件识别、SMC识别等）
- 自动POC扫描和验证
- 代理扫描验证
- 认证扫描验证（弱口令扫描）
- 漏洞监控预警
- 病毒查杀

### 1.3 系统架构
采用分布式架构设计：
- **Master控制节点集群**：支持多Master节点部署，负责任务调度、结果汇总、数据存储、前端管理，通过集群模式实现高可用和负载分担
- **Agent工作节点**：负责具体扫描任务执行
- **分布式协调服务**：基于etcd实现Master节点间的服务发现、配置同步和分布式锁
- **数据层集群**：
  - MySQL主从集群（读写分离，主库写入，从库读取）
  - Redis集群（分片存储，哨兵模式高可用）
  - RabbitMQ集群（消息队列高可用，镜像队列）

#### 1.3.1 Master集群架构设计
- **Active-Active模式**：多个Master节点同时提供服务，通过负载均衡器分发请求
- **服务分离**：
  - API Gateway层：统一入口，请求路由和负载均衡
  - 任务调度服务：分布式任务调度，避免重复调度
  - 数据处理服务：扫描结果处理和存储
  - 配置管理服务：Agent配置分发和管理
- **数据一致性**：通过etcd实现分布式锁和配置同步
- **故障恢复**：Master节点故障时，其他节点自动接管服务

### 1.4 技术栈
- **后端开发语言**：Go语言
- **Web框架**：Gin框架
- **前端技术**：Vue.js 3 + Element Plus（临时方案）【cool-admin 和 go_admin】
- **通信方式**：RESTful API + gRPC
- **消息队列**：RabbitMQ（用于Agent节点扫描结果回传Master）
- **实时通信**：WebSockets（Master通知Agent配置更新）
- **数据库**：MySQL（主数据库）
- **缓存系统**：Redis（高性能缓存和会话管理）
- **安全认证**：JWT + RBAC（基于角色的访问控制）
- **容器化部署**：Docker + Kubernetes
- **服务发现**：Kubernetes原生服务发现 + etcd分布式协调
- **负载均衡**：Kubernetes Ingress + Service + Master集群内部负载均衡
- **分布式协调**：etcd（Master节点选举、配置同步、分布式锁）
- **API网关**：Kong/Traefik（请求路由、负载均衡、限流）
- **数据库集群**：MySQL主从复制 + 读写分离
- **消息队列集群**：RabbitMQ集群模式 + 镜像队列

## 2. 功能需求

### 2.1 Master节点功能需求

#### 2.1.1 核心管理功能
- **任务管理**：创建、调度、监控扫描任务
- **节点管理**：Agent节点注册、状态监控、配置下发
- **Agent负载监控**：实时监控各Agent节点的扫描任务执行状态、资源使用情况
- **任务队列管理**：管理待分发的扫描任务队列，支持任务优先级设置
- **负载均衡策略**：根据Agent节点负载情况智能分发扫描任务
- **结果管理**：扫描结果汇总、分析、存储
- **用户管理**：用户认证、权限控制、角色管理
- **远程配置管理**：实时推送配置更新到指定Agent节点
- **智能任务调度**：基于Agent负载状态的智能任务分发和负载均衡
- **Master集群管理**：支持多Master节点集群部署，实现高可用和负载分担
- **分布式任务调度**：Master节点间的任务分发协调和状态同步
- **故障转移机制**：Master节点故障时的自动切换和服务迁移

#### 2.1.2 资产管理模块
- **资产同步**：支持从外部系统同步资产数据
- **资产清单**：维护完整的资产清单信息
- **数据传输**：支持扫描结果向外部系统传输

#### 2.1.3 监控预警模块
- **漏洞监控任务管理**
  - 任务名称配置
  - 关键字设置（如CVE、RCE等）
  - 任务创建日期记录
  - 备注信息管理
- **漏洞预警列表**
  - 监控来源（GitHub等）
  - 作者信息
  - 对应监控任务
  - 项目名称和地址
  - 更新状态跟踪
  - 监控日期记录

#### 2.1.4 通知模块
- **多渠道通知支持**
  - 蓝信通知
  - SEC通知
  - 邮件通知
  - 其他自定义通知方式

#### 2.1.5 模块管理系统
- **核心功能模块**：管理scan扫描模块、virusKill病毒查杀模块、grpc通信模块等核心功能模块
- **插件扩展模块**：管理plugins模块中的扩展功能插件，支持热加载
- **模块配置管理**：统一管理各功能模块的配置参数
- **远程模块控制**：通过Master后台远程启用/禁用Agent节点的功能模块和扩展插件
- **模块状态监控**：实时监控各Agent节点功能模块和插件的运行状态
- **扫描任务状态监控**：实时监控各Agent节点当前执行的扫描任务状态
  - **任务执行状态**：空闲、执行中、暂停、错误等状态
  - **任务进度跟踪**：当前扫描任务的完成进度和预计剩余时间
  - **资源占用监控**：CPU、内存、网络带宽等资源使用情况
  - **任务历史记录**：Agent节点的任务执行历史和性能统计

#### 2.1.6 插件远程控制系统
- **插件定义**：插件是指小型功能扩展组件，用于实现特定的辅助功能需求
- **插件类型**：
  - **shell-plugin**：在Agent主机上执行Linux命令并返回结果给Master
  - **file-plugin**：文件操作插件，支持文件上传、下载、管理等功能
  - **monitor-plugin**：系统监控插件，收集Agent主机的系统资源信息
  - **custom-plugin**：用户自定义插件，支持第三方功能扩展
- **远程插件管理**：
  - **插件安装**：Master可远程向Agent推送并安装新插件
  - **插件启停**：Master可远程启用/禁用指定Agent的特定插件
  - **插件配置**：Master可远程修改插件的运行参数和配置
  - **插件更新**：支持插件的远程更新和版本管理
- **插件执行控制**：
  - **命令下发**：Master通过插件向Agent下发执行指令
  - **结果回传**：Agent执行插件功能后将结果返回给Master
  - **权限控制**：基于角色的插件使用权限管理
  - **安全审计**：记录所有插件操作的审计日志

#### 2.1.7 日志系统
- **访问日志**：记录用户访问行为
- **运行日志**：记录系统运行状态
- **操作日志**：记录用户操作行为
- **错误日志**：记录系统异常信息

### 2.2 Agent节点功能需求

Agent节点基于modules架构设计，包含以下核心功能模块：

#### 2.2.1 scan扫描模块 - 资产扫描功能
- **IP存活探测**：从资产清单中获取存活IP
- **全端口扫描**：扫描存活IP的开放端口
- **服务识别**：识别端口对应的服务信息
- **操作系统识别**：识别目标系统类型和版本
- **集成扫描工具**
  - Nmap：网络发现和安全审计
  - Masscan：高速端口扫描
  - Nuclei：漏洞扫描
  - Xray：安全评估
  - Fscan：内网综合扫描

#### 2.2.2 scan扫描模块 - Web扫描功能
- **网站信息识别**：识别Web应用技术栈
- **网页爬取分析**：深度爬取网站内容
- **CMS识别**：识别内容管理系统类型和版本
- **集成工具**：ChromeDriver用于动态页面分析
- **网页信息爬取能力(补充)**：
  - **爬虫方式**：通过传统爬虫技术爬取指定网页信息
    - **页面标题（Title）**：提取网页标题信息，用于网站指纹识别
    - **服务横幅（Banner）**：获取服务器响应头信息，识别Web服务器类型和版本
    - **页面内容**：爬取关键页面内容，包括meta标签、关键字、描述信息
    - **技术栈识别**：通过页面源码分析识别使用的前端框架、JavaScript库等
  - **ChromeDriver模拟访问**：通过浏览器自动化获取动态页面信息
    - **动态内容渲染**：执行JavaScript后获取完整页面内容
    - **页面截图**：生成页面截图用于可视化分析
    - **DOM结构分析**：分析页面DOM结构，识别特定组件和框架
    - **网络请求监控**：监控页面加载过程中的网络请求，发现隐藏接口
  - **指纹识别支持**：
    - **HTTP响应头分析**：分析Server、X-Powered-By等响应头信息
    - **页面特征匹配**：基于页面特征库进行CMS和框架识别
    - **文件路径探测**：探测特定文件路径以确认技术栈
    - **错误页面分析**：通过错误页面信息识别后端技术
  - **爬取策略配置**：
    - **深度控制**：设置爬取深度和页面数量限制
    - **速率限制**：配置请求频率，避免对目标站点造成压力
    - **User-Agent轮换**：支持多种User-Agent模拟不同浏览器
    - **代理支持**：支持通过代理进行爬取，提高隐蔽性

#### 2.2.3 scan扫描模块 - POC漏洞扫描功能
- **POC验证**：自动化漏洞概念验证
- **漏洞检测**：基于规则的漏洞发现
- **自定义POC**：支持用户自定义POC脚本

#### 2.2.4 scan扫描模块 - 目录扫描功能
- **目录爆破**：发现隐藏目录和文件
- **敏感文件检测**：识别敏感信息泄露

#### 2.2.5 scan扫描模块 - 域名扫描功能
- **子域名发现**：枚举目标域名的子域名
- **域名解析**：获取域名对应的IP地址

#### 2.2.6 scan扫描模块 - 弱口令扫描功能
- **服务爆破**：针对常见服务进行弱口令检测
- **字典管理**：支持自定义密码字典

#### 2.2.7 scan扫描模块 - 代理扫描功能
- **代理发现**：发现网络中的代理服务
- **代理验证**：验证代理服务的可用性

#### 2.2.8 virusKill病毒查杀模块
- **病毒检测**：基于YARA规则的恶意软件检测
- **规则管理**：支持自定义检测规则

#### 2.2.9 core核心模块
- **基础服务**：提供Agent节点的基础运行框架
- **API接口**：提供RESTful API服务
- **数据库管理**：本地数据存储和管理
- **配置管理**：Agent节点配置参数管理

#### 2.2.10 grpc通信模块
- **Master通信**：与Master节点的gRPC通信
- **认证服务**：Agent节点身份认证
- **数据传输**：高效的数据传输服务

#### 2.2.11 logs日志模块
- **日志收集**：收集各功能模块的运行日志
- **结果上报**：通过消息队列向Master上报扫描结果
- **日志管理**：本地日志文件管理和轮转

#### 2.2.12 plugins扩展插件模块
- **插件管理**：管理第三方扩展插件和小型功能扩展组件
- **热加载**：支持插件的动态加载和卸载
- **插件接口**：提供标准的插件开发接口
- **内置插件**：
  - **shell-plugin**：执行Linux系统命令
    - 支持常用Linux命令执行（ls、ps、netstat、df等）
    - 命令执行结果实时返回Master
    - 支持命令执行超时控制和权限限制
  - **file-plugin**：文件操作功能
    - 文件上传/下载
    - 文件/目录创建、删除、移动
    - 文件内容查看和编辑
  - **monitor-plugin**：系统监控功能
    - CPU、内存、磁盘使用率监控
    - 网络连接状态监控
    - 进程状态监控
- **插件安全机制**：
  - **权限控制**：插件执行权限严格控制，防止恶意操作
  - **沙箱执行**：插件在受限环境中执行，保护系统安全
  - **操作审计**：记录所有插件操作日志，支持安全审计

#### 2.2.13 runner运行调度模块
- **任务调度**：统一调度各功能模块的执行
- **计划任务**：支持crontab定时任务
- **执行顺序**：管理模块间的执行顺序和依赖关系

## 3. 非功能性需求

### 3.1 性能需求

#### 3.1.1 Master集群性能指标
- **并发处理能力**：单Master节点支持1000+并发扫描任务，集群模式支持10000+并发任务
- **响应时间**：Web界面响应时间<2秒，API响应时间<500ms
- **吞吐量**：单Master节点支持10000+目标/小时，集群模式支持100000+目标/小时
- **资源利用率**：CPU利用率<80%，内存利用率<85%
- **扩展能力**：支持水平扩展，Master节点数量可根据负载动态调整

#### 3.1.2 Agent节点性能指标
- **并发处理**：支持多个Agent节点同时工作
- **扫描效率**：单个Agent节点支持大规模IP段扫描
- **任务处理**：支持每小时处理万级别的扫描任务

#### 3.1.3 数据库性能优化
- **读写分离**：写操作路由到主库，读操作分发到从库
- **连接池管理**：每个Master节点维护独立的数据库连接池
- **查询优化**：索引优化、分页查询、慢查询监控
- **数据分片**：大表按时间或业务维度进行分片存储

#### 3.1.4 缓存性能优化
- **Redis集群**：数据分片存储，支持水平扩展
- **缓存策略**：热点数据缓存、查询结果缓存、会话缓存
- **缓存一致性**：主动失效 + 被动更新策略
- **缓存预热**：系统启动时预加载常用数据

#### 3.1.5 消息队列性能优化
- **RabbitMQ集群**：镜像队列确保高可用，分片队列提升性能
- **消息持久化**：关键消息持久化存储，临时消息内存处理
- **消费者扩展**：根据队列长度动态调整消费者数量
- **死信队列**：处理失败消息的重试和告警机制

### 3.2 可靠性需求
- **系统可用性**：99.9%的系统可用性
- **故障恢复**：支持Agent节点故障自动恢复
- **数据完整性**：确保扫描结果数据不丢失

### 3.3 安全需求
- **身份认证**：基于JWT令牌的身份认证机制
  - 支持用户名密码登录
  - JWT令牌自动刷新机制
  - 支持单点登录（SSO）扩展
  - 多因素认证（MFA）支持
- **权限控制**：基于RBAC的细粒度权限控制
  - 角色定义：超级管理员、系统管理员、安全分析师、只读用户
  - 功能权限：扫描任务管理、Agent节点管理、系统配置、报告查看
  - 数据权限：按组织架构或业务域划分数据访问权限
  - API权限：RESTful API接口级别的权限控制
- **数据加密**：敏感数据传输和存储加密
  - TLS 1.3加密传输（HTTPS、gRPC、WebSocket）
  - 数据库敏感字段AES-256加密存储
  - Redis缓存数据加密存储
  - 配置文件敏感信息加密
- **审计日志**：完整的操作审计记录
  - 用户登录登出记录
  - 关键操作审计（任务创建、配置修改、权限变更）
  - API调用审计
  - 系统异常和安全事件记录

### 3.4 可扩展性需求

#### 3.4.1 Master集群扩展
- **水平扩展**：支持Master节点的动态增减，无需停机
- **自动扩缩容**：基于CPU、内存、请求量等指标自动调整Master节点数量
- **服务发现**：新增Master节点自动注册到etcd，自动加入集群
- **负载重分配**：节点变化时自动重新分配负载和任务

#### 3.4.2 Agent节点扩展
- **动态注册**：Agent节点支持动态注册和注销
- **负载均衡**：智能任务分发，避免单点过载
- **地域分布**：支持跨地域Agent部署，就近任务分配

#### 3.4.3 数据层扩展
- **数据库扩展**：支持MySQL读从库的动态增减
- **缓存扩展**：Redis集群支持节点动态扩容
- **消息队列扩展**：RabbitMQ集群支持节点动态增减

#### 3.4.4 功能模块扩展
- **模块热插拔**：支持新扫描模块的热插拔，无需重启服务
- **插件系统**：标准化插件接口，支持第三方插件开发
- **API扩展**：提供丰富的RESTful和gRPC API接口
- **微服务架构**：各功能模块独立部署，支持独立扩展

### 3.5 易用性需求
- **用户界面**：直观友好的Web管理界面
- **配置管理**：简化的配置管理流程
- **文档支持**：完整的用户手册和API文档

## 4. 系统接口需求

### 4.1 内部接口
- **Master-Agent通信**：基于gRPC的高效通信
- **消息队列接口**：RabbitMQ消息处理接口
- **WebSocket接口**：实时配置更新接口
- **配置推送接口**：Master向Agent推送配置变更的专用接口
- **模块控制接口**：远程控制Agent功能模块和扩展插件启停的gRPC接口
- **任务调度接口**：
  - **任务分发接口**：Master向Agent下发扫描任务的gRPC接口
  - **状态上报接口**：Agent向Master上报任务执行状态和资源使用情况的接口
  - **负载查询接口**：Master查询Agent节点当前负载状态的接口
  - **任务控制接口**：Master对Agent执行中的任务进行暂停、恢复、取消等控制的接口

### 4.2 外部接口
- **RESTful API**：对外提供标准REST接口
- **数据导入接口**：支持资产数据批量导入
- **数据导出接口**：支持扫描结果数据导出
- **第三方集成接口**：支持与其他安全工具集成

## 5. Agent远程配置更新实现方案

### 5.1 功能概述
Agent远程配置更新功能允许Master节点通过Web管理界面实时修改指定Agent节点的配置参数，包括功能模块的启用/禁用、扫描策略调整、工具配置更新等，无需重启Agent服务即可生效。支持对scan扫描模块、virusKill病毒查杀模块、plugins扩展模块等的远程管理。

同时支持远程插件控制功能，Master可以远程启用/禁用Agent节点的各种功能插件（如shell-plugin、file-plugin、monitor-plugin等），并可以通过插件向Agent下发执行指令，实现灵活的远程管理和控制。

**智能任务调度功能**：Master通过实时监控各Agent节点的扫描任务执行状态和资源使用情况，实现智能的任务分发和负载均衡。当需要下发新的扫描任务时，Master会自动选择当前空闲或负载较低的Agent节点，避免向正在执行扫描任务的Agent节点分发新任务，确保系统资源的合理利用和扫描效率的最大化。

### 5.2 技术架构

#### 5.2.1 通信方式
- **主要通信**：WebSocket长连接（实时性要求高的配置更新）
- **备用通信**：gRPC调用（WebSocket连接异常时的备用方案）
- **状态同步**：定期心跳机制确保配置同步状态

#### 5.2.2 配置存储
- **Master端**：数据库存储所有Agent配置信息
- **Agent端**：本地配置文件 + 内存缓存
- **配置版本**：每次配置变更生成版本号，支持配置回滚

### 5.3 实现流程

#### 5.3.1 配置更新流程
1. **用户操作**：管理员在Master Web界面修改Agent配置
2. **配置验证**：Master验证配置参数的合法性和兼容性
3. **数据库更新**：Master将新配置保存到数据库并生成版本号
4. **实时推送**：通过WebSocket向目标Agent推送配置更新消息
5. **Agent接收**：Agent接收配置更新消息并验证消息完整性
6. **配置应用**：Agent更新本地配置文件和内存配置
7. **状态反馈**：Agent向Master反馈配置更新结果
8. **界面更新**：Master Web界面实时显示配置更新状态

#### 5.3.2 模块控制流程
1. **模块状态查询**：Master查询Agent当前功能模块和扩展插件运行状态
2. **操作指令下发**：发送模块/插件启用/禁用指令到Agent
3. **模块操作执行**：Agent执行功能模块或扩展插件的加载/卸载操作
4. **状态同步**：Agent上报模块状态变更结果
5. **监控更新**：Master更新模块状态监控面板

#### 5.3.3 智能任务调度流程
1. **任务创建**：用户在Master Web界面创建新的扫描任务（如网段扫描）
2. **Agent状态检查**：Master查询所有在线Agent节点的当前任务执行状态
3. **负载评估**：评估各Agent节点的负载情况（CPU、内存、当前任务数量等）
4. **最优选择**：根据负载均衡算法选择最适合的Agent节点
   - **空闲优先**：优先选择当前无任务执行的Agent节点
   - **负载均衡**：在多个空闲Agent中选择资源使用率最低的节点
   - **地理位置**：考虑Agent节点与目标网段的网络距离
5. **任务分发**：向选定的Agent节点下发扫描任务
6. **状态跟踪**：实时跟踪任务执行状态和进度
7. **动态调整**：根据任务执行情况动态调整后续任务分发策略

### 5.4 配置项分类

#### 5.4.1 模块配置
- **功能模块开关**：启用/禁用scan扫描模块、virusKill病毒查杀模块等核心功能模块
- **扩展插件开关**：启用/禁用plugins模块中的特定扩展插件
- **模块参数**：调整模块运行参数（如扫描线程数、超时时间、资源限制等）
- **模块优先级**：设置功能模块执行优先级
- **模块依赖**：管理功能模块和扩展插件间的依赖关系

#### 5.4.2 插件配置
- **插件开关控制**：
  - **shell-plugin**：启用/禁用Linux命令执行功能
  - **file-plugin**：启用/禁用文件操作功能
  - **monitor-plugin**：启用/禁用系统监控功能
  - **custom-plugin**：启用/禁用用户自定义插件
- **插件参数配置**：
  - **执行权限**：设置插件可执行的命令范围和权限级别
  - **超时设置**：配置插件执行的超时时间
  - **资源限制**：限制插件使用的系统资源
  - **安全策略**：配置插件的安全执行策略
- **插件执行控制**：
  - **命令白名单**：设置允许执行的命令列表
  - **路径限制**：限制插件可访问的文件路径
  - **用户权限**：设置插件执行的用户权限级别

#### 5.4.3 扫描配置
- **扫描策略**：端口范围、扫描深度、扫描频率
- **工具配置**：nmap、nuclei等工具的参数配置
- **资源限制**：CPU、内存、网络带宽使用限制
- **时间窗口**：允许扫描的时间段设置

#### 5.4.4 系统配置
- **日志级别**：调整Agent日志输出级别
- **网络配置**：代理设置、DNS配置
- **安全配置**：认证参数、加密设置
- **性能配置**：并发数、缓存大小等

### 5.5 数据结构设计

#### 5.5.1 配置更新消息格式
```json
{
  "message_id": "uuid",
  "timestamp": "2024-01-01T00:00:00Z",
  "agent_id": "agent-001",
  "config_version": "v1.2.3",
  "operation_type": "update|rollback|query",
  "config_data": {
    "modules": {
       "scan": {
         "asset_scan": {
           "enabled": true,
           "config": {
             "threads": 10,
             "timeout": 30
           }
         },
         "poc_scan": {
           "enabled": true,
           "config": {
             "concurrent_tasks": 5
           }
         }
       },
       "virusKill": {
         "enabled": false
       },
       "plugins": {
         "shell-plugin": {
           "enabled": true,
           "config": {
             "timeout": 30,
             "allowed_commands": ["ls", "ps", "netstat", "df"],
             "user_privilege": "limited"
           }
         },
         "file-plugin": {
           "enabled": false
         },
         "monitor-plugin": {
           "enabled": true,
           "config": {
             "interval": 60,
             "metrics": ["cpu", "memory", "disk"]
           }
         }
       }
     },
    "scan_policy": {
      "port_range": "1-65535",
      "scan_rate": 1000
    }
  }
}
```

#### 5.5.2 状态反馈消息格式
```json
{
  "message_id": "uuid",
  "timestamp": "2024-01-01T00:00:00Z",
  "agent_id": "agent-001",
  "status": "success|failed|partial",
  "config_version": "v1.2.3",
  "error_message": "错误描述（如果有）",
  "applied_configs": ["modules.scan.asset_scan", "modules.virusKill", "scan_policy.port_range"]
}
```

#### 5.5.3 Agent任务状态上报消息格式
```json
{
  "message_id": "uuid",
  "timestamp": "2024-01-01T00:00:00Z",
  "agent_id": "agent-001",
  "agent_status": "idle|busy|error|offline",
  "current_tasks": [
    {
      "task_id": "task-001",
      "task_type": "asset_scan|web_scan|poc_scan|dir_scan|domain_scan|weakpwd_scan|proxy_scan|virus_scan",
      "task_status": "running|paused|completed|failed",
      "progress": 65,
      "start_time": "2024-01-01T10:00:00Z",
      "estimated_completion": "2024-01-01T12:30:00Z",
      "target_info": {
        "ip_range": "192.168.1.0/24",
        "port_range": "1-65535",
        "scan_type": "full_scan"
      }
    }
  ],
  "resource_usage": {
    "cpu_percent": 45.2,
    "memory_percent": 62.8,
    "disk_usage_percent": 23.1,
    "network_bandwidth_mbps": 15.6
  },
  "performance_metrics": {
    "tasks_completed_today": 12,
    "average_task_duration_minutes": 45,
    "success_rate_percent": 98.5
  }
}
```

### 5.6 异常处理机制

#### 5.6.1 网络异常处理
- **连接断开**：Agent自动重连并请求配置同步
- **消息丢失**：基于消息ID的重传机制
- **超时处理**：配置更新超时后自动回滚

#### 5.6.2 配置冲突处理
- **版本冲突**：基于时间戳的冲突解决策略
- **参数验证**：配置应用前的参数合法性检查
- **依赖检查**：插件依赖关系验证

#### 5.6.3 故障恢复
- **配置备份**：每次更新前自动备份当前配置
- **快速回滚**：支持一键回滚到上一个稳定版本
- **安全模式**：配置异常时自动进入安全运行模式

### 5.7 安全考虑

#### 5.7.1 权限控制
- **操作权限**：基于角色的配置修改权限控制
- **Agent认证**：确保只有合法Agent能接收配置更新
- **操作审计**：记录所有配置变更操作日志

#### 5.7.2 数据安全
- **传输加密**：WebSocket和gRPC通信使用TLS加密
- **配置加密**：敏感配置参数加密存储
- **签名验证**：配置消息数字签名防篡改

### 5.8 监控和告警

#### 5.8.1 配置状态监控
- **实时状态**：Agent配置同步状态实时监控
- **版本追踪**：各Agent配置版本统一管理
- **差异检测**：自动检测配置不一致情况

#### 5.8.2 任务调度监控
- **Agent负载监控**：实时监控各Agent节点的资源使用情况和任务执行状态
- **任务队列监控**：监控待分发任务队列的长度和优先级分布
- **调度效率监控**：统计任务分发的成功率和平均响应时间
- **负载均衡效果**：监控各Agent节点的任务分布均衡性
- **性能指标统计**：
  - **任务完成率**：各Agent节点的任务完成统计
  - **平均执行时间**：不同类型扫描任务的平均执行时间
  - **资源利用率**：系统整体资源利用率统计
  - **故障恢复时间**：Agent节点故障后的恢复时间统计

#### 5.8.3 告警机制
- **配置失败告警**：配置更新失败时及时告警
- **版本不一致告警**：Agent配置版本不一致告警
- **连接异常告警**：Agent连接异常时告警
- **任务调度告警**：
  - **Agent过载告警**：Agent节点资源使用率超过阈值时告警
  - **任务堆积告警**：任务队列长度超过设定阈值时告警
  - **任务失败告警**：扫描任务执行失败率超过阈值时告警
  - **负载不均告警**：Agent节点间负载分布严重不均时告警
  - **调度异常告警**：任务调度系统出现异常时告警

## 6. 数据需求

### 6.1 数据存储需求

#### 6.1.1 MySQL主数据库存储
- **资产数据**：IP地址、域名、端口、服务信息
- **扫描结果**：漏洞信息、风险等级、修复建议
- **用户数据**：用户信息、权限配置、操作记录
- **系统配置**：扫描策略、通知配置、插件配置
- **任务管理**：扫描任务定义、执行历史、调度记录
- **审计日志**：用户操作日志、系统事件日志

#### 6.1.2 Redis缓存存储
- **会话管理**：用户登录状态、JWT令牌缓存
- **Agent状态缓存**：Agent节点实时状态、负载信息
- **任务队列缓存**：待分发任务队列、任务优先级
- **配置缓存**：频繁访问的系统配置、Agent配置
- **实时数据缓存**：扫描进度、实时监控数据
- **分布式锁**：任务分发锁、配置更新锁
- **限流数据**：API调用频率限制、用户操作限流

#### 6.1.3 数据一致性要求
- **强一致性**：用户认证、权限数据、关键配置
- **最终一致性**：扫描结果、监控数据、日志信息
- **缓存同步策略**：
  - 写入MySQL后异步更新Redis缓存
  - 缓存失效时从MySQL重新加载
  - 关键数据变更时主动清理相关缓存

### 6.2 数据备份需求
- **定期备份**：支持自动化数据备份
- **增量备份**：支持增量备份策略
- **数据恢复**：支持快速数据恢复

## 7. 部署需求

### 7.1 系统环境
- **操作系统**：支持Linux、Windows、macOS
- **硬件要求**：
  - Master节点：4核CPU、8GB内存、100GB存储
  - Agent节点：2核CPU、4GB内存、50GB存储

### 7.2 网络需求
- **网络连通性**：Master与Agent节点网络互通
- **端口开放**：必要的服务端口开放
- **防火墙配置**：支持防火墙规则配置

### 7.3 依赖服务
- **数据库服务**：MySQL 8.0+
  - 支持InnoDB存储引擎
  - 启用binlog用于数据备份和恢复
  - 配置主从复制（生产环境）
- **消息队列服务**：RabbitMQ 3.8+
  - 支持集群模式部署
  - 启用消息持久化
  - 配置死信队列处理
- **缓存服务**：Redis 6.0+
  - 支持Redis Cluster集群模式
  - 启用AOF持久化
  - 配置内存淘汰策略
  - 支持Redis Sentinel高可用

### 7.4 Kubernetes部署需求
- **集群要求**：
  - Kubernetes版本：1.20+
  - 节点配置：至少3个Worker节点
  - 存储：支持动态存储卷（StorageClass）
  - 网络：支持CNI网络插件（如Calico、Flannel）
- **资源配置**：
  - **Master集群资源配置**：
    - **Master节点Pod（单节点）**：
      - CPU：2核（request）/ 4核（limit）
      - 内存：4GB（request）/ 8GB（limit）
      - 存储：50GB持久化存储
    - **Master集群最小配置**：3个Master节点（高可用）
    - **Master集群推荐配置**：5个Master节点（生产环境）
    - **自动扩缩容策略**：
      - 最小副本数：3
      - 最大副本数：10
      - CPU阈值：70%触发扩容，30%触发缩容
      - 内存阈值：80%触发扩容，40%触发缩容
  - **Agent节点Pod**：
    - CPU：1核（request）/ 2核（limit）
    - 内存：2GB（request）/ 4GB（limit）
    - 存储：20GB持久化存储
  - **MySQL Pod**：
    - 主库：CPU：2核（request）/ 4核（limit），内存：4GB（request）/ 8GB（limit），存储：100GB持久化存储（SSD推荐）
    - 从库：CPU：2核（request）/ 4核（limit），内存：4GB（request）/ 8GB（limit），存储：100GB持久化存储（SSD推荐）
  - **Redis Pod**：
    - 单节点：CPU：1核（request）/ 2核（limit），内存：2GB（request）/ 4GB（limit），存储：20GB持久化存储
    - 集群模式：3主3从，每节点CPU：1核（request）/ 2核（limit），内存：2GB（request）/ 4GB（limit）
  - **RabbitMQ Pod**：
    - 单节点：CPU：1核（request）/ 2核（limit），内存：2GB（request）/ 4GB（limit），存储：20GB持久化存储
    - 集群模式：3节点，每节点CPU：1核（request）/ 2核（limit），内存：2GB（request）/ 4GB（limit）
  - **etcd Pod**：
    - CPU：1核（request）/ 2核（limit）
    - 内存：1GB（request）/ 2GB（limit）
    - 存储：10GB持久化存储（3节点集群）
- **服务发现和负载均衡**：
  - 使用Kubernetes Service进行内部服务发现
  - 使用Ingress Controller对外暴露Web服务
  - 支持自动扩缩容（HPA）
- **配置管理**：
  - 使用ConfigMap管理应用配置
  - 使用Secret管理敏感信息
  - 支持配置热更新
- **监控和日志**：
  - 集成Prometheus + Grafana监控
  - 使用ELK Stack或Loki进行日志聚合
  - 配置健康检查和就绪探针

## 8. 项目里程碑

### 8.1 第一阶段（基础框架）
- [ ] 单Master节点基础框架搭建（Go + Gin）
- [ ] Agent节点基础框架搭建
- [ ] MySQL数据库设计和初始化（单主库模式）
- [ ] Redis缓存系统集成（单节点模式）
- [ ] JWT + RBAC认证系统实现
- [ ] gRPC通信模块实现
- [ ] 基础Web管理界面（Vue.js 3 + Element Plus）
- [ ] Docker容器化配置
- [ ] 基础监控和日志系统

### 8.2 第二阶段（核心功能）
- [ ] 资产扫描模块实现
- [ ] POC扫描模块实现
- [ ] Web扫描模块实现（包含爬虫和ChromeDriver）
- [ ] RabbitMQ消息队列集成
- [ ] Agent状态监控和负载均衡
- [ ] 智能任务调度系统
- [ ] 配置管理和热更新

### 8.3 第三阶段（高级功能）
- [ ] 监控预警模块实现
- [ ] 插件系统实现（热加载、沙箱执行）
- [ ] 通知模块实现
- [ ] 病毒查杀模块实现
- [ ] 审计日志系统
- [ ] API权限控制和限流

### 8.4 第四阶段（高可用架构和优化）
- [ ] Master集群架构实施
  - [ ] etcd集群部署和配置
  - [ ] Master多节点部署
  - [ ] API Gateway集成（Kong/Traefik）
  - [ ] 分布式任务调度实现
  - [ ] Master节点故障转移机制
  - [ ] 负载均衡和服务发现
- [ ] 数据层集群化
  - [ ] MySQL主从复制配置
  - [ ] Redis集群部署
  - [ ] RabbitMQ集群配置
  - [ ] 数据库读写分离实现
- [ ] Kubernetes高可用部署
  - [ ] Helm Charts编写（支持集群模式）
  - [ ] ConfigMap和Secret配置
  - [ ] Service和Ingress配置
  - [ ] 持久化存储配置
  - [ ] HPA自动扩缩容配置
- [ ] 监控和日志系统集成
  - [ ] Prometheus + Grafana监控
  - [ ] ELK日志聚合
  - [ ] 健康检查和告警
  - [ ] 集群状态监控
- [ ] 性能优化
  - [ ] 数据库查询优化
  - [ ] Redis缓存策略优化
  - [ ] 并发处理优化
  - [ ] 分布式锁优化
- [ ] 安全加固
  - [ ] 数据加密实现
  - [ ] 网络安全配置
  - [ ] 漏洞扫描和修复
  - [ ] 集群间通信安全
- [ ] 文档完善和测试验证
  - [ ] API文档生成
  - [ ] 集群部署文档编写
  - [ ] 自动化测试
  - [ ] 压力测试和性能测试
  - [ ] 故障恢复测试

## 9. 风险评估

### 9.1 技术风险
- **分布式架构复杂性**：需要处理网络通信、数据一致性等问题
- **扫描工具集成**：第三方工具集成可能存在兼容性问题
- **性能瓶颈**：大规模扫描可能遇到性能瓶颈
- **Redis缓存风险**：缓存数据丢失、缓存雪崩、缓存穿透问题
- **数据库性能**：MySQL在高并发场景下的性能瓶颈
- **Kubernetes复杂性**：容器编排、网络配置、存储管理的复杂性
- **消息队列风险**：RabbitMQ消息丢失、队列堆积、集群故障

### 9.2 安全风险
- **扫描行为合规性**：需要确保扫描行为符合法律法规
- **数据安全**：扫描结果可能包含敏感信息，需要加密存储
- **系统安全**：系统本身需要具备足够的安全防护
- **认证系统风险**：JWT令牌泄露、RBAC权限配置错误
- **网络安全**：分布式节点间通信安全，TLS证书管理
- **容器安全**：Docker镜像漏洞、Kubernetes集群安全配置

### 9.3 项目风险
- **开发周期**：功能复杂可能导致开发周期延长
- **资源投入**：需要足够的开发和测试资源
- **用户接受度**：需要确保系统易用性和实用性

### 9.4 运维风险
- **部署复杂性**：Kubernetes集群部署和维护复杂
- **监控难度**：多节点状态监控和故障定位
- **扩展性**：系统扩展时的配置管理和数据迁移
- **缓存管理**：Redis集群管理、数据持久化、故障恢复
- **依赖服务风险**：MySQL、RabbitMQ、Redis等服务的高可用性
- **版本管理**：多组件版本兼容性、滚动更新风险

### 9.5 风险缓解措施
- **技术风险缓解**：
  - 实施Redis集群和哨兵模式确保高可用
  - 数据库读写分离和连接池优化
  - Kubernetes资源限制和自动扩缩容
  - 完善的单元测试和集成测试
- **安全风险缓解**：
  - JWT令牌短期有效期和刷新机制
  - 数据库和Redis数据加密
  - 网络层面的安全组和防火墙配置
  - 定期安全审计和漏洞扫描
- **运维风险缓解**：
  - 自动化部署和配置管理
  - 完善的监控告警体系
  - 数据备份和灾难恢复方案
  - 详细的运维文档和应急预案

## 10. 后续规划

### 10.1 技术演进路线
- **前端技术升级**：
  - 从Vue.js 3 + Element Plus临时方案升级到更完善的前端架构
  - 考虑微前端架构支持模块化开发
  - 移动端适配和响应式设计优化
- **监控系统完善**：
  - 集成Prometheus + Grafana监控体系
  - 实施ELK/Loki日志聚合系统
  - APM性能监控和链路追踪
- **安全体系增强**：
  - 零信任网络架构实施
  - 多因子认证(MFA)支持
  - 数据脱敏和隐私保护

### 10.2 功能扩展
- **AI智能分析**：集成机器学习算法进行智能威胁分析
- **自动化响应**：基于扫描结果的自动化安全响应
- **云原生增强**：
  - 多云部署支持(AWS、Azure、阿里云)
  - Serverless架构探索
  - 边缘计算节点支持
- **高级扫描能力**：
  - 深度学习驱动的漏洞发现
  - 零日漏洞检测能力
  - 供应链安全扫描

### 10.3 性能优化
- **Master集群优化**：
  - 智能负载均衡算法优化
  - 分布式任务调度算法改进
  - Master节点间数据同步优化
  - 故障检测和恢复时间优化
- **分布式计算**：引入更高效的分布式计算框架
- **缓存优化**：
  - 多级缓存机制(L1: 内存, L2: Redis, L3: 分布式缓存)
  - 智能缓存预热和失效策略
  - 跨Master节点缓存一致性优化
- **数据库优化**：
  - 数据分片和读写分离
  - 时序数据库集成(InfluxDB)
  - 数据归档和冷热分离
  - 多主库架构探索
- **网络优化**：
  - gRPC连接池和多路复用
  - CDN加速和边缘节点部署
  - Master集群间网络优化

### 10.4 生态建设
- **插件市场**：建立插件生态系统和开发者工具链
- **API开放**：
  - GraphQL API支持
  - Webhook和事件驱动架构
  - 第三方系统集成SDK
- **DevOps集成**：
  - CI/CD流水线集成
  - GitOps部署模式
  - 基础设施即代码(IaC)
- **社区建设**：
  - 开发者社区和贡献者计划
  - 开源组件和工具
  - 技术分享和最佳实践

### 10.5 合规和标准化
- **安全合规**：ISO 27001、SOC 2等安全认证
- **行业标准**：支持NIST、OWASP等安全框架
- **数据保护**：GDPR、CCPA等数据保护法规遵循
- **审计支持**：完善的审计日志和合规报告

---

**文档版本**：v2.0  
**创建日期**：2025年7月21日  
**最后更新**：2025年7月21日  
**文档状态**：正式版  
**适用场景**：Master集群化生产环境

> 注：本文档为Master集群化版本，包含完整的分布式架构设计、高可用部署方案和Kubernetes集群配置。适用于生产环境的大规模部署场景。