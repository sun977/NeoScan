# 端口扫描实现方式和原理解析

## 一、核心实现原理

### 1. 探针指纹识别机制
端口扫描的核心是利用预定义的探针（Probes）向目标端口发送特定数据包，然后分析返回的响应来识别服务类型。该插件通过解析nmap服务指纹库（nmap-service-probes）来获取这些探针。

### 2. 数据包发送与接收
- 发送预定义的探测数据包到目标端口
- 接收端口的响应数据
- 通过正则表达式匹配响应内容以识别服务

## 二、主要组件分析

### 1. 数据结构
- [ScanPort](file:///c%3A/Users/root/Desktop/code/GoCode/code_03/SweetBabyScan/core/plugins/plugin_scan_port/models.go#L10-L15): 扫描器主结构，包含探针列表和配置
- [Probe](file:///c%3A/Users/root/Desktop/code/GoCode/code_03/SweetBabyScan/core/plugins/plugin_scan_port/models.go#L17-L26): 探针结构，定义了探测数据包和匹配规则
- [Match](file:///c%3A/Users/root/Desktop/code/GoCode/code_03/SweetBabyScan/core/plugins/plugin_scan_port/models.go#L32-L38): 匹配规则，定义了服务识别的正则表达式
- [Target](file:///c%3A/Users/root/Desktop/code/GoCode/code_03/SweetBabyScan/core/plugins/plugin_scan_port/models.go#L59-L63): 目标结构，包含主机、端口和协议信息
- [Service](file:///c%3A/Users/root/Desktop/code/GoCode/code_03/SweetBabyScan/core/plugins/plugin_scan_port/models.go#L78-L86): 服务信息结构，包含识别出的服务详情

### 2. 核心流程

#### 1. 初始化
- 读取nmap服务指纹库文件
- 解析指纹库内容为探针对象
- 按照探针优先级（Rarity）进行排序

#### 2. 探针解析
- 解析探针协议、端口、SSL端口、等待时间等参数
- 解析匹配规则（match）和软匹配规则（softmatch）
- 解析版本信息提取规则

#### 3. 扫描执行
- 选择适用的探针（根据端口匹配、协议匹配等）
- 按照Rarity值升序排列探针
- 依次使用探针向目标发送数据包
- 接收响应并匹配规则
- 提取服务版本信息

## 三、关键技术细节

### 1. 探针优先级排序
探针按照Rarity值排序，优先使用Rarity值较低的探针。Rarity值表示探针的通用性，值越小表示越通用，越先执行。

### 2. 探针类型
- **NULL探针**: 不发送任何数据，仅监听响应
- **普通探针**: 发送特定数据包探测服务
- **软匹配探针**: 用于非精确匹配，提取更多信息

### 3. 规则匹配机制
- **硬匹配**（match）: 精确匹配，一旦匹配成功立即返回结果
- **软匹配**（softmatch）: 非精确匹配，提供额外信息补充

### 4. 版本信息提取
通过正则表达式捕获组提取服务版本信息，支持以下字段：
- VendorProduct: 供应商产品信息
- Version: 版本号
- Info: 附加信息
- Hostname: 主机名
- OperatingSystem: 操作系统
- DeviceType: 设备类型
- CPE: 通用平台枚举

## 四、扫描流程

1. **准备阶段**:
   - 初始化[ScanPort](file:///c%3A/Users/root/Desktop/code/GoCode/code_03/SweetBabyScan/core/plugins/plugin_scan_port/models.go#L10-L15)对象，加载指纹库
   - 解析指纹库内容到探针对象
   - 按Rarity值排序探针

2. **探针选择**:
   - 根据配置选择探针类型（全部、仅NULL、自适应）
   - 根据端口和协议匹配筛选探针
   - 按优先级排序

3. **发送探测**:
   - 遍历排序后的探针列表
   - 向目标端口发送探针数据包
   - 接收响应数据

4. **匹配处理**:
   - 使用正则表达式匹配响应数据
   - 提取服务版本信息
   - 返回识别结果

## 五、特色功能

1. **多协议支持**: 支持TCP和UDP协议
2. **智能排序**: 按照探针通用性排序，提高识别准确性
3. **版本提取**: 可提取详细的服务版本信息
4. **灵活配置**: 支持多种扫描模式（全部探针、仅NULL探针、自适应）
5. **容错处理**: 提供fallback机制，确保识别成功率

这种实现方式借鉴了nmap的端口扫描技术，通过大量预定义的探针和匹配规则来识别网络服务，是一种成熟可靠的端口服务识别方法。