# CScan 项目分析文档

## 一、项目概述

CScan 是一个企业级分布式网络资产扫描平台，旨在提供全面的资产发现、指纹识别、漏洞检测和报告导出能力。该项目采用微服务架构，支持大规模分布式扫描与集中化任务调度，为网络安全工程师、渗透测试人员和企业安全团队提供强大的扫描功能。

## 二、目录功能说明

### 1. api/
API 服务层，提供对外 REST 接口，使用 go-zero 框架开发。
- etc/: 配置文件
- internal/config: 内部配置定义
- internal/handler: HTTP 请求处理逻辑
- internal/logic: 业务逻辑处理
- internal/middleware: 中间件（认证、权限等）
- internal/svc: 服务上下文
- internal/types: 类型定义
- cscan.go: API 服务入口

### 2. cmd/worker/
Worker 命令行程序入口，负责启动扫描工作节点。
- main.go: Worker 主程序入口，包含参数解析、安装密钥验证等功能

### 3. docker/
Docker 相关配置文件。
- cscan-api.yaml: API 服务 Docker 配置
- entrypoint.sh: Docker 启动脚本
- mongo-init.js: MongoDB 初始化脚本
- task.yaml: 任务服务配置

### 4. model/
数据模型定义，包括数据库实体和常量定义。
- apiconfig.go: API 配置模型
- asset.go: 资产模型
- auditlog.go: 审计日志模型
- base.go: 基础模型
- blacklist.go: 黑名单模型
- commandhistory.go: 命令历史模型
- core.go: 核心模型
- dirscan.go: 目录扫描模型
- dirscan_result.go: 目录扫描结果模型
- errors.go: 错误定义
- fingerprint.go: 指纹模型
- httpservice.go: HTTP 服务模型
- notifyconfig.go: 通知配置模型
- organization.go: 组织模型
- poc.go: POC 模型
- scanjob.go: 扫描作业模型
- scanresult.go: 扫描结果模型
- scantarget.go: 扫描目标模型
- scantemplate.go: 扫描模板模型
- subdomain_dict.go: 子域名字典模型
- subfinderconfig.go: 子域名查找配置模型
- task.go: 任务模型
- user.go: 用户模型
- vul.go: 漏洞模型
- workspace.go: 工作空间模型

### 5. onlineapi/
在线 API 集成，对接第三方数据源。
- fofa.go: FOFA API 集成
- hunter.go: Hunter API 集成
- quake.go: Quake API 集成

### 6. pkg/
通用工具包。
- logger: 日志工具
- mapping: 映射工具
- notify: 通知服务
- response: 响应工具
- retry: 重试工具
- risk: 风险计算器
- template: 模板解析器
- utils: 实用工具函数
- xerr: 错误处理

### 7. poc/
POC（Proof of Concept）规则库。
- custom-finger: 自定义指纹规则
- custom-pocs: 自定义 POC 规则
- custom-scanTemplate: 自定义扫描模板

### 8. rpc/
RPC 服务，用于内部服务通信。
- task: 任务相关的 RPC 服务

### 9. scanner/
扫描器模块，包含各种扫描技术实现。
- customfinger.go: 自定义指纹扫描
- domainscan.go: 域名扫描
- fingerprint.go: 指纹识别
- fingerprintx.go: 增强版指纹识别
- httpx_lib.go: HTTPX 库封装
- masscan.go: Masscan 扫描器
- naabu.go: Naabu 扫描器
- nmap.go: Nmap 扫描器
- nuclei.go: Nuclei 漏洞扫描器
- pipeline.go: 扫描流水线
- portscan.go: 端口扫描
- scanner.go: 扫描器基类
- subdomain_bruteforce.go: 子域名暴力破解
- subfinder.go: 子域名查找
- target.go: 目标处理
- urlfinder.go: URL 查找
- utils.go: 扫描工具函数

### 10. scheduler/
任务调度器，负责任务分配和负载均衡。
- config.go: 调度器配置
- config_validator.go: 配置验证器
- cron.go: 定时任务
- load_balancer.go: 负载均衡器
- scheduler.go: 调度器主逻辑
- service.go: 调度服务
- splitter.go: 任务分割器

### 11. web/
前端项目，包含 UI 界面。
- src: 前端源代码
- Dockerfile: 前端 Docker 配置
- docker-entrypoint.sh: 前端启动脚本
- nginx.conf: Nginx 配置
- package.json: 前端依赖配置

### 12. worker/
Worker 节点实现，执行具体的扫描任务。
- adaptive_scheduler.go: 自适应调度器
- filemanager.go: 文件管理器
- httpclient.go: HTTP 客户端
- loadavg_unix.go: Unix 系统负载平均值
- loadavg_windows.go: Windows 系统负载平均值
- logwriter.go: 日志写入器
- resource_manager.go: 资源管理器
- restart_unix.go: Unix 系统重启功能
- restart_windows.go: Windows 系统重启功能
- sysinfo.go: 系统信息获取
- task_queue_manager.go: 任务队列管理器
- task_runner.go: 任务执行器
- task_runner_integration.go: 任务执行器集成测试
- terminal.go: 终端模拟器
- worker.go: Worker 主逻辑
- wsclient.go: WebSocket 客户端

## 三、项目运行原理和逻辑

### 1. 整体架构

CScan 采用微服务架构，分为以下几个核心组件：

- **API Service**: 提供 RESTful API 接口，处理前端请求和业务逻辑
- **RPC Service**: 内部服务通信，处理任务调度和状态同步
- **Worker Cluster**: 扫描工作节点，执行具体扫描任务
- **MongoDB**: 存储资产、任务、漏洞等数据
- **Redis**: 作为缓存和任务队列，实现状态同步和消息传递
- **Web Frontend**: 提供用户界面，展示扫描结果和管理功能

### 2. 任务调度流程

1. **任务创建**: 用户通过前端界面创建扫描任务，API 服务接收并存储到 MongoDB
2. **任务分发**: 任务被拆分成多个子任务，放入 Redis 队列
3. **Worker 注册**: Worker 启动时向系统注册，验证安装密钥后加入可用 Worker 列表
4. **负载均衡**: 调度器根据 Worker 的负载情况（CPU、内存、任务数）分配任务
5. **任务执行**: Worker 从队列中获取任务，执行扫描并将结果回传
6. **结果处理**: 结果存储到 MongoDB，前端实时展示

### 3. Worker 节点管理

Worker 节点通过以下方式与主系统交互：

- **心跳机制**: Worker 定期发送心跳信息，包含系统资源使用情况
- **WebSocket 连接**: 保持长连接，实时接收任务和控制指令
- **安装密钥验证**: 启动时验证安装密钥，确保安全性
- **状态同步**: 通过 Redis 同步 Worker 状态和任务进度

### 4. 扫描模块

系统集成了多种扫描技术：

- **端口扫描**: 使用 Naabu、Masscan、Nmap 等工具
- **子域名枚举**: 结合 Subfinder（被动）与 KSubdomain（字典爆破）
- **指纹识别**: 集成 Httpx + Wappalyzer + 自定义引擎，支持超3万条规则
- **URL 发现**: 通过 Urlfinder 实现路径爬取
- **漏洞检测**: 使用 Nuclei SDK 执行 POC 扫描，支持自定义 POC
- **Web 截图**: 利用 Chromedp 和 HTTPX 进行页面快照

### 5. 安全机制

- **JWT 认证**: 保护敏感接口，确保用户身份合法性
- **安装密钥认证**: Worker 注册时使用 Install Key 验证
- **输入参数校验**: 防止命令注入等安全风险
- **审计日志**: 记录操作行为与系统事件

### 6. 数据流向

1. 用户通过前端界面提交扫描任务
2. API 服务验证权限并保存任务到 MongoDB
3. 任务被放入 Redis 队列等待执行
4. 调度器根据 Worker 负载情况分配任务
5. Worker 获取任务并执行扫描
6. 扫描结果和日志实时回传到 API 服务
7. 结果存储到 MongoDB 并通过前端展示给用户

### 7. 分布式特性

- **水平扩展**: 可以添加多个 Worker 节点提高扫描能力
- **负载均衡**: 自动分配任务到可用的 Worker
- **故障恢复**: 当某个 Worker 失效时，任务会重新分配给其他 Worker
- **集中管理**: 通过 API 服务统一管理和监控所有 Worker

### 8. 数据存储

- **MongoDB**: 存储资产、任务、漏洞、扫描结果等持久化数据
- **Redis**: 存储临时数据、任务队列、Worker 状态、实时日志等
- **文件系统**: 存储配置文件、POC 规则、扫描报告等

这个架构设计使得 CScan 成为一个功能强大、可扩展的企业级扫描平台，能够处理大规模网络资产的安全检测任务。