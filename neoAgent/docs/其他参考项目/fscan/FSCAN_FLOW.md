# fscan 执行流程分析文档

本文档详细分析了 `fscan.exe -h 192.168.x.x` 命令的完整执行流程。

## 1. 程序启动阶段

当执行 `fscan.exe -h 192.168.x.x` 命令时，程序从 [main.go](./main.go) 开始执行：

```go
func main() {
	start := time.Now()
	var Info common.HostInfo
	common.Flag(&Info)
	common.Parse(&Info)
	Plugins.Scan(Info)
	t := time.Now().Sub(start)
	fmt.Printf("[*] 扫描结束,耗时: %s\n", t)
}
```

## 2. 初始化和参数解析阶段

### 2.1. Banner 显示
- 调用 `common.Banner()` 函数显示 fscan 的版本信息横幅

### 2.2. 参数解析
- 调用 `common.Flag(&Info)` 解析命令行参数
- `-h 192.168.x.x` 参数被解析并存储到 Info.Host 中
- 其他参数使用默认值，如 `-m all`（扫描所有类型）、`-t 600`（600个线程）等

### 2.3. 输入参数处理
- 调用 `common.Parse(&Info)` 进一步处理解析后的参数
- 验证输入参数的有效性
- 设置扫描相关的配置项

## 3. 扫描执行阶段

### 3.1. IP 地址解析
- 调用 `common.ParseIP(info.Host, common.HostFile, common.NoHosts)` 解析输入的目标 IP 地址
- 将 `192.168.x.x` 转换为内部表示格式

### 3.2. HTTP 初始化
- 调用 `lib.Inithttp(common.Pocinfo)` 初始化 HTTP 客户端配置

### 3.3. 主机存活检测
- 如果没有设置 `-np`（跳过 ping）参数，则执行 ICMP 存活检测
- 调用 `CheckLive()` 函数检测哪些主机是可达的
- 输出存活主机数量：`[*] Icmp alive hosts len is: x`

### 3.4. 端口扫描
- 如果扫描类型不是 `icmp`，则执行端口扫描
- 调用 `PortScan()` 函数对目标主机的常见端口进行扫描
- 扫描的端口包括：21(FTP)、22(SSH)、80(HTTP)、445(SMB)、3389(RDP)等
- 输出存活端口数量：`[*] alive ports len is: x`

### 3.5. 漏洞扫描调度
- 遍历所有存活的端口
- 根据端口号和扫描类型决定执行哪种类型的扫描
- 使用并发机制调用 `AddScan()` 函数启动具体的扫描任务

#### 3.5.1. 特定端口的扫描类型
- 135端口：执行 Findnet 扫描和 WMIExec（如果启用）
- 445端口：执行 MS17-010 漏洞扫描
- 9000端口：执行 HTTP 和 FCGI 扫描
- 其他已知服务端口：执行对应的服务扫描（SSH、FTP、MySQL等）
- 其他端口：执行 Web 标题扫描

### 3.6. 并发执行机制
- 使用信号量机制控制并发数（默认600个线程）
- 通过 channel 控制最大并发任务数
- 每个扫描任务在独立的 goroutine 中执行
- 使用 WaitGroup 等待所有任务完成

### 3.7. 结果处理
- 扫描结果通过 channel 传递给日志处理协程
- 根据配置决定是否保存结果到文件
- 实时输出扫描进度

## 4. 扫描类型说明

当使用默认的 `-m all` 参数时，fscan 会执行以下类型的扫描：

- **主机发现**: ICMP ping 扫描
- **端口扫描**: 对常见端口进行开放状态检测
- **服务识别**: 识别开放端口上运行的服务
- **漏洞扫描**: 对识别出的服务进行漏洞检测
- **弱口令爆破**: 对常见服务尝试弱口令破解

## 5. 结束阶段

- 等待所有扫描任务完成
- 输出最终统计信息
- 计算并显示总耗时

## 6. 特殊功能

- **自动 GC**: 程序会定期执行垃圾回收以节省内存
- **日志记录**: 所有扫描结果会被记录到文件
- **错误处理**: 对网络错误和超时进行适当处理

这个流程使得 fscan 能够高效地对目标网络进行综合安全扫描，发现潜在的安全风险和漏洞。