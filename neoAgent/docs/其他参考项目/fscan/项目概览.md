# fscan 项目分析文档

fscan 是一款用 Go 语言编写的内网综合扫描工具，用于实现一键自动化、全方位的漏洞扫描，适用于企业安全建设中的合法授权检测。

## 项目目录结构及功能说明

```
fscan/
├── common/           # 公共组件，包含配置、参数解析、日志等功能
│   ├── Parse.go      # 参数解析相关功能
│   ├── ParseIP.go    # IP 解析相关功能
│   ├── ParsePort.go  # 端口解析相关功能
│   ├── config.go     # 全局配置变量（用户字典、默认端口、密码列表等）
│   ├── flag.go       # 命令行参数定义
│   ├── log.go        # 日志记录功能
│   └── proxy.go      # 代理相关功能
├── Plugins/          # 扫描插件模块
│   ├── CVE-2020-0796.go # CVE-2020-0796 漏洞扫描
│   ├── NetBIOS.go       # NetBIOS 服务扫描
│   ├── base.go          # 插件基础功能和加密函数
│   ├── fcgiscan.go      # FastCGI 扫描
│   ├── findnet.go       # 网络发现扫描
│   ├── ftp.go           # FTP 服务扫描
│   ├── icmp.go          # ICMP 主机发现
│   ├── memcached.go     # Memcached 服务扫描
│   ├── mongodb.go       # MongoDB 服务扫描
│   ├── ms17010-exp.go   # MS17-010 漏洞利用
│   ├── ms17010.go       # MS17-010 漏洞扫描
│   ├── mssql.go         # MSSQL 服务扫描
│   ├── mysql.go         # MySQL 服务扫描
│   ├── oracle.go        # Oracle 服务扫描
│   ├── portscan.go      # 端口扫描
│   ├── postgres.go      # PostgreSQL 服务扫描
│   ├── rdp.go           # RDP 服务扫描
│   ├── redis.go         # Redis 服务扫描
│   ├── scanner.go       # 扫描调度器，核心调度逻辑
│   ├── smb.go           # SMB 服务扫描
│   ├── smb2.go          # SMB2 服务扫描
│   ├── ssh.go           # SSH 服务扫描
│   ├── webtitle.go      # Web 标题获取
│   └── wmiexec.go       # WMI 执行功能
├── WebScan/          # Web 漏洞扫描模块
│   ├── InfoScan.go      # Web 信息扫描入口
│   ├── WebScan.go       # Web 漏洞扫描主逻辑
│   ├── info/            # Web 信息扫描规则
│   │   └── rules.go     # Web 服务识别规则
│   ├── lib/             # Web 扫描库
│   │   ├── check.go     # POC 执行检查
│   │   ├── client.go    # HTTP 客户端
│   │   ├── eval.go      # 表达式求值
│   │   ├── http.proto   # HTTP 协议相关
│   │   └── shiro.go     # Shiro 框架相关
│   └── pocs/            # POC 文件目录（约 251 个文件）
├── main.go           # 程序入口点
├── README.md         # 中文说明文档
└── README_EN.md      # 英文说明文档
```

## 代码运行原理和逻辑

### 1. 程序启动流程

```
main.go -> common.Flag() -> common.Parse() -> Plugins.Scan() -> 结束统计
```

1. **main.go**: 程序入口，记录开始时间，初始化 HostInfo 结构体
2. **参数解析**: 通过 common.Flag 和 common.Parse 解析命令行参数
3. **扫描执行**: 调用 Plugins.Scan() 执行扫描
4. **结束统计**: 计算总耗时并输出结果

### 2. 扫描流程详解

#### 2.1. IP 地址解析
- 从命令行参数或文件中解析目标主机列表
- 支持 CIDR 格式批量解析
- 过滤掉排除的 IP 地址

#### 2.2. 主机存活检测
- 通过 ICMP ping 检测主机是否在线
- 根据 Ping 参数决定是否跳过存活检测
- 输出存活主机数量

#### 2.3. 端口扫描
- 扫描预设端口或用户指定端口
- 支持多种扫描模式（全端口、指定端口等）
- 输出存活端口数量

#### 2.4. 漏洞扫描调度
- 根据扫描类型（all、main、特定服务）分配扫描任务
- 对于 "all" 和 "main" 类型，根据端口号选择对应的扫描插件：
  - 135 端口：Findnet 扫描和 WMIExec（如果启用）
  - 445 端口：MS17-010 漏洞扫描
  - 9000 端口：Web 扫描和 FCGI 扫描
  - 其他已知服务端口：调用对应插件扫描
  - 其他端口：Web 标题扫描

#### 2.5. 插件执行机制
- 通过 PluginList 映射表关联端口号与扫描函数
- 使用协程池控制并发数量
- 每个扫描任务在独立的 goroutine 中执行

### 3. 关键组件功能

#### 3.1. common/config.go
- 定义全局配置变量
- 用户名和密码字典
- 默认端口映射
- 全局选项（超时时间、线程数等）

#### 3.2. Plugins/scanner.go
- 核心扫描调度逻辑
- 控制扫描流程（主机发现 → 端口扫描 → 漏洞扫描）
- 协程管理和同步

#### 3.3. Plugins/base.go
- 插件注册表 PluginList
- 加密解密函数（AES）
- 辅助函数

#### 3.4. WebScan 模块
- Web 漏洞扫描功能
- POC 加载和执行
- 支持 YAML 格式的 POC（兼容 Xray）
- 指纹识别和 CMS 识别

### 4. 并发机制
- 使用 channel 控制最大并发数
- 使用 WaitGroup 等待所有任务完成
- 内存垃圾回收优化（GC）

### 5. 扫描类型支持
- **ICMP**: 仅主机存活检测
- **Portscan**: 主机 + 端口扫描
- **Webonly/Webpoc**: 仅 Web 扫描
- **Hostname**: 仅 NetBIOS 扫描
- **All/Main**: 完整扫描
- **特定服务**: 如 SSH、FTP、SMB 等

### 6. 输出和日志
- 结果保存到文件（默认 result.txt）
- 彩色控制台输出
- 支持详细日志记录

### 7. 扩展性设计
- 插件化架构，易于添加新扫描功能
- POC 可热加载，支持外部 POC 文件
- 配置参数灵活，可通过命令行调整

## 技术特点

1. **高性能**: 采用 Go 语言编写，支持高并发扫描
2. **全面性**: 支持多种协议和服务的扫描
3. **易扩展**: 插件化设计，方便添加新的扫描功能
4. **安全性**: 仅用于授权的安全测试
5. **便携性**: 单文件可执行，无需额外依赖

该项目是一个功能强大且结构清晰的内网扫描工具，具有良好的扩展性和实用性。