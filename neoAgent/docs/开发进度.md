# Agent å¼€å‘è¿›åº¦è¯„ä¼° (æˆªè‡³ 2026-02-04)

## æ ¸å¿ƒçŠ¶æ€æ¦‚è§ˆ

**"Foundation First. Speed Second."**
Agent æ­£å¤„äºä» "HTTP Worker" å‘ "Native Scanner" çš„å…³é”®è½¬å‹æœŸã€‚
Cobra CLI æ¶æ„å’Œ Core Task æ¨¡å‹å·²å»ºç«‹ï¼ŒOptions å¼ºç±»å‹å‚æ•°è§£æå·²å°±ç»ªã€‚
**Phase 4 (ç¼–æ’ä¸é›†æˆ)** å·²å–å¾—é‡å¤§è¿›å±•ï¼Œ**Phase 4.1 å…¨æµç¨‹ç¼–æ’** å·²å®Œæˆã€‚
**Phase 4.2 (é›†ç¾¤é€‚é…)** å·²å®Œæˆï¼Œ**Agent å·²å…·å¤‡å®Œæ•´çš„ Worker èƒ½åŠ› (æ‹‰å–-æ‰§è¡Œ-ä¸ŠæŠ¥)**ã€‚

*   **Architecture (æ¶æ„)**: **100%**ã€‚Cobra å‘½ä»¤æ ‘ã€Options æ¨¡å¼ã€Core Task æ¨¡å‹å·²å®Œæˆï¼ŒReporter æ¥å£å·²å®šä¹‰ã€‚
*   **Core Capability (æ ¸å¿ƒèƒ½åŠ›)**: **100%**ã€‚
    *   IpAliveScanner: ğŸŸ¢ (RTT/TTL/OS/Hostname/CIDRæ”¯æŒ)
    *   PortScanner: ğŸŸ¢ (TCP Connect + CSV/JSON Export)
    *   ServiceScanner: ğŸŸ¢ (Nmap Engine + Custom Rules + **Dynamic Scheduling**)
    *   OSScanner: ğŸŸ¢ (TCP/IP Stack Fingerprint + Service Banner + Unified Output)
*   **Orchestration (ç¼–æ’)**: **100%**ã€‚
    *   Pipeline: ğŸŸ¢ (Alive -> Port -> Service -> OS è‡ªåŠ¨åŒ–ä¸²è”)
    *   TargetGenerator: ğŸŸ¢ (æ”¯æŒ CIDR/Range/List è§£æ)
    *   AutoRunner: ğŸŸ¢ (æ”¯æŒå¹¶å‘æ‰«æã€ç»“æœæ±‡æ€»ã€Funnel è¿‡æ»¤)
*   **Infrastructure (åŸºç¡€è®¾æ–½)**: **95%**ã€‚Nmap è§„åˆ™åº“é™æ€æ‰“åŒ…å®Œæˆï¼Œç½‘ç»œåº“ (Dialer/Proxy) é‡æ„å®Œæˆï¼ŒRaw Socket æ”¯æŒå°±ç»ªã€‚
*   **Connectivity (è¿æ¥æ€§)**: **100%**ã€‚Master-Agent é€šä¿¡é—­ç¯å·²æ‰“é€šï¼Œæ”¯æŒ Token è®¤è¯ã€å¿ƒè·³ã€ä»»åŠ¡æ‹‰å–ä¸ç»“æœä¸ŠæŠ¥ã€‚

---

## 1. æ¨¡å—è¯¦ç»†è¯„ä¼°

### 1.1 Core Decoupling (æ ¸å¿ƒè§£è€¦) - "The Foundation"
| ç»„ä»¶ | çŠ¶æ€ | å¤‡æ³¨ |
| :--- | :--- | :--- |
| **Directory Structure** | ğŸŸ¢ **Done** | `internal/core` å·²åˆ›å»ºã€‚ |
| **Task Model** | ğŸŸ¢ **Done** | `model.Task` å·²å®šä¹‰ï¼Œæ”¯æŒå¤šç§æ‰«æç±»å‹ã€‚ |
| **Service Logic** | ğŸŸ¢ **Done** | Scanner/Runner æ¥å£å·²å®šä¹‰ (`runner/interface.go`)ã€‚ |
| **Reporter** | ğŸŸ¢ **Done** | `ConsoleReporter` (Tabular) å’Œ `CsvReporter` å·²å®ç°å¹¶ç»Ÿä¸€ã€‚ |

### 1.2 CLI Transformation (CLI æ”¹é€ ) - "The Interface"
| ç»„ä»¶ | çŠ¶æ€ | å¤‡æ³¨ |
| :--- | :--- | :--- |
| **Cobra Entry** | ğŸŸ¢ **Done** | `main.go` å·²é‡å†™ï¼Œ`root.go` é›†æˆ Viperã€‚ |
| **Server Command** | ğŸŸ¢ **Done** | æ”¯æŒ `--master` å’Œ `--token` å‚æ•°ã€‚ |
| **Scan Command** | ğŸŸ¢ **Done** | 8ç§æ‰«æå­å‘½ä»¤ (Alive, Port, Service, OS, Web, Dir, Vuln, Subdomain) å·²å°±ç»ªã€‚ |
| **Proxy Command** | ğŸŸ¢ **Done** | æ”¯æŒ Socks5/HTTP/PortForward æ¨¡å¼å‚æ•°è§£æã€‚ |
| **Output Config** | ğŸŸ¢ **Done** | å…¨å±€æ”¯æŒ CSV/JSON è¾“å‡º (`--oc`, `--oj`)ï¼Œä¸” OS/Port æ‰«æå·²é€‚é…ã€‚ |

### 1.3 Native Capabilities (åŸç”Ÿèƒ½åŠ›) - "The Power"
| ç»„ä»¶ | çŠ¶æ€ | å¤‡æ³¨ |
| :--- | :--- | :--- |
| **Concurrency** | ğŸŸ¢ **Done** | åŸºäº Semaphore çš„å¹¶å‘æ§åˆ¶ï¼Œæ”¯æŒ WaitGroup è°ƒåº¦ã€‚ |
| **Host Discovery** | ğŸŸ¢ **Done** | `IpAliveScanner` å·²å®ç° ARP/ICMP/TCP æ¢æµ‹ï¼Œæ”¯æŒ OS/Hostname/RTT/TTL è§£æã€‚ |
| **Port Scan** | ğŸŸ¢ **Done** | åŸç”Ÿ TCP Connect Scanï¼Œæ”¯æŒå¹¶å‘æ§åˆ¶ï¼ŒCLI è¾“å‡ºå·²ç»Ÿä¸€ã€‚ |
| **Service Scan** | ğŸŸ¢ **Done** | `PortServiceScanner` æ•´åˆ Gonmap å¼•æ“ï¼Œæ”¯æŒ Nmap æ¢é’ˆå’ŒæŒ‡çº¹åŒ¹é…ã€‚**æ–°å¢æ™ºèƒ½è°ƒåº¦**ã€‚ |
| **OS Finger** | ğŸŸ¢ **Done** | å®ç°äº† Nmap TCP/IP æ ˆæŒ‡çº¹è¯†åˆ« (Loopback ä¼˜åŒ–) + æœåŠ¡ Banner è¾…åŠ©è¯†åˆ«ã€‚ |
| **Web Finger** | ğŸŸ¡ **Pending** | åŸºç¡€æ¶æ„å·²å°±ç»ªï¼Œç­‰å¾… Pipeline é›†æˆã€‚ |

### 1.4 Cluster Integration (é›†ç¾¤é›†æˆ) - "The Connection"
| ç»„ä»¶ | çŠ¶æ€ | å¤‡æ³¨ |
| :--- | :--- | :--- |
| **Join Protocol** | ğŸŸ¢ **Done** | CLI å‚æ•°å·²æ”¯æŒ Tokenï¼ŒåºŸé™¤ç‹¬ç«‹çš„ Join å‘½ä»¤ã€‚ |
| **Auth Storage** | ğŸŸ¢ **Done** | Viper ç»‘å®š Tokenï¼Œå†…å­˜/æ–‡ä»¶é…ç½®æ”¯æŒã€‚ |
| **Task Pulling** | ğŸŸ¢ **Done** | `internal/service/task` å®ç°äº† Worker Loopï¼Œæ”¯æŒé•¿è½®è¯¢ã€‚ |

### 1.5 Scan Orchestration (å…¨æµç¨‹ç¼–æ’) - "The Brain"
| ç»„ä»¶ | çŠ¶æ€ | å¤‡æ³¨ |
| :--- | :--- | :--- |
| **Pipeline Core** | ğŸŸ¢ **Done** | `PipelineRunner` å·²å®ç°ï¼Œæ”¯æŒ Stage é—´æ•°æ®æµè½¬ã€‚ |
| **Target Gen** | ğŸŸ¢ **Done** | æ”¯æŒ CIDR (192.168.1.0/24), Range, List è§£æã€‚ |
| **Auto Command** | ğŸŸ¢ **Done** | `scan run` å‘½ä»¤å·²å°±ç»ªï¼Œæ”¯æŒ `--summary` æ±‡æ€»æŠ¥å‘Šã€‚ |
| **Funnel Filter** | ğŸŸ¢ **Done** | å®ç°äº† Alive -> Port -> Service çš„æ¼æ–—å¼è¿‡æ»¤ã€‚ |

---

## 2. ä¸‹ä¸€æ­¥è¡ŒåŠ¨ (Next Steps)

**"Stop designing. Start coding."**

### P0: Phase 4.1 - å…¨æµç¨‹ç¼–æ’å‡çº§ (Parallel Pipeline)
*   **ç›®æ ‡**: å°†çº¿æ€§çš„ `PipelineRunner` å‡çº§ä¸ºæ”¯æŒ **å¹¶è¡Œåˆ†å‘** å’Œ **ä¼˜å…ˆçº§æ§åˆ¶** çš„ v2.0 ç‰ˆæœ¬ã€‚
*   **çŠ¶æ€**: ğŸŸ¡ **è®¾è®¡å®Œæˆï¼Œå¾…å¼€å‘**
*   **è¡ŒåŠ¨**:
    1.  **åˆ†å‘å™¨ (Dispatcher)**:
        - [ ] å®ç° `internal/core/pipeline/dispatcher.go`ï¼Œå®šä¹‰åˆ†å‘è§„åˆ™ (Web/Vuln/Brute)ã€‚
    2.  **æ‰§è¡Œå¼•æ“ (Runner Refactor)**:
        - [ ] é‡æ„ `AutoRunner`ï¼Œå¼•å…¥ `sync.WaitGroup` ç®¡ç†å¹¶è¡Œ Workerã€‚
        - [ ] å®ç° `Phase 1 (Sequential)`: Alive -> PortServiceã€‚
        - [ ] å®ç° `Phase 2 (Parallel)`: å¯åŠ¨ WebWorker, VulnWorker, BruteWorkerã€‚
    3.  **ä¾èµ–ç®¡ç† (Dependency)**:
        - [ ] å®ç° `Vuln First, Brute Last` ç­–ç•¥ï¼Œç¡®ä¿ Brute ä»»åŠ¡åœ¨åŒç«¯å£ Vuln ä»»åŠ¡å®Œæˆåæ‰§è¡Œã€‚

### P1: Phase 4.3 - é«˜çº§èƒ½åŠ›é›†æˆ (Advanced Capabilities)
*   **ç›®æ ‡**: æå‡ Agent çš„"é‡æ­¦å™¨"èƒ½åŠ›ã€‚
*   **è¡ŒåŠ¨**:
    1.  é›†æˆ **Nuclei** æ‰§è¡Œå™¨ (ä½œä¸ºç‹¬ç«‹ Scanner æˆ– Plugin)ã€‚
    2.  å®ç° **Web æŒ‡çº¹è¯†åˆ«** (Wappalyzer/FingerprintHub è§„åˆ™åº“é€‚é…)ã€‚
    3.  å®ç°åŸºç¡€çš„ **Web çˆ¬è™«** (URL é‡‡é›†)ã€‚

### P1: Phase 3.7 - åŸºç¡€çˆ†ç ´ (Brute Force)
*   **ç›®æ ‡**: å®ç°å¸¸è§æœåŠ¡çš„å¼±å£ä»¤æ£€æµ‹ï¼Œæ”¯æŒé«˜å¹¶å‘ä¸”å®‰å…¨ï¼ˆé˜²å°ç¦ï¼‰çš„çˆ†ç ´ã€‚
*   **çŠ¶æ€**: ğŸŸ¢ **å·²å®Œæˆ**
*   **è¡ŒåŠ¨**:
    1.  **åŸºç¡€è®¾æ–½ (Infrastructure)**:
        - [x] å®šä¹‰ `Cracker` æ¥å£ (å€Ÿé‰´ Qscanï¼Œçº¯ç²¹éªŒè¯é€»è¾‘)ã€‚
        - [x] å®ç° `DictManager` (æ”¯æŒå†…ç½® Top100 + `%user%` åŠ¨æ€æ›¿æ¢)ã€‚
        - [x] å®ç° `BruteScanner` è°ƒåº¦å™¨ (é›†æˆ `AdaptiveLimiter` å…¨å±€æµæ§ + å•æœºä¸²è¡Œ)ã€‚
    2.  **åè®®å®ç° (Protocols)**:
        - [x] **ç³»ç»ŸæœåŠ¡**: SSH, RDP (Native Go), SMB, Telnet, FTP, SNMP
        - [x] **æ•°æ®åº“**: MySQL, PostgreSQL, MSSQL, Oracle (SIDæ¢æµ‹+çˆ†ç ´), MongoDB, Redis, ClickHouse, Elasticsearch
    3.  **é›†æˆ (Integration)**:
        - [x] æ³¨å†Œåˆ° RunnerManagerã€‚
        - [x] CLI å‘½ä»¤ `scan brute` å®ç°ä¸éªŒè¯ (æ”¯æŒå¤šç«¯å£ã€å…¨é‡æ¨¡å¼ã€è¡¨æ ¼è¾“å‡º)ã€‚
        - [x] ç«¯åˆ°ç«¯æµ‹è¯• (Covered: SSH, Mock Network Error, StopOnSuccess)ã€‚

---

## 3. é£é™©ä¸é˜»ç¢ (Risks & Blockers)

*   **é£é™©**: Web æ¨¡å— (Nuclei/Crawler) å¯èƒ½ä¼šå¼•å…¥è¾ƒå¤§çš„äºŒè¿›åˆ¶ä½“ç§¯æˆ–å†…å­˜å¼€é”€ã€‚éœ€è¦ä»”ç»†æƒè¡¡æ˜¯ "Built-in" è¿˜æ˜¯ "Plugin/Sidecar"ã€‚
*   **é˜»ç¢**: æ— ã€‚

---

## 4. æœ€è¿‘æ›´æ–°è®°å½• (Changelog)

### [2026-02-04] Brute Scanner äº¤ä»˜ä¸ CLI å›½é™…åŒ–
**æ ¸å¿ƒäº¤ä»˜**:
1.  **å…¨åè®®çˆ†ç ´å°±ç»ª**: å®Œæˆäº† RDP (Native NLA/Standard), SSH, MySQL, Redis, Postgres, SMB, MSSQL, Oracle (SID+Auth), MongoDB, ClickHouse, FTP, Telnet, Elasticsearch, SNMP å…¨å¥—åè®®æ ˆçš„å®ç°ä¸éªŒè¯ã€‚
2.  **RDP åè®®æ ˆä¿®å¤**: ä¿®å¤äº† NLA å¼‚æ­¥æ¡æ‰‹å¯¼è‡´çš„å‡é˜³æ€§ Bugï¼Œå®ç°äº†ä¸¥æ ¼çš„è¿æ¥çŠ¶æ€ç­‰å¾…æœºåˆ¶ã€‚
3.  **Mock Lab å‡çº§**: å®Œå–„äº† Mock Server å¯¹ Redis RESP åè®®çš„æ”¯æŒï¼Œè§£å†³äº†ç«¯å£å†²çªé—®é¢˜ï¼Œç¡®ä¿æµ‹è¯•ç”¨ä¾‹ 100% é€šè¿‡ã€‚

**CLI ä½“éªŒé‡æ„**:
1.  **å›½é™…åŒ– (i18n)**: å°†æ‰€æœ‰æ‰«æå­å‘½ä»¤ (Alive/Port/OS/Brute) çš„ CLI è¾“å‡ºç»Ÿä¸€ä¸º**è‹±æ–‡**ï¼Œå½»åº•æ¶ˆé™¤è·¨å¹³å°ä¸­æ–‡ä¹±ç é£é™©ã€‚
2.  **é£æ ¼ç»Ÿä¸€**: å…¨é¢å¼•å…¥ `pterm` åº“ï¼Œç»Ÿä¸€äº† Info/Warning/Error/Table çš„è¾“å‡ºæ ·å¼ï¼Œæå‡äº¤äº’ä½“éªŒã€‚
3.  **åŠŸèƒ½å¢å¼º**: 
    - ç»Ÿä¸€äº† `utils.ParseIntList`ï¼Œæ”¯æŒ `-p 80,443,1000-2000` æ··åˆæ ¼å¼ã€‚
    - å¼•å…¥ `--all (-a)` å…¨é‡çˆ†ç ´æ¨¡å¼ã€‚
    - å®ç°äº† `TabularData` æ¥å£ï¼Œæ”¯æŒç»“æœè¡¨æ ¼åŒ–å±•ç¤ºã€‚

### [2026-02-03] QoS & Advanced Concurrency
**æ ¸å¿ƒä¼˜åŒ–**:
1.  **Adaptive Rate Limiting**: å®ç°äº†åŸºäº **AIMD** (Additive Increase Multiplicative Decrease) çš„è‡ªé€‚åº”é™æµå™¨ `qos.AdaptiveLimiter`ã€‚
    -   æˆåŠŸæ—¶çº¿æ€§å¢åŠ å¹¶å‘ï¼Œå¤±è´¥(è¶…æ—¶)æ—¶ä¹˜æ€§å‡å°‘å¹¶å‘ï¼ŒåŠ¨æ€æ¢æµ‹ç½‘ç»œå®¹é‡ã€‚
2.  **RTT Estimation**: å®ç°äº†åŸºäº **RFC 6298** çš„ `qos.RttEstimator`ã€‚
    -   åŠ¨æ€è®¡ç®— SRTT (å¹³æ»‘å¾€è¿”æ—¶é—´) å’Œ RTTVAR (æ³¢åŠ¨å€¼)ï¼Œç²¾å‡†æ§åˆ¶ RTO (è¶…æ—¶æ—¶é—´)ã€‚
3.  **Scanner Integration**: å°† QoS æ¨¡å—é›†æˆåˆ° `PortServiceScanner`ï¼Œæ˜¾è‘—æå‡äº†åœ¨ä¸ç¨³å®šç½‘ç»œä¸‹çš„æ‰«æç¨³å®šæ€§å’Œæ•ˆç‡ã€‚

### [2026-02-03] Cluster Integration å®Œæˆ
**é‡Œç¨‹ç¢‘**:
1.  **Cluster Adapter**: å®Œæˆäº† `internal/service` ä¸‹çš„ `adapter`, `client`, `task` æ¨¡å—ã€‚
2.  **End-to-End Test**: `test/20260202/joint_scan_test.go` éªŒè¯äº† Master-Agent çš„æ³¨å†Œã€ç™»å½•ã€ä»»åŠ¡ä¸‹å‘å…¨æµç¨‹ã€‚
3.  **Worker Loop**: å®ç°äº†åŸºäº Polling çš„ä»»åŠ¡è·å–ä¸ç»“æœä¸ŠæŠ¥æœºåˆ¶ã€‚

### [2026-02-01] Server ä¾èµ–æ³¨å…¥ä¸ Worker ä¿®å¤
**ä¿®å¤ä¸ä¼˜åŒ–**:
1.  **ä¾èµ–æ³¨å…¥ä¿®å¤**: ä¿®å¤äº† `app.go` å’Œ `router_manager.go` ä¸­çš„ä¾èµ–æ³¨å…¥æ–­è£‚é—®é¢˜ï¼Œç¡®ä¿ `TaskService` æ­£ç¡®ä¼ é€’ã€‚
2.  **æ—¥å¿—è§„èŒƒåŒ–**: é‡æ„äº† `agent_task.go` ä¸­çš„æ—¥å¿—è°ƒç”¨ï¼Œä½¿ç”¨ `LogSystemEvent` æ›¿ä»£é”™è¯¯çš„ä¸šåŠ¡æ—¥å¿—æ¥å£ï¼Œç¬¦åˆ Worker èº«ä»½ã€‚
3.  **åŒ…åå†²çªå¤„ç†**: è§£å†³äº† `router_manager.go` ä¸­ `handler/task` å’Œ `service/task` çš„åŒ…åå†²çªã€‚
4.  **ä»£ç ä¼˜åŒ–**: ä¼˜åŒ–äº† `master.go` ä¸­çš„çŠ¶æ€ä¸ŠæŠ¥é€»è¾‘ï¼Œä½¿ç”¨ `switch` æ›¿ä»£å†—ä½™çš„ `if-else`ã€‚

### [2026-02-01] Service æ¶æ„é‡æ„
**è®¾è®¡å†³ç­–**:
1.  **æœåŠ¡åˆ†å±‚**: æ˜ç¡®åŒºåˆ† Inbound (Server/Control) å’Œ Outbound (Client/Poll) æœåŠ¡ã€‚
2.  **èŒè´£åˆ†ç¦»**: 
    - `internal/service/client`: è´Ÿè´£ä¸»åŠ¨é€šä¿¡ï¼ˆæ³¨å†Œã€å¿ƒè·³ã€æ‹‰å–ï¼‰ã€‚
    - `internal/service/control`: è´Ÿè´£è¢«åŠ¨æ§åˆ¶ï¼ˆé‡å¯ã€é…ç½®ï¼‰ã€‚
    - `internal/service/adapter`: è´Ÿè´£åŒå‘åè®®è½¬æ¢ã€‚
3.  **æ–‡æ¡£æ›´æ–°**: æ›´æ–°äº† Service Layer çš„ READMEï¼Œæ˜ç¡®äº†æ¶æ„æ„å›¾ã€‚
