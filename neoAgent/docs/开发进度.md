# Agent 开发进度评估 (截至 2026-02-01)

## 核心状态概览

**"Foundation First. Speed Second."**
Agent 正处于从 "HTTP Worker" 向 "Native Scanner" 的关键转型期。
Cobra CLI 架构和 Core Task 模型已建立，Options 强类型参数解析已就绪。
**Phase 4 (编排与集成)** 已取得重大进展，**Phase 4.1 全流程编排** 已完成。
**Phase 4.2 (集群适配)** 的设计方案已定稿，进入实施准备阶段。

*   **Architecture (架构)**: **100%**。Cobra 命令树、Options 模式、Core Task 模型已完成，Reporter 接口已定义。
*   **Core Capability (核心能力)**: **100%**。
    *   IpAliveScanner: 🟢 (RTT/TTL/OS/Hostname/CIDR支持)
    *   PortScanner: 🟢 (TCP Connect + CSV/JSON Export)
    *   ServiceScanner: 🟢 (Nmap Engine + Custom Rules + **Dynamic Scheduling**)
    *   OSScanner: 🟢 (TCP/IP Stack Fingerprint + Service Banner + Unified Output)
*   **Orchestration (编排)**: **100%**。
    *   Pipeline: 🟢 (Alive -> Port -> Service -> OS 自动化串联)
    *   TargetGenerator: 🟢 (支持 CIDR/Range/List 解析)
    *   AutoRunner: 🟢 (支持并发扫描、结果汇总、Funnel 过滤)
*   **Infrastructure (基础设施)**: **95%**。Nmap 规则库静态打包完成，网络库 (Dialer/Proxy) 重构完成，Raw Socket 支持就绪。
*   **Connectivity (连接性)**: **50%**。设计方案已定稿，等待实施。

---

## 1. 模块详细评估

### 1.1 Core Decoupling (核心解耦) - "The Foundation"
| 组件 | 状态 | 备注 |
| :--- | :--- | :--- |
| **Directory Structure** | 🟢 **Done** | `internal/core` 已创建。 |
| **Task Model** | 🟢 **Done** | `model.Task` 已定义，支持多种扫描类型。 |
| **Service Logic** | 🟢 **Done** | Scanner/Runner 接口已定义 (`runner/interface.go`)。 |
| **Reporter** | 🟢 **Done** | `ConsoleReporter` (Tabular) 和 `CsvReporter` 已实现并统一。 |

### 1.2 CLI Transformation (CLI 改造) - "The Interface"
| 组件 | 状态 | 备注 |
| :--- | :--- | :--- |
| **Cobra Entry** | 🟢 **Done** | `main.go` 已重写，`root.go` 集成 Viper。 |
| **Server Command** | 🟢 **Done** | 支持 `--master` 和 `--token` 参数。 |
| **Scan Command** | 🟢 **Done** | 8种扫描子命令 (Alive, Port, Service, OS, Web, Dir, Vuln, Subdomain) 已就绪。 |
| **Proxy Command** | 🟢 **Done** | 支持 Socks5/HTTP/PortForward 模式参数解析。 |
| **Output Config** | 🟢 **Done** | 全局支持 CSV/JSON 输出 (`--oc`, `--oj`)，且 OS/Port 扫描已适配。 |

### 1.3 Native Capabilities (原生能力) - "The Power"
| 组件 | 状态 | 备注 |
| :--- | :--- | :--- |
| **Concurrency** | 🟢 **Done** | 基于 Semaphore 的并发控制，支持 WaitGroup 调度。 |
| **Host Discovery** | 🟢 **Done** | `IpAliveScanner` 已实现 ARP/ICMP/TCP 探测，支持 OS/Hostname/RTT/TTL 解析。 |
| **Port Scan** | 🟢 **Done** | 原生 TCP Connect Scan，支持并发控制，CLI 输出已统一。 |
| **Service Scan** | 🟢 **Done** | `PortServiceScanner` 整合 Gonmap 引擎，支持 Nmap 探针和指纹匹配。**新增智能调度**。 |
| **OS Finger** | 🟢 **Done** | 实现了 Nmap TCP/IP 栈指纹识别 (Loopback 优化) + 服务 Banner 辅助识别。 |
| **Web Finger** | 🟡 **Pending** | 基础架构已就绪，等待 Pipeline 集成。 |

### 1.4 Cluster Integration (集群集成) - "The Connection"
| 组件 | 状态 | 备注 |
| :--- | :--- | :--- |
| **Join Protocol** | 🟢 **Done** | CLI 参数已支持 Token，废除独立的 Join 命令。 |
| **Auth Storage** | 🟡 **Partial** | Viper 已绑定 Token，需确保持久化。 |
| **Task Pulling** | 🟡 **Pending** | 设计方案已定稿，已完成 `internal/service` 架构梳理，即将开始编码。 |

### 1.5 Scan Orchestration (全流程编排) - "The Brain"
| 组件 | 状态 | 备注 |
| :--- | :--- | :--- |
| **Pipeline Core** | 🟢 **Done** | `PipelineRunner` 已实现，支持 Stage 间数据流转。 |
| **Target Gen** | 🟢 **Done** | 支持 CIDR (192.168.1.0/24), Range, List 解析。 |
| **Auto Command** | 🟢 **Done** | `scan run` 命令已就绪，支持 `--summary` 汇总报告。 |
| **Funnel Filter** | 🟢 **Done** | 实现了 Alive -> Port -> Service 的漏斗式过滤。 |

---

## 2. 下一步行动 (Next Steps)

**"Stop designing. Start coding."**

### P0: Phase 4.2 - 集群适配 (Cluster Adapter) - [IN PROGRESS]
*   **目标**: 实施 `Server重构设计方案.md`，激活 `internal/service` 模块。
*   **行动**:
    1.  **Payload DTO**: 创建 `internal/model/adapter`，定义符合数据契约的 DTO。
    2.  **Adapter**: 完善 `internal/service/adapter`，实现 `ToCoreTask` 和 `ToMasterResult`。
    3.  **Communication**: 完善 `internal/service/client`，实现 HTTP 通信逻辑。
    4.  **Worker Loop**: 重写 `internal/service/task/agent_task.go`，串联拉取-执行-上报流程。
    5.  **Entry Point**: 修改 `cmd/agent/server.go`，接入新的 Worker Loop。

### P1: Phase 3.6 - 高级并发优化 (Continued)
*   **目标**: 进一步压榨性能。
*   **状态**: 🟢 **部分完成 (探针调度)**
*   **行动**:
    1.  优化 `Runner` 接口，支持动态并发调整 (Adaptive Rate Limiting)。
    2.  引入 `RttEstimator` 动态调整超时时间。

---

## 3. 风险与阻碍 (Risks & Blockers)

*   **风险**: Master 端协议兼容性。如果 Master 端下发的任务格式与 Agent 期望的差异过大，可能需要修改 Master 端代码或在 Agent 端做复杂的适配。
*   **阻碍**: 无。

---

## 4. 最近更新记录 (Changelog)

### [2026-02-01] Server 依赖注入与 Worker 修复
**修复与优化**:
1.  **依赖注入修复**: 修复了 `app.go` 和 `router_manager.go` 中的依赖注入断裂问题，确保 `TaskService` 正确传递。
2.  **日志规范化**: 重构了 `agent_task.go` 中的日志调用，使用 `LogSystemEvent` 替代错误的业务日志接口，符合 Worker 身份。
3.  **包名冲突处理**: 解决了 `router_manager.go` 中 `handler/task` 和 `service/task` 的包名冲突。
4.  **代码优化**: 优化了 `master.go` 中的状态上报逻辑，使用 `switch` 替代冗余的 `if-else`。

### [2026-02-01] Service 架构重构
**设计决策**:
1.  **服务分层**: 明确区分 Inbound (Server/Control) 和 Outbound (Client/Poll) 服务。
2.  **职责分离**: 
    - `internal/service/client`: 负责主动通信（注册、心跳、拉取）。
    - `internal/service/control`: 负责被动控制（重启、配置）。
    - `internal/service/adapter`: 负责双向协议转换。
3.  **文档更新**: 更新了 Service Layer 的 README，明确了架构意图。

### [2026-01-29] Server 重构方案定稿
**设计决策**:
1.  **架构清晰化**: 明确 CLI 使用 Pipeline，Server 使用 Atomic Scanners。
2.  **目录结构**: 确定复用 `internal/service` 作为 Worker 逻辑层，`core` 保持纯净。
3.  **数据契约**: 引入 `internal/model/adapter` 存放 DTO，确保与 Master 的通信契约严格一致。

### [2026-01-29] Pipeline 全流程编排实现
**新增功能**:
1.  **Pipeline 模块**: 实现了 `internal/core/pipeline`，包含 `AutoRunner` 和 `PipelineContext`。
2.  **CLI 增强**: `scan run` 支持自动化扫描，新增 `--summary` 参数输出汇总报告。
3.  **日志优化**: CLI 增加 `--log-level` 支持，优化了扫描过程中的日志干扰。
4.  **漏斗过滤**: 确立了 Host Discovery -> Port Scan -> Service Identification 的过滤机制，显著提升网段扫描效率。
