# Agent 开发进度评估 (截至 2026-01-27)

## 核心状态概览

**"Foundation First. Speed Second."**
Agent 正处于从 "HTTP Worker" 向 "Native Scanner" 的关键转型期。
Cobra CLI 架构和 Core Task 模型已建立，Options 强类型参数解析已就绪。
**Phase 3 (原生能力建设)** 已圆满完成，全面进入 **Phase 4 (编排与集成)**。

*   **Architecture (架构)**: **100%**。Cobra 命令树、Options 模式、Core Task 模型已完成，Reporter 接口已定义。
*   **Core Capability (核心能力)**: **100%**。
    *   IpAliveScanner: 🟢 (RTT/TTL/OS/Hostname/CIDR支持)
    *   PortScanner: 🟢 (TCP Connect + CSV/JSON Export)
    *   ServiceScanner: 🟢 (Nmap Engine + Custom Rules + **Dynamic Scheduling**)
    *   OSScanner: 🟢 (TCP/IP Stack Fingerprint + Service Banner + Unified Output)
*   **Infrastructure (基础设施)**: **95%**。Nmap 规则库静态打包完成，网络库 (Dialer/Proxy) 重构完成，Raw Socket 支持就绪。
*   **Connectivity (连接性)**: **50%**。`server` 命令已支持 Token 参数，但与 Master 的实际通信逻辑需适配新架构。

---

## 1. 模块详细评估

### 1.1 Core Decoupling (核心解耦) - "The Foundation"
| 组件 | 状态 | 备注 |
| :--- | :--- | :--- |
| **Directory Structure** | 🟢 **Done** | `internal/core` 已创建。 |
| **Task Model** | 🟢 **Done** | `model.Task` 已定义，支持多种扫描类型。 |
| **Service Logic** | 🟢 **Done** | Scanner/Runner 接口已定义 (`runner/interface.go`)。 |
| **Reporter** | 🟢 **Done** | `ConsoleReporter` (Tabular) 和 `CsvReporter` 已实现并统一。 |

### 1.2 CLI Transformation (CLI 改造) - "The Interface"
| 组件 | 状态 | 备注 |
| :--- | :--- | :--- |
| **Cobra Entry** | 🟢 **Done** | `main.go` 已重写，`root.go` 集成 Viper。 |
| **Server Command** | 🟢 **Done** | 支持 `--master` 和 `--token` 参数。 |
| **Scan Command** | 🟢 **Done** | 8种扫描子命令 (Alive, Port, Service, OS, Web, Dir, Vuln, Subdomain) 已就绪。 |
| **Proxy Command** | 🟢 **Done** | 支持 Socks5/HTTP/PortForward 模式参数解析。 |
| **Output Config** | 🟢 **Done** | 全局支持 CSV/JSON 输出 (`--oc`, `--oj`)，且 OS/Port 扫描已适配。 |

### 1.3 Native Capabilities (原生能力) - "The Power"
| 组件 | 状态 | 备注 |
| :--- | :--- | :--- |
| **Concurrency** | 🟢 **Done** | 基于 Semaphore 的并发控制，支持 WaitGroup 调度。 |
| **Host Discovery** | 🟢 **Done** | `IpAliveScanner` 已实现 ARP/ICMP/TCP 探测，支持 OS/Hostname/RTT/TTL 解析。 |
| **Port Scan** | 🟢 **Done** | 原生 TCP Connect Scan，支持并发控制，CLI 输出已统一。 |
| **Service Scan** | 🟢 **Done** | `PortServiceScanner` 整合 Gonmap 引擎，支持 Nmap 探针和指纹匹配。**新增智能调度**。 |
| **OS Finger** | 🟢 **Done** | 实现了 Nmap TCP/IP 栈指纹识别 (Loopback 优化) + 服务 Banner 辅助识别。 |
| **Web Finger** | 🟡 **Pending** | 基础架构已就绪，等待 Pipeline 集成。 |

### 1.4 Cluster Integration (集群集成) - "The Connection"
| 组件 | 状态 | 备注 |
| :--- | :--- | :--- |
| **Join Protocol** | 🟢 **Done** | CLI 参数已支持 Token，废除独立的 Join 命令。 |
| **Auth Storage** | 🟡 **Partial** | Viper 已绑定 Token，需确保持久化。 |
| **Task Pulling** | 🟡 **Legacy** | 旧版 HTTP 轮询逻辑存在，需适配新 Core。 |

---

## 2. 下一步行动 (Next Steps)

**"Stop designing. Start coding."**

### P0: Phase 4.1 - 全流程编排 (Scan Orchestration)
*   **痛点**: 目前 `scan port` 等命令只支持单 IP，不支持网段。这是因为缺乏上层调度器。
*   **目标**: 实现 `PipelineRunner` 和 `scan run` 命令，让 Agent 能自动处理网段、串联任务。
*   **行动**:
    1.  实现 `TargetGenerator`: 支持 CIDR/Range/List 解析，将网段展开为 IP 流。
    2.  实现 `Pipeline`: 串联 `AliveScan` -> `PortScan` -> `ServiceScan`。
    3.  实现 `cmd/agent/scan/run.go`: 统一的自动化扫描入口。

### P1: Phase 4.2 - 集群适配 (Cluster Adapter)
*   **目标**: 让 `neoAgent server` 使用新的 Runner。
*   **行动**:
    1.  重构 `server` 循环，使其从 Master 拉取 Task 并转换为 `model.Task`。
    2.  调用 `Runner` (或 Pipeline) 执行任务。
    3.  实现结果回传适配器。

### P2: Phase 3.6 - 高级并发优化 (Continued)
*   **目标**: 进一步压榨性能。
*   **状态**: 🟢 **部分完成 (探针调度)**
*   **行动**:
    1.  ~~优化 Service 引擎，支持 SoftMatch 加速。~~ (Done)
    2.  优化 `Runner` 接口，支持动态并发调整 (Adaptive Rate Limiting)。
    3.  引入 `RttEstimator` 动态调整超时时间。

---

## 3. 风险与阻碍 (Risks & Blockers)

*   **风险**: Pipeline 的复杂性。如何优雅地处理不同 Scanner 之间的输入输出匹配（例如 PortScanner 输出 `[]PortResult`，ServiceScanner 输入 `[]HostPort`）。
*   **阻碍**: 无。

---

## 4. 最近更新记录 (Changelog)

### [2026-01-27] Service 扫描引擎深度优化
**优化内容**:
1.  **SoftMatch 感知 (Hint Awareness)**: 重构了指纹匹配逻辑，使引擎能识别 SoftMatch 提供的线索（如 "http", "ssl"），而不仅仅是丢弃或硬返回。
2.  **动态探针调度 (Dynamic Probe Scheduling)**: 实现了 `prioritizeProbes` 算法。当识别出服务线索时，立即将相关的高频探针（如 `GetRequest`）提升至队列头部，大幅减少无效发包。
3.  **智能超时控制 (Smart Timeout)**: 将单一超时拆解为 `ConnectTimeout` (2s) 和 `ReadTimeout` (3s+)，兼顾了死端口的快速失败和慢速服务的耐心等待。

**预期收益**:
*   非标准端口（如 8080 HTTP）扫描速度提升显著，避免了遍历几十个无关探针的开销。
*   扫描准确率提升，因为更多的服务能获得针对性探针的探测。

---

**Linus's Verdict (当前裁决)**:

Phase 3 原生能力建设已完成，基础设施坚实。
现在的最大痛点是 **"只能扫单机，不能扫网段"** (除了 Alive 模块)。
这不可接受。
立即启动 **Phase 4.1**，实现 Pipeline 和 Target Generator，打通批量扫描的任督二脉。
