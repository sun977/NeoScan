# NeoScan-Agent 版本管理与构建指南

## 概述

本文档介绍 NeoScan-Agent 的版本管理和构建脚本的使用方法，包括 Windows、Linux 和 macOS 三个平台的构建和发布流程。

## 目录结构

```
neoAgent/
├── internal/
│   └── pkg/
│       └── version/
│           └── version.go          # 版本信息文件
├── cmd/
│   └── agent/
│       └── version.go             # 版本命令
├── scripts/
│   ├── windows/                  # Windows 平台脚本
│   │   ├── build.ps1            # 单平台构建
│   │   ├── build-all.ps1        # 多平台构建
│   │   └── release.ps1          # 发布脚本
│   ├── linux/                    # Linux 平台脚本
│   │   ├── build.sh             # 单平台构建
│   │   ├── build-all.sh         # 多平台构建
│   │   └── release.sh           # 发布脚本
│   └── macos/                    # macOS 平台脚本
│       ├── build.sh             # 单平台构建
│       ├── build-all.sh         # 多平台构建
│       └── release.sh           # 发布脚本
├── bin/                          # 构建输出目录
└── release/                      # 发布输出目录
```

## 版本管理

### 版本号格式

使用语义化版本（Semantic Versioning）：`MAJOR.MINOR.PATCH`

- **MAJOR**：不兼容的 API 变更（例如：1.0.0 → 2.0.0）
- **MINOR**：向后兼容的功能性新增（例如：1.0.0 → 1.1.0）
- **PATCH**：向后兼容的问题修正（例如：1.1.0 → 1.1.1）

### 版本文件

版本号定义在 `internal/pkg/version/version.go` 文件中：

```go
const (
    Version   = "2.11.0"  // 当前版本号
    APIVersion = "2.0"
)
```

### 更新版本号

手动更新版本号：

1. 打开 `internal/pkg/version/version.go`
2. 修改 `Version` 常量的值
3. 保存文件

## Windows 平台使用指南

### 环境要求

- Windows 10 或更高版本
- PowerShell 5.1 或更高版本
- Go 1.21 或更高版本
- Git（用于版本管理）

### 单平台构建

**编译当前平台（Windows amd64）**：
```powershell
.\scripts\windows\build.ps1
```

**编译 Linux amd64 版本**：
```powershell
.\scripts\windows\build.ps1 -TargetOS linux -TargetArch amd64
```

**编译 macOS ARM64 版本（Apple Silicon）**：
```powershell
.\scripts\windows\build.ps1 -TargetOS darwin -TargetArch arm64
```

**使用指定版本号编译**：
```powershell
.\scripts\windows\build.ps1 -Version 2.12.0
```

**查看帮助**：
```powershell
Get-Help .\scripts\windows\build.ps1
```

### 多平台构建

**编译所有平台版本**：
```powershell
.\scripts\windows\build-all.ps1
```

**使用指定版本号编译**：
```powershell
.\scripts\windows\build-all.ps1 -Version 2.12.0
```

**输出文件**：
- `neoAgent-2.12.0-windows-amd64.exe`
- `neoAgent-2.12.0-windows-arm64.exe`
- `neoAgent-2.12.0-linux-amd64`
- `neoAgent-2.12.0-linux-arm64`
- `neoAgent-2.12.0-darwin-amd64`
- `neoAgent-2.12.0-darwin-arm64`

### 发布新版本

**发布版本 2.12.0**：
```powershell
.\scripts\windows\release.ps1 -Version 2.12.0
```

**发布流程**：
1. 自动更新 `version.go` 文件中的版本号
2. 提交代码到 Git
3. 创建 Git Tag（v2.12.0）
4. 构建所有平台版本
5. 提示用户推送代码和 Tag

**发布后操作**：
```powershell
# 查看变更
git status

# 推送代码
git push origin main

# 推送 Tag
git push origin v2.12.0
```

## Linux 平台使用指南

### 环境要求

- Linux（推荐 Ubuntu 20.04 或更高版本）
- Bash 4.0 或更高版本
- Go 1.21 或更高版本
- Git（用于版本管理）

### 赋予执行权限

首次使用前，需要赋予脚本执行权限：

```bash
chmod +x scripts/linux/*.sh
```

### 单平台构建

**编译当前平台（Linux amd64）**：
```bash
./scripts/linux/build.sh
```

**编译 Windows amd64 版本**：
```bash
./scripts/linux/build.sh -o windows -a amd64
```

**编译 macOS ARM64 版本（Apple Silicon）**：
```bash
./scripts/linux/build.sh -o darwin -a arm64
```

**使用指定版本号编译**：
```bash
./scripts/linux/build.sh -v 2.12.0
```

**查看帮助**：
```bash
./scripts/linux/build.sh -h
```

### 多平台构建

**编译所有平台版本**：
```bash
./scripts/linux/build-all.sh
```

**使用指定版本号编译**：
```bash
./scripts/linux/build-all.sh -v 2.12.0
```

### 发布新版本

**发布版本 2.12.0**：
```bash
./scripts/linux/release.sh 2.12.0
```

**发布后操作**：
```bash
# 查看变更
git status

# 推送代码
git push origin main

# 推送 Tag
git push origin v2.12.0
```

## macOS 平台使用指南

### 环境要求

- macOS 10.15 或更高版本
- Bash 4.0 或更高版本
- Go 1.21 或更高版本
- Git（用于版本管理）

### 赋予执行权限

首次使用前，需要赋予脚本执行权限：

```bash
chmod +x scripts/macos/*.sh
```

### 单平台构建

**编译当前平台（macOS amd64）**：
```bash
./scripts/macos/build.sh
```

**编译 Windows amd64 版本**：
```bash
./scripts/macos/build.sh -o windows -a amd64
```

**编译 Linux ARM64 版本**：
```bash
./scripts/macos/build.sh -o linux -a arm64
```

**使用指定版本号编译**：
```bash
./scripts/macos/build.sh -v 2.12.0
```

**查看帮助**：
```bash
./scripts/macos/build.sh -h
```

### 多平台构建

**编译所有平台版本**：
```bash
./scripts/macos/build-all.sh
```

**使用指定版本号编译**：
```bash
./scripts/macos/build-all.sh -v 2.12.0
```

### 发布新版本

**发布版本 2.12.0**：
```bash
./scripts/macos/release.sh 2.12.0
```

**发布后操作**：
```bash
# 查看变更
git status

# 推送代码
git push origin main

# 推送 Tag
git push origin v2.12.0
```

## 版本信息查看

### 使用命令行

**查看版本信息**：
```bash
./neoAgent version
```

**输出示例**：
```
NeoScan-Agent 2.11.0
API Version: 2.0
Build Time: 2026-02-11T14:30:00Z
Git Commit: abc1234
Go Version: go1.21.5
```

### User-Agent

程序在扫描时会使用以下 User-Agent：

```
Mozilla/5.0 (compatible; NeoScan-Agent/2.11.0; +https://github.com/your-org/NeoScan) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36
```

版本号会自动从 `version.go` 文件中读取。

## 常见问题

### Q1：如何选择使用哪个平台的脚本？

**A**：根据你的开发环境选择：
- Windows 开发环境：使用 `scripts/windows/` 下的脚本
- Linux 开发环境：使用 `scripts/linux/` 下的脚本
- macOS 开发环境：使用 `scripts/macos/` 下的脚本

所有平台的脚本都可以编译所有目标平台的版本。

### Q2：为什么需要赋予执行权限？

**A**：Linux 和 macOS 的 Shell 脚本需要执行权限才能运行。Windows 的 PowerShell 脚本不需要。

### Q3：如何查看构建的版本信息？

**A**：运行编译后的程序：
```bash
./neoAgent version
```

### Q4：发布脚本会自动推送代码吗？

**A**：不会。发布脚本会：
1. 更新版本号
2. 提交代码到本地 Git
3. 创建本地 Git Tag
4. 构建所有平台版本

但不会自动推送到远程仓库，需要手动执行 `git push`。

### Q5：如何回滚版本？

**A**：
1. 查看历史版本：`git tag -l`
2. 切换到指定版本：`git checkout v2.11.0`
3. 重新构建：`./scripts/$(uname -s | tr '[:upper:]' '[:lower:]')/build-all.sh`

### Q6：构建失败怎么办？

**A**：检查以下几点：
1. Go 版本是否符合要求（1.21 或更高）
2. 依赖是否完整：`go mod tidy`
3. 网络连接是否正常（需要下载依赖）
4. 磁盘空间是否充足

## 最佳实践

### 日常开发

1. **使用单平台构建**：快速迭代开发
   ```bash
   # Windows
   .\scripts\windows\build.ps1

   # Linux/macOS
   ./scripts/linux/build.sh
   ```

2. **定期测试多平台**：确保跨平台兼容性
   ```bash
   ./scripts/linux/build-all.sh
   ```

3. **使用 Git Tag 标记里程碑**：便于版本追踪
   ```bash
   git tag v2.12.0-beta.1
   git push origin v2.12.0-beta.1
   ```

### 发布流程

1. **更新版本号**：修改 `internal/pkg/version/version.go`
2. **运行发布脚本**：自动完成发布流程
3. **推送代码和 Tag**：推送到远程仓库
4. **验证构建**：测试各个平台的二进制文件
5. **更新文档**：更新 CHANGELOG 和 README

### 版本命名规范

- **正式版本**：`v2.12.0`
- **预发布版本**：`v2.12.0-alpha.1`、`v2.12.0-beta.1`、`v2.12.0-rc.1`
- **开发版本**：不创建 Tag，使用默认版本号

## 总结

- **版本管理**：使用语义化版本，集中管理在 `version.go`
- **构建脚本**：每个平台都有独立的构建脚本
- **发布流程**：自动化发布流程，简化操作
- **跨平台支持**：支持 Windows、Linux、macOS 的 amd64 和 arm64 架构
- **版本信息**：通过 `version` 命令查看，User-Agent 自动包含版本号

如有问题，请参考各平台脚本的帮助信息或查看项目文档。
