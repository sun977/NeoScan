
# Agent 的扫描流程

## v1.0 基础线性流程 (Linear Flow)
*适用场景：早期原子能力验证，简单任务串联。*

```mermaid
graph TD
    A[输入目标] --> B{目标类型判断}
    B -->|CIDR| C[转换为IP列表]
    B -->|域名| D[解析IP]
    B -->|单个IP| E[存活检测]
    C --> E
    D --> E
    
    E --> F{主机存活?}
    F -->|存活| G[端口扫描]
    F -->|不存活| H[跳过]
    
    G --> I[服务识别]
    I --> J{是否开启应用识别?}
    J -->|是| K[应用指纹识别]
    J -->|是| R[操作系统识别]
    J -->|是| L[漏洞检测]
    J -->|是| M[暴力破解]
    J -->|否| N[结束]
    
    K --> N
    R --> N
    L --> N
    M --> N
    H --> N
```

---

## v2.0 并行分发编排流程 (Parallel Orchestration Flow)
*演进原因：*
1.  **性能瓶颈**: v1.0 的线性流程导致 Web 扫描（慢速）阻塞了其他无关服务（如 MySQL）的检测，资源利用率低。
2.  **风控需求**: 爆破与漏洞扫描同时进行可能触发目标防火墙，需要精细的优先级控制。
3.  **架构解耦**: 引入 "Dispatcher" 概念，将基础探测（Phase 1）与攻击面评估（Phase 2）解耦，支持更复杂的依赖管理。

### 核心变更
*   **Phase 1 (串行)**: 基础信息收集 (Alive -> Port -> Service)，确保数据准确性。
*   **Phase 2 (并行)**: 基于 Service 结果进行**并行分发**，Web、漏洞、爆破互不阻塞。
*   **优先级控制**: 引入 `Vuln First, Brute Last` 策略，降低攻击噪音。

```mermaid
flowchart TD
    subgraph "Phase 1: 基础探测 (Sequential)"
        A["输入目标"] --> B["主机存活探测 (Alive)"]
        B -->|Alive IPs| C["端口与服务识别 (PortService)"]
        C -->|Service Results| D{"服务分发器 Dispatcher"}
    end

    subgraph "Phase 2: 攻击面评估 (Parallel Dispatch)"
        D -->|HTTP/HTTPS| E["Web 分析队列"]
        D -->|Service Match Tags| F["漏洞扫描队列"]
        D -->|Supported Proto| G["爆破扫描队列"]

        subgraph "WorkerPool [Worker Pool]"
            E -->|Worker| H["WebScanner"]
            F -->|Worker - High Priority| I["NucleiScanner"]
            G -->|Worker - Low Priority| J["BruteScanner"]
        end
    end

    H -.->|Web Fingerprints| I
    I -.->|Dependency: Vuln First| J
    
    H --> K["结果汇总"]
    I --> K
    J --> K

```
