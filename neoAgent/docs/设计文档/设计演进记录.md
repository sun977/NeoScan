# NeoAgent è®¾è®¡æ¼”è¿›è®°å½•

## 2025-10-21: Agent è¿è¡Œæ¨¡å¼é‡æ„ â€”â€” ä» "Worker" åˆ° "Standalone + Cluster"

### 1. æ¼”è¿›èƒŒæ™¯ (Context)

**åŸå§‹è®¾è®¡**:
Agent è¢«å®šä¹‰ä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿçš„æœ«ç«¯æ‰§è¡Œå•å…ƒï¼Œå®Œå…¨ä¾èµ– Master èŠ‚ç‚¹çš„è°ƒåº¦ã€‚
- å¯åŠ¨å³ç›‘å¬ HTTP/gRPC ç«¯å£ã€‚
- ä»»åŠ¡æ¥æºå•ä¸€ï¼šä»…æ¥å— Master ä¸‹å‘çš„ä»»åŠ¡ã€‚
- ç»“æœå»å‘å•ä¸€ï¼šä»…å›ä¼ ç»™ Masterã€‚

**æ–°éœ€æ±‚**:
ä¸ºäº†æé«˜å®ç”¨æ€§å’Œçµæ´»æ€§ï¼ŒAgent éœ€è¦æ”¯æŒç‹¬ç«‹è¿è¡Œæ¨¡å¼ï¼ˆStandalone Modeï¼‰ã€‚
- æ”¯æŒ CLI å‘½ä»¤è¡Œç›´æ¥å‘èµ·æ‰«æï¼ˆå¦‚ `./neoAgent scan -t 1.1.1.1`ï¼‰ã€‚
- å¼€å‘è°ƒè¯•æ—¶æ— éœ€å¯åŠ¨å®Œæ•´çš„ Master é›†ç¾¤ã€‚
- æ”¯æŒä½œä¸ºå•æœºå®‰å…¨å·¥å…·åˆ†å‘ã€‚

### 2. æ ¸å¿ƒå®¡æŸ¥ (Linus Philosophy Check)

#### 2.1 Good Taste (å“å‘³)
- **ç°çŠ¶**: ä¸šåŠ¡é€»è¾‘ï¼ˆScanning Serviceï¼‰ä¸é€šä¿¡å±‚ï¼ˆHTTP Serverï¼‰è€¦åˆè¿‡ç´§ã€‚
- **æ”¹è¿›**: å°†æ ¸å¿ƒæ‰«æé€»è¾‘å‰¥ç¦»ä¸ºçº¯ç²¹çš„ `Core Service`ï¼Œæ—¢å¯è¢« HTTP Handler è°ƒç”¨ï¼Œä¹Ÿå¯è¢« CLI Command è°ƒç”¨ã€‚
- **ç»“è®º**: è¿™ç§åˆ†å±‚æ›´æ¸…æ™°ï¼Œæé«˜äº†ä»£ç å¤ç”¨æ€§ï¼Œç¬¦åˆé«˜å†…èšä½è€¦åˆçš„åŸåˆ™ã€‚

#### 2.2 Pragmatism (å®ç”¨ä¸»ä¹‰)
- **è§£å†³çš„é—®é¢˜**:
    1.  å¼€å‘è°ƒè¯•ç¹çï¼šæµ‹è¯•æ‰«æé€»è¾‘éœ€è¦å¯åŠ¨å…¨å¥—é›†ç¾¤ã€‚
    2.  ä½¿ç”¨åœºæ™¯å—é™ï¼šæ— æ³•ä½œä¸ºè½»é‡çº§å·¥å…·åœ¨ç°åœºç¯å¢ƒå¿«é€Ÿä½¿ç”¨ã€‚
- **ç»“è®º**: è¿™æ˜¯ä¸€ä¸ªè§£å†³çœŸå®ç—›ç‚¹çš„æ”¹åŠ¨ï¼Œè€Œéè¿‡åº¦è®¾è®¡ã€‚

#### 2.3 Never Break Userspace (å‘åå…¼å®¹)
- **çº¦æŸ**: ç°æœ‰çš„éƒ¨ç½²è„šæœ¬å’Œ Master äº¤äº’åè®®ä¸èƒ½å› æœ¬æ¬¡æ”¹åŠ¨è€Œå¤±æ•ˆã€‚
- **æ–¹æ¡ˆ**: `neoAgent` ä¸å¸¦å‚æ•°è¿è¡Œæ—¶ï¼Œé»˜è®¤è¡Œä¸ºä¿æŒä¸ºå¯åŠ¨ Server æ¨¡å¼ï¼ˆCluster Workerï¼‰ï¼Œç¡®ä¿ç°æœ‰ç³»ç»Ÿæ— ç¼å…¼å®¹ã€‚

### 3. æ¶æ„æ¼”è¿›æ–¹æ¡ˆ (Architecture Evolution)

#### 3.1 æ€»ä½“æ¶æ„è°ƒæ•´

**Before:**
```text
Main -> App (HTTP Server) -> Router -> Handler -> Service -> Executor
(Service å±‚ä¸¥é‡ä¾èµ– Web ä¸Šä¸‹æ–‡)
```

**After:**
```text
Main (Cobra Entry)
 â”œâ”€â”€ "server" command (Default) -> Starts HTTP Server -> Calls Core Service
 â””â”€â”€ "scan" command             -> Parses CLI Flags   -> Calls Core Service
      
Shared Core (internal/core)
 â””â”€â”€ Service -> Executor
(Service å±‚çº¯ç²¹åŒ–ï¼Œä¸å†æ„ŸçŸ¥æ˜¯ HTTP è¯·æ±‚è¿˜æ˜¯ CLI å‘½ä»¤)
```

#### 3.2 å…³é”®æŠ½è±¡

**1. è¾“å…¥ç»Ÿä¸€ (Input Abstraction)**
å»ºç«‹ç»Ÿä¸€çš„ `Task Builder` æœºåˆ¶ï¼š
- **Cluster Mode**: HTTP JSON Body -> `Task Struct`
- **CLI Mode**: CLI Flags (`--target`, `--port`) -> `Task Struct`
æ ¸å¿ƒ Service åªè®¤ `Task Struct`ï¼Œä¸å…³å¿ƒæ¥æºã€‚

**2. è¾“å‡ºè§£è€¦ (Output Abstraction)**
å®šä¹‰ `Reporter` æ¥å£ï¼š
```go
type Reporter interface {
    Report(result *model.TaskResult) error
}
```
- **ClusterReporter**: åºåˆ—åŒ– -> HTTP POST -> Master
- **ConsoleReporter**: æ ¼å¼åŒ– (Table/JSON) -> Stdout
- **FileReporter**: åºåˆ—åŒ– -> Save to File

#### 3.3 ç›®å½•ç»“æ„è§„åˆ’

å»ºè®®è°ƒæ•´ `cmd` å’Œ `internal` ç»“æ„ä»¥é€‚åº”æ–°æ¶æ„ï¼š

```text
neoAgent/
â”œâ”€â”€ cmd/agent/
â”‚   â”œâ”€â”€ main.go          # Cobra Root Command (å…¥å£)
â”‚   â”œâ”€â”€ server.go        # Server æ¨¡å¼å®ç° (åŸ main é€»è¾‘)
â”‚   â””â”€â”€ scan.go          # CLI æ¨¡å¼å®ç° (æ–°é€»è¾‘)
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ core/            # æ ¸å¿ƒä¸šåŠ¡ (åŸ Service å‰¥ç¦»)
â”‚   â”‚   â”œâ”€â”€ scanner.go   # çº¯æ‰«æé€»è¾‘
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ server/          # HTTP/gRPC ç›¸å…³ (åŸ Handler/Router)
â”‚   â””â”€â”€ cli/             # CLI è¾…åŠ©å·¥å…· (å‚æ•°è§£æã€ç»“æœæ‰“å°)
```

### 4. å®æ–½è·¯çº¿å›¾

1.  **Refactor Core**: å°† `internal/app/agent` ä¸­çš„ Service é€»è¾‘è§£è€¦ï¼Œç§»é™¤å¯¹ `gin.Context` ç­‰ Web ç»„ä»¶çš„ä¾èµ–ã€‚
2.  **Introduce Cobra**: å¼•å…¥ Cobra åº“æ¥ç®¡ `main.go`ï¼Œå°†åŸå¯åŠ¨é€»è¾‘å°è£…ä¸º Root Commandã€‚
3.  **Implement CLI**: å®ç° `scan` å­å‘½ä»¤ï¼Œå®Œæˆå‚æ•°è§£æåˆ° Task çš„æ˜ å°„ã€‚
4.  **Verify**: ç¡®ä¿ `./neoAgent` é»˜è®¤è¡Œä¸ºä¸å˜ï¼Œ`./neoAgent scan` å¯ç‹¬ç«‹å·¥ä½œã€‚

---

## 2025-10-21: Agent æ³¨å†Œæ¥å…¥æœºåˆ¶ â€”â€” Token + CA Hash

### 1. éœ€æ±‚åˆ†æ
ä¸ºäº†è®© Standalone æ¨¡å¼çš„ Agent èƒ½å¤Ÿå¹³æ»‘ã€å®‰å…¨åœ°æ¥å…¥ Clusterï¼Œéœ€è¦ä¸€ä¸ªæ ‡å‡†åŒ–çš„æ³¨å†Œæµç¨‹ã€‚
**å®‰å…¨ç—›ç‚¹**:
- Master å¦‚ä½•éªŒè¯æ¥å…¥çš„ Agent èº«ä»½ï¼Ÿ(AuthN)
- Agent å¦‚ä½•éªŒè¯è¿æ¥çš„ Master èº«ä»½ï¼Ÿ(é˜²æ­¢ MITM)
- å¦‚ä½•é¿å…å¤æ‚çš„ PKI è¯ä¹¦åˆ†å‘æµç¨‹ï¼Ÿ

### 2. æ–¹æ¡ˆè®¾è®¡ (The Join Protocol)

é‡‡ç”¨ç±»ä¼¼ Kubernetes `kubeadm join` çš„ **Join Token** æœºåˆ¶ã€‚

#### 2.1 æ ¸å¿ƒæµç¨‹
1.  **Token Generation**: ç®¡ç†å‘˜åœ¨ Master ç”Ÿæˆæœ‰æ—¶æ•ˆæ€§çš„ Tokenã€‚
2.  **Join Request**: Agent ä½¿ç”¨ Token å‘èµ· HTTPS è¯·æ±‚ã€‚
3.  **Credential Exchange**: Master éªŒè¯é€šè¿‡åï¼Œé¢å‘é•¿æœŸæœ‰æ•ˆçš„ä¸“å±å‡­è¯ï¼ˆAgentID + APIKey/Certï¼‰ã€‚
4.  **Persistence**: Agent ä¿å­˜å‡­è¯ï¼Œåç»­é€šä¿¡ä¸å†ä¾èµ– Tokenã€‚

#### 2.2 CLI è®¾è®¡
```bash
neoAgent join <master-addr> --token <token> [--ca-cert-hash <hash>]
```
- `--token`: é—¨ç¥¨ï¼Œç”¨å®Œå³ç„šï¼ˆæˆ–è¿‡æœŸå¤±æ•ˆï¼‰ã€‚
- `--ca-cert-hash`: Master èº«ä»½æŒ‡çº¹ï¼Œé˜²æ­¢ä¸­é—´äººæ”»å‡»ã€‚

### 3. å†³ç­–è®°å½•
- **æ”¾å¼ƒ** å¤æ‚çš„ CSR (è¯ä¹¦ç­¾åè¯·æ±‚) æ‰‹åŠ¨å®¡æ‰¹æµç¨‹ï¼Œæ”¹ä¸º Token è‡ªåŠ¨å®¡æ‰¹ã€‚
- **æ”¾å¼ƒ** é¢„å…±äº«é•¿æœŸå¯†é’¥ (Pre-shared Key) æ¨¡å¼ï¼Œå› ä¸ºéš¾ä»¥æ’¤é”€å’Œå®¡è®¡ã€‚
- **é‡‡çº³** "ä¿¡ä»»é¦–æ¬¡ä½¿ç”¨" (TOFU) çš„å˜ä½“ â€”â€” é¦–æ¬¡è¿æ¥æ—¶é€šè¿‡ Token äº’ä¿¡ï¼Œä¹‹ååˆ‡æ¢åˆ°å¼ºè®¤è¯ã€‚

è¯¦ç»†è§„èŒƒå‚è§: [Agentæ³¨å†Œæµç¨‹è¯´æ˜.md](../Agentæ³¨å†Œæµç¨‹è¯´æ˜.md)

---

## 2025-10-21: æ‰«æèƒ½åŠ›å»ºè®¾ â€”â€” Build vs Buy å†³ç­–

### 1. æ ¸å¿ƒé—®é¢˜
Agent ä½œä¸ºä¸€ä¸ªæ‰«æå™¨ï¼Œæ˜¯åº”è¯¥å®Œå…¨ä¾èµ–å¤–éƒ¨å·¥å…·ï¼ˆå¦‚ Nmap, Nucleiï¼‰ï¼Œè¿˜æ˜¯åº”è¯¥åŸç”Ÿå®ç°æ‰«æèƒ½åŠ›ï¼Ÿ

### 2. å†³ç­–æ ‡å‡† (Native First, Wrapper Second)

ä¸ºäº†å…¼é¡¾æ€§èƒ½ã€éƒ¨ç½²ä¾¿æ·æ€§å’Œç”Ÿæ€ä¸°å¯Œåº¦ï¼Œé‡‡ç”¨ **æ··åˆæ¨¡å¼ (Hybrid Mode)**ã€‚

#### 2.1 åŸºç¡€åŸå­èƒ½åŠ› (Must Build Native)
**å®šä¹‰**: é€»è¾‘ç®€å•ã€åè®®æ ‡å‡†ã€æ— éœ€åºå¤§è§„åˆ™åº“çš„é«˜é¢‘æ“ä½œã€‚
**å†³ç­–**: **Go åŸç”Ÿå®ç°**ã€‚
- **Host Discovery**: ICMP/ARP/TCP Ping (é¿å…è°ƒç”¨ç³»ç»Ÿ ping å‘½ä»¤)ã€‚
- **Port Scan**: SYN/Connect Scan (Go é«˜å¹¶å‘ä¼˜åŠ¿)ã€‚
- **Service Banner**: ç®€å•çš„ Socket è¯»å†™å’Œæ­£åˆ™åŒ¹é…ã€‚
- **Web Fingerprint**: åŸºäº HTTP Header/Body çš„å…³é”®è¯åŒ¹é…ã€‚
- **Proxy/Tunnel**: SOCKS5/HTTP ä»£ç†æœåŠ¡ (Go æ ‡å‡†åº“ä¼˜åŠ¿)ã€‚

#### 2.2 å¤æ‚åè®®èƒ½åŠ› (Build if Possible)
**å®šä¹‰**: åè®®äº¤äº’å¤æ‚ä½†è§„åˆ™å›ºå®šçš„æ“ä½œã€‚
**å†³ç­–**: **ä¼˜å…ˆ Go åŸç”Ÿå®ç°**ã€‚
- **Brute Force**: SSH/Redis/MySQL/PostgreSQL ç­‰å¸¸è§æœåŠ¡ä½¿ç”¨ Go å®˜æ–¹/ç¤¾åŒºé©±åŠ¨è¿›è¡Œçˆ†ç ´ã€‚

#### 2.3 ç”Ÿæ€ä¾èµ–èƒ½åŠ› (Must Wrap)
**å®šä¹‰**: æ ¸å¿ƒä»·å€¼åœ¨äºåºå¤§çš„ã€é«˜é¢‘æ›´æ–°çš„è§„åˆ™åº“/POCåº“ã€‚
**å†³ç­–**: **å¤–éƒ¨å·¥å…·è°ƒç”¨ (Wrapper)**ã€‚
- **Vulnerability Scanning**: è°ƒç”¨ `Nuclei` (äºŒè¿›åˆ¶æˆ–åº“)ã€‚
- **Reason**: é¿å…é‡å¤é€ è½®å­ç»´æŠ¤æµ·é‡ POCã€‚

### 3. æ¶æ„è°ƒæ•´
åœ¨ `internal/core` ä¸­å¼•å…¥ `Provider` æ¨¡å¼ï¼Œå…è®¸åŒæ—¶å­˜åœ¨åŸç”Ÿå®ç°å’Œå¤–éƒ¨å·¥å…·å°è£…ã€‚

```go
type PortScanner interface {
    Scan(target string, ports []int) ([]Result, error)
}
// ä¼˜å…ˆä½¿ç”¨ Native
type NativePortScanner struct {} 
// ç‰¹æ®Šæƒ…å†µä½¿ç”¨ Nmap
type NmapPortScanner struct {}
```

---

## 2025-10-21: ç¬¬ä¸‰æ–¹å·¥å…·é›†æˆç­–ç•¥ â€”â€” Battery Included

### 1. æ ¸å¿ƒç†å¿µ
**"Battery Included, but Plug-in Compatible"**
Agent åº”è¿½æ±‚æè‡´çš„ **å•æ–‡ä»¶éƒ¨ç½² (Single Binary)** ä½“éªŒã€‚

### 2. é›†æˆæ¸…å•ä¸å†³ç­–

#### 2.1 ğŸš« æ‹’ç»è°ƒç”¨ (Native Replacement)
- **Masscan/Fscan**: åŠŸèƒ½ç®€å•ï¼ŒGo åŸç”Ÿå®ç°æ›´ä¼˜ã€‚
- **HTTPx/Dirsearch/Webçˆ¬è™«**: ç›´æ¥å¼•ç”¨ Go åº“æˆ–åŸç”Ÿå®ç°ã€‚

#### 2.2 âš ï¸ è°¨æ…è°ƒç”¨ (Optional Wrapper)
- **Nmap**: ä»…åœ¨éœ€è¦æ·±åº¦ OS æŒ‡çº¹è¯†åˆ«æ—¶å¯é€‰å¼€å¯ã€‚
- **Hydra**: ä»…åœ¨éœ€è¦çˆ†ç ´å†·é—¨åè®®æ—¶å¯é€‰å¼€å¯ã€‚

#### 2.3 âœ… å¿…é¡»é›†æˆ (Core Integration)
- **Nuclei**: æ ¸å¿ƒæ¼æ´æ‰«æå¼•æ“ã€‚
- **Chromium**: ç°ä»£ Web æ‰«æ (Headless)ã€‚
- **Yara**: æ¶æ„è½¯ä»¶æ£€æµ‹ã€‚

è¯¦ç»†è§„èŒƒå‚è§: [ç¬¬ä¸‰æ–¹æ‰«æå·¥å…·è°ƒç”¨.md](../ç¬¬ä¸‰æ–¹æ‰«æå·¥å…·è°ƒç”¨.md)
