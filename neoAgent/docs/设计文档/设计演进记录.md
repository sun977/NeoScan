# NeoAgent 设计演进记录

## 2025-10-21: Agent 运行模式重构 —— 从 "Worker" 到 "Standalone + Cluster"

### 1. 演进背景 (Context)

**原始设计**:
Agent 被定义为分布式系统的末端执行单元，完全依赖 Master 节点的调度。
- 启动即监听 HTTP/gRPC 端口。
- 任务来源单一：仅接受 Master 下发的任务。
- 结果去向单一：仅回传给 Master。

**新需求**:
为了提高实用性和灵活性，Agent 需要支持独立运行模式（Standalone Mode）。
- 支持 CLI 命令行直接发起扫描（如 `./neoAgent scan -t 1.1.1.1`）。
- 开发调试时无需启动完整的 Master 集群。
- 支持作为单机安全工具分发。

### 2. 核心审查 (Linus Philosophy Check)

#### 2.1 Good Taste (品味)
- **现状**: 业务逻辑（Scanning Service）与通信层（HTTP Server）耦合过紧。
- **改进**: 将核心扫描逻辑剥离为纯粹的 `Core Service`，既可被 HTTP Handler 调用，也可被 CLI Command 调用。
- **结论**: 这种分层更清晰，提高了代码复用性，符合高内聚低耦合的原则。

#### 2.2 Pragmatism (实用主义)
- **解决的问题**:
    1.  开发调试繁琐：测试扫描逻辑需要启动全套集群。
    2.  使用场景受限：无法作为轻量级工具在现场环境快速使用。
- **结论**: 这是一个解决真实痛点的改动，而非过度设计。

#### 2.3 Never Break Userspace (向后兼容)
- **约束**: 现有的部署脚本和 Master 交互协议不能因本次改动而失效。
- **方案**: `neoAgent` 不带参数运行时，默认行为保持为启动 Server 模式（Cluster Worker），确保现有系统无缝兼容。

### 3. 架构演进方案 (Architecture Evolution)

#### 3.1 总体架构调整

**Before:**
```text
Main -> App (HTTP Server) -> Router -> Handler -> Service -> Executor
(Service 层严重依赖 Web 上下文)
```

**After:**
```text
Main (Cobra Entry)
 ├── "server" command (Default) -> Starts HTTP Server -> Calls Core Service
 └── "scan" command             -> Parses CLI Flags   -> Calls Core Service
      
Shared Core (internal/core)
 └── Service -> Executor
(Service 层纯粹化，不再感知是 HTTP 请求还是 CLI 命令)
```

#### 3.2 关键抽象

**1. 输入统一 (Input Abstraction)**
建立统一的 `Task Builder` 机制：
- **Cluster Mode**: HTTP JSON Body -> `Task Struct`
- **CLI Mode**: CLI Flags (`--target`, `--port`) -> `Task Struct`
核心 Service 只认 `Task Struct`，不关心来源。

**2. 输出解耦 (Output Abstraction)**
定义 `Reporter` 接口：
```go
type Reporter interface {
    Report(result *model.TaskResult) error
}
```
- **ClusterReporter**: 序列化 -> HTTP POST -> Master
- **ConsoleReporter**: 格式化 (Table/JSON) -> Stdout
- **FileReporter**: 序列化 -> Save to File

#### 3.3 目录结构规划

建议调整 `cmd` 和 `internal` 结构以适应新架构：

```text
neoAgent/
├── cmd/agent/
│   ├── main.go          # Cobra Root Command (入口)
│   ├── server.go        # Server 模式实现 (原 main 逻辑)
│   └── scan.go          # CLI 模式实现 (新逻辑)
├── internal/
│   ├── core/            # 核心业务 (原 Service 剥离)
│   │   ├── scanner.go   # 纯扫描逻辑
│   │   └── ...
│   ├── server/          # HTTP/gRPC 相关 (原 Handler/Router)
│   └── cli/             # CLI 辅助工具 (参数解析、结果打印)
```

### 4. 实施路线图

1.  **Refactor Core**: 将 `internal/app/agent` 中的 Service 逻辑解耦，移除对 `gin.Context` 等 Web 组件的依赖。
2.  **Introduce Cobra**: 引入 Cobra 库接管 `main.go`，将原启动逻辑封装为 Root Command。
3.  **Implement CLI**: 实现 `scan` 子命令，完成参数解析到 Task 的映射。
4.  **Verify**: 确保 `./neoAgent` 默认行为不变，`./neoAgent scan` 可独立工作。

---

## 2025-10-21: Agent 注册接入机制 —— Token + CA Hash

### 1. 需求分析
为了让 Standalone 模式的 Agent 能够平滑、安全地接入 Cluster，需要一个标准化的注册流程。
**安全痛点**:
- Master 如何验证接入的 Agent 身份？(AuthN)
- Agent 如何验证连接的 Master 身份？(防止 MITM)
- 如何避免复杂的 PKI 证书分发流程？

### 2. 方案设计 (The Join Protocol)

采用类似 Kubernetes `kubeadm join` 的 **Join Token** 机制。

#### 2.1 核心流程
1.  **Token Generation**: 管理员在 Master 生成有时效性的 Token。
2.  **Join Request**: Agent 使用 Token 发起 HTTPS 请求。
3.  **Credential Exchange**: Master 验证通过后，颁发长期有效的专属凭证（AgentID + APIKey/Cert）。
4.  **Persistence**: Agent 保存凭证，后续通信不再依赖 Token。

#### 2.2 CLI 设计
```bash
neoAgent join <master-addr> --token <token> [--ca-cert-hash <hash>]
```
- `--token`: 门票，用完即焚（或过期失效）。
- `--ca-cert-hash`: Master 身份指纹，防止中间人攻击。

### 3. 决策记录
- **放弃** 复杂的 CSR (证书签名请求) 手动审批流程，改为 Token 自动审批。
- **放弃** 预共享长期密钥 (Pre-shared Key) 模式，因为难以撤销和审计。
- **采纳** "信任首次使用" (TOFU) 的变体 —— 首次连接时通过 Token 互信，之后切换到强认证。

详细规范参见: [Agent注册流程说明.md](../Agent注册流程说明.md)
