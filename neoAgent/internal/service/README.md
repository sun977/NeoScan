# Service Layer (ä¸šåŠ¡æœåŠ¡å±‚)

## æ¨¡å—æ€»è§ˆ
Service å±‚æ˜¯ Agent çš„å¤§è„‘ï¼Œè´Ÿè´£å¤„ç†æ‰€æœ‰çš„ä¸šåŠ¡é€»è¾‘ã€‚æ ¹æ®é€šä¿¡æ–¹å‘ï¼Œå¯ä»¥æ¸…æ™°åœ°åˆ†ä¸ºä¸¤ç±»ï¼š**å‡ºç«™æœåŠ¡ (Outbound)** å’Œ **å…¥ç«™æœåŠ¡ (Inbound)**ã€‚

---

## 1. å‡ºç«™æœåŠ¡ (Outbound Services)
**æ–¹å‘**ï¼šAgent -> Master
**æ ¸å¿ƒèŒè´£**ï¼šä¸»åŠ¨å‘ Master æ±‡æŠ¥æ•°æ®ï¼Œæ‹‰å–ä»»åŠ¡ã€‚è¿™æ˜¯ Agent çš„"æ—¥å¸¸å·¥ä½œ"ã€‚

### `client` (é€šä¿¡æœåŠ¡)
*   **çŠ¶æ€**ï¼šâœ… å·²å®ç° (éƒ¨åˆ†)
*   **èŒè´£**ï¼š
    *   **æ³¨å†Œä¸è®¤è¯**ï¼šå¯åŠ¨æ—¶å‘ Master æŠ¥åˆ°ã€‚
    *   **å¿ƒè·³ç»´æŒ**ï¼šå‘Šè¯‰ Master "æˆ‘è¿˜æ´»ç€"ã€‚
    *   **ä»»åŠ¡æ‹‰å– (Poll)**ï¼šä¸»åŠ¨è¯¢é—® "æœ‰æ´»å¹²å—ï¼Ÿ"ã€‚
    *   **ç»“æœä¸ŠæŠ¥**ï¼šå¹²å®Œæ´»åæäº¤æŠ¥å‘Šã€‚
*   **å…³é”®æ–‡ä»¶**ï¼š`internal/service/client/master_service.go`

---

## 2. å…¥ç«™æœåŠ¡ (Inbound Services)
**æ–¹å‘**ï¼šMaster -> Agent
**æ ¸å¿ƒèŒè´£**ï¼šå“åº” Master çš„è¿œç¨‹è°ƒç”¨ã€‚è¿™æ˜¯ Agent çš„"è¢«åŠ¨å“åº”"ï¼Œé€šå¸¸ç”¨äºç´§æ€¥æ§åˆ¶æˆ–å®æ—¶ç›‘æ§ã€‚
**ä¾èµ–**ï¼šéœ€è¦ Agent å¼€å¯ HTTP Serverã€‚

### `control` (æ§åˆ¶æœåŠ¡)
*   **çŠ¶æ€**ï¼šğŸ“ è§„åˆ’ä¸­ (Placeholder)
*   **èŒè´£**ï¼š**è¿œç¨‹é¥æ§å™¨**
    *   **è¿›ç¨‹æ§åˆ¶**ï¼šè¿œç¨‹é‡å¯ã€åœæ­¢ Agent è¿›ç¨‹ (ç´§æ€¥ç†”æ–­)ã€‚
    *   **é…ç½®çƒ­æ›´æ–°**ï¼šä¸é‡å¯è¿›ç¨‹çš„æƒ…å†µä¸‹åŠ¨æ€è°ƒæ•´é…ç½®ã€‚
    *   **ç‰ˆæœ¬å‡çº§**ï¼šæ¥æ”¶å‡çº§æŒ‡ä»¤ï¼Œè‡ªæˆ‘æ›´æ–°ã€‚
*   **å…³é”®æ–‡ä»¶**ï¼š`internal/service/control/agent_control.go`

### `monitor` (ç›‘æ§æœåŠ¡)
*   **çŠ¶æ€**ï¼šğŸ“ è§„åˆ’ä¸­ (Placeholder)
*   **èŒè´£**ï¼š**å®æ—¶ä»ªè¡¨ç›˜**
    *   **æŒ‡æ ‡æš´éœ²**ï¼šæä¾› `/metrics` æ¥å£ä¾› Prometheus æˆ– Master æ‹‰å–å®æ—¶æ€§èƒ½æ•°æ® (CPU/Mem)ã€‚
    *   **å¥åº·æ£€æŸ¥**ï¼šæä¾› `/health` æ¥å£ï¼Œç”¨äºè´Ÿè½½å‡è¡¡å™¨æˆ– K8s æ¢é’ˆã€‚
    *   **æ—¥å¿—æŸ¥è¯¢**ï¼šå…è®¸ Master è¿œç¨‹æŸ¥çœ‹æœ€è¿‘çš„è¿è¡Œæ—¥å¿—ï¼ˆç”¨äºæ’é”™ï¼‰ã€‚
*   **å…³é”®æ–‡ä»¶**ï¼š`internal/service/monitor/agent_monitor.go`

### `task` (ä»»åŠ¡ç®¡ç†æœåŠ¡)
*   **çŠ¶æ€**ï¼šğŸ“ è§„åˆ’ä¸­ (Placeholder)
*   **èŒè´£**ï¼š**ä»»åŠ¡æŒ‡æŒ¥å¡”**
    *   **ä»»åŠ¡æŸ¥è¯¢**ï¼šMaster æŸ¥è¯¢å½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡åˆ—è¡¨ã€‚
    *   **ç´§æ€¥åœæ­¢**ï¼šMaster å¼ºåˆ¶å–æ¶ˆæŸä¸ªæ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ (ä¾‹å¦‚ä»»åŠ¡å¯¼è‡´ç›®æ ‡æœåŠ¡å´©æºƒ)ã€‚
    *   **ä»»åŠ¡æš‚åœ/æ¢å¤**ï¼šåŠ¨æ€è°ƒæ•´ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€ã€‚
*   **å…³é”®æ–‡ä»¶**ï¼š`internal/service/task/agent_task.go`

---

## 3. é€‚é…å±‚ (Adapter)
**æ ¸å¿ƒèŒè´£**ï¼š**å¤–äº¤å®˜ (é˜²è…å±‚)**
*   **çŠ¶æ€**ï¼šâœ… å·²å®ç°
*   **èŒè´£**ï¼šè´Ÿè´£å°† Master çš„é€šä¿¡åè®® (JSON/DTO) è½¬æ¢ä¸º Agent å†…éƒ¨çš„æ ¸å¿ƒæ¨¡å‹ (`internal/core/model`)ã€‚
*   **ä½ç½®**ï¼š`internal/service/adapter`
*   **ä»·å€¼**ï¼šç¡®ä¿æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ä¸å—å¤–éƒ¨åè®®å˜æ›´çš„å½±å“ã€‚

---

## æ¶æ„æ€»ç»“

```mermaid
graph TD
    subgraph "Master Side"
        Master[NeoMaster]
    end

    subgraph "Agent Service Layer"
        direction TB
        
        subgraph "Outbound (ä¸»åŠ¨æ±‡æŠ¥)"
            Client[Client Service] -->|Register/Heartbeat/Poll| Master
        end
        
        subgraph "Inbound (è¢«åŠ¨å“åº”)"
            Master -->|Control Cmd| Control[Control Service]
            Master -->|Health/Metrics| Monitor[Monitor Service]
            Master -->|Cancel Task| TaskSvc[Task Service]
        end
        
        Adapter[Adapter Layer]
    end
```

**Linus çš„è¯„ä»·**ï¼š
è¿™ç§**åŒå‘é€šä¿¡è®¾è®¡**æ˜¯ä¼ä¸šçº§ Agent çš„æ ‡é…ã€‚
*   **Client** ä¿è¯äº†åŸºç¡€çš„ç¨³å®šæ€§ï¼ˆåªè¦èƒ½è¿ç½‘å°±èƒ½å·¥ä½œï¼‰ã€‚
*   **Server (Inbound Services)** æä¾›äº†é«˜çº§çš„å¯è¿ç»´æ€§ï¼ˆå®æ—¶æ§åˆ¶ã€ç´§æ€¥å¹²é¢„ï¼‰ã€‚
ç¼ºä¸€ä¸å¯ã€‚
