openapi: 3.0.3
info:
  title: NeoMaster - Agent 高级统计与分析 API
  version: 1.0.0
  description: |
    基于 Router 与 Handler 现状生成，仅包含只读分析接口：统计、负载均衡、性能分析、容量分析。
    - 路由：internal/app/master/router/agent_routers.go:67-70
    - Handler：internal/handler/agent/analysis.go
servers:
  - url: /api/v1
tags:
  - name: Agent-Analysis
    description: Agent 高级统计与分析
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  parameters:
    GroupIdParam:
      name: group_id
      in: query
      required: false
      schema:
        type: string
      description: 限定到指定分组ID
    WindowSecondsParam:
      name: window_seconds
      in: query
      required: false
      schema:
        type: integer
        minimum: 1
        default: 180
      description: 统计窗口（秒）
    TopNParam:
      name: top_n
      in: query
      required: false
      schema:
        type: integer
        minimum: 1
        default: 5
      description: 返回TopN数量
    CPUThresholdParam:
      name: cpu_threshold
      in: query
      required: false
      schema:
        type: number
        format: float
        default: 80
      description: CPU 过载阈值（%）
    MemoryThresholdParam:
      name: memory_threshold
      in: query
      required: false
      schema:
        type: number
        format: float
        default: 80
      description: 内存过载阈值（%）
    DiskThresholdParam:
      name: disk_threshold
      in: query
      required: false
      schema:
        type: number
        format: float
        default: 80
      description: 磁盘过载阈值（%）
  schemas:
    APIResponseBase:
      type: object
      properties:
        code:
          type: integer
        status:
          type: string
          description: success 或 error/failed
        message:
          type: string
        error:
          type: string
          nullable: true
    AgentWorkStatus:
      type: string
      enum: [idle, working, exception]
    AggregatedPerformance:
      type: object
      properties:
        cpu_avg: { type: number, format: float }
        cpu_max: { type: number, format: float }
        cpu_min: { type: number, format: float }
        memory_avg: { type: number, format: float }
        memory_max: { type: number, format: float }
        memory_min: { type: number, format: float }
        disk_avg: { type: number, format: float }
        disk_max: { type: number, format: float }
        disk_min: { type: number, format: float }
        running_tasks_total: { type: integer }
        completed_tasks_total: { type: integer }
        failed_tasks_total: { type: integer }
    AgentStatisticsResponse:
      type: object
      properties:
        total_agents: { type: integer }
        online_agents: { type: integer }
        offline_agents: { type: integer }
        work_status_distribution:
          type: object
          additionalProperties:
            type: integer
        scan_type_distribution:
          type: object
          additionalProperties:
            type: integer
        performance:
          $ref: '#/components/schemas/AggregatedPerformance'
    AgentLoadItem:
      type: object
      properties:
        agent_id: { type: string }
        cpu_usage: { type: number, format: float }
        memory_usage: { type: number, format: float }
        running_tasks: { type: integer }
        load_score: { type: number, format: float }
        work_status: { $ref: '#/components/schemas/AgentWorkStatus' }
        scan_type: { type: string }
        timestamp: { type: string, format: date-time }
    AgentLoadBalanceResponse:
      type: object
      properties:
        top_busy_agents:
          type: array
          items: { $ref: '#/components/schemas/AgentLoadItem' }
        top_idle_agents:
          type: array
          items: { $ref: '#/components/schemas/AgentLoadItem' }
        advice: { type: string }
    AgentPerformanceItem:
      type: object
      properties:
        agent_id: { type: string }
        cpu_usage: { type: number, format: float }
        memory_usage: { type: number, format: float }
        disk_usage: { type: number, format: float }
        network_bytes_sent: { type: integer }
        network_bytes_recv: { type: integer }
        failed_tasks: { type: integer }
        timestamp: { type: string, format: date-time }
    AgentPerformanceAnalysisResponse:
      type: object
      properties:
        aggregated: { $ref: '#/components/schemas/AggregatedPerformance' }
        top_cpu:
          type: array
          items: { $ref: '#/components/schemas/AgentPerformanceItem' }
        top_memory:
          type: array
          items: { $ref: '#/components/schemas/AgentPerformanceItem' }
        top_network:
          type: array
          items: { $ref: '#/components/schemas/AgentPerformanceItem' }
        top_failed:
          type: array
          items: { $ref: '#/components/schemas/AgentPerformanceItem' }
    AgentCapacityItem:
      type: object
      properties:
        agent_id: { type: string }
        cpu_usage: { type: number, format: float }
        memory_usage: { type: number, format: float }
        disk_usage: { type: number, format: float }
        reason: { type: string, description: 'cpu|memory|disk' }
        timestamp: { type: string, format: date-time }
    AgentCapacityAnalysisResponse:
      type: object
      properties:
        online_agents: { type: integer }
        overloaded_agents: { type: integer }
        cpu_threshold: { type: number, format: float }
        memory_threshold: { type: number, format: float }
        disk_threshold: { type: number, format: float }
        average_headroom: { type: number, format: float }
        capacity_score: { type: number, format: float }
        bottlenecks:
          type: object
          additionalProperties:
            type: integer
        recommendations: { type: string }
        overloaded_list:
          type: array
          items: { $ref: '#/components/schemas/AgentCapacityItem' }
    APIResponse_AgentStatistics:
      allOf:
        - $ref: '#/components/schemas/APIResponseBase'
        - type: object
          properties:
            data:
              $ref: '#/components/schemas/AgentStatisticsResponse'
    APIResponse_AgentLoadBalance:
      allOf:
        - $ref: '#/components/schemas/APIResponseBase'
        - type: object
          properties:
            data:
              $ref: '#/components/schemas/AgentLoadBalanceResponse'
    APIResponse_AgentPerformanceAnalysis:
      allOf:
        - $ref: '#/components/schemas/APIResponseBase'
        - type: object
          properties:
            data:
              $ref: '#/components/schemas/AgentPerformanceAnalysisResponse'
    APIResponse_AgentCapacityAnalysis:
      allOf:
        - $ref: '#/components/schemas/APIResponseBase'
        - type: object
          properties:
            data:
              $ref: '#/components/schemas/AgentCapacityAnalysisResponse'
    APIResponse_Error:
      allOf:
        - $ref: '#/components/schemas/APIResponseBase'
paths:
  /agent/statistics:
    get:
      tags: [Agent-Analysis]
      summary: 获取Agent统计信息
      description: 基于 agent_metrics 快照计算在线数量、状态分布、性能聚合等
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WindowSecondsParam'
        - $ref: '#/components/parameters/GroupIdParam'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIResponse_AgentStatistics'
              examples:
                default:
                  value:
                    code: 200
                    status: success
                    message: OK
                    data:
                      total_agents: 12
                      online_agents: 10
                      offline_agents: 2
                      work_status_distribution: { idle: 6, working: 4, exception: 0 }
                      scan_type_distribution: { fullPortScan: 3, webScan: 2, idle: 7 }
                      performance:
                        cpu_avg: 23.5
                        cpu_max: 88.1
                        cpu_min: 1.2
                        memory_avg: 41.3
                        memory_max: 92.0
                        memory_min: 8.3
                        disk_avg: 58.1
                        disk_max: 79.5
                        disk_min: 15.2
                        running_tasks_total: 5
                        completed_tasks_total: 132
                        failed_tasks_total: 3
        '400':
          description: 参数错误
          content:
            application/json:
              schema: { $ref: '#/components/schemas/APIResponse_Error' }
        '401':
          description: 未授权
        '500':
          description: 服务器错误
          content:
            application/json:
              schema: { $ref: '#/components/schemas/APIResponse_Error' }
  /agent/load-balance:
    get:
      tags: [Agent-Analysis]
      summary: 获取Agent负载均衡信息
      description: 计算并返回高负载TopN与低负载TopN，以及调度建议
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WindowSecondsParam'
        - $ref: '#/components/parameters/TopNParam'
        - $ref: '#/components/parameters/GroupIdParam'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIResponse_AgentLoadBalance'
              examples:
                default:
                  value:
                    code: 200
                    status: success
                    message: OK
                    data:
                      top_busy_agents:
                        - agent_id: a-01
                          cpu_usage: 82.3
                          memory_usage: 77.2
                          running_tasks: 3
                          load_score: 171.0
                          work_status: working
                          scan_type: fullPortScan
                          timestamp: 2025-11-17T08:00:00Z
                      top_idle_agents:
                        - agent_id: a-07
                          cpu_usage: 3.2
                          memory_usage: 8.1
                          running_tasks: 0
                          load_score: 5.7
                          work_status: idle
                          scan_type: idle
                          timestamp: 2025-11-17T08:00:00Z
                      advice: 优先将新任务调度到负载较低的Agent；对高负载Agent限流或延迟分配。
        '400':
          description: 参数错误
          content:
            application/json:
              schema: { $ref: '#/components/schemas/APIResponse_Error' }
        '401':
          description: 未授权
        '500':
          description: 服务器错误
          content:
            application/json:
              schema: { $ref: '#/components/schemas/APIResponse_Error' }
  /agent/performance:
    get:
      tags: [Agent-Analysis]
      summary: 获取Agent性能分析
      description: 返回聚合性能与多维TopN（CPU/内存/网络/失败任务）
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WindowSecondsParam'
        - $ref: '#/components/parameters/TopNParam'
        - $ref: '#/components/parameters/GroupIdParam'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIResponse_AgentPerformanceAnalysis'
              examples:
                default:
                  value:
                    code: 200
                    status: success
                    message: OK
                    data:
                      aggregated:
                        cpu_avg: 31.2
                        cpu_max: 90.4
                        cpu_min: 2.1
                        memory_avg: 49.5
                        memory_max: 93.1
                        memory_min: 7.4
                        disk_avg: 55.0
                        disk_max: 82.9
                        disk_min: 20.3
                        running_tasks_total: 7
                        completed_tasks_total: 280
                        failed_tasks_total: 5
                      top_cpu:
                        - agent_id: a-03
                          cpu_usage: 90.4
                          memory_usage: 71.3
                          disk_usage: 62.1
                          network_bytes_sent: 12400
                          network_bytes_recv: 5600
                          failed_tasks: 0
                          timestamp: 2025-11-17T08:00:00Z
        '400':
          description: 参数错误
          content:
            application/json:
              schema: { $ref: '#/components/schemas/APIResponse_Error' }
        '401':
          description: 未授权
        '500':
          description: 服务器错误
          content:
            application/json:
              schema: { $ref: '#/components/schemas/APIResponse_Error' }
  /agent/capacity:
    get:
      tags: [Agent-Analysis]
      summary: 获取Agent容量分析
      description: 返回容量评分、瓶颈分布与过载明细
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WindowSecondsParam'
        - $ref: '#/components/parameters/GroupIdParam'
        - $ref: '#/components/parameters/CPUThresholdParam'
        - $ref: '#/components/parameters/MemoryThresholdParam'
        - $ref: '#/components/parameters/DiskThresholdParam'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIResponse_AgentCapacityAnalysis'
              examples:
                default:
                  value:
                    code: 200
                    status: success
                    message: OK
                    data:
                      online_agents: 10
                      overloaded_agents: 2
                      cpu_threshold: 80
                      memory_threshold: 80
                      disk_threshold: 80
                      average_headroom: 42.6
                      capacity_score: 42.6
                      bottlenecks: { cpu: 1, memory: 1, disk: 0 }
                      recommendations: 容量总体健康
                      overloaded_list:
                        - agent_id: a-02
                          cpu_usage: 88.1
                          memory_usage: 79.2
                          disk_usage: 70.3
                          reason: cpu
                          timestamp: 2025-11-17T08:00:00Z
        '400':
          description: 参数错误
          content:
            application/json:
              schema: { $ref: '#/components/schemas/APIResponse_Error' }
        '401':
          description: 未授权
        '500':
          description: 服务器错误
          content:
            application/json:
              schema: { $ref: '#/components/schemas/APIResponse_Error' }