
æ ¹æ®å¯¹ä»£ç åº“çš„æ·±åº¦æ‰«æï¼Œä»¥ä¸‹æ˜¯æœ¬æ¬¡é‡æ„çš„**ç ´åæ€§è¯„ä¼°æŠ¥å‘Š**åŠ**ä¿®å¤æ–¹æ¡ˆ**ã€‚

### ğŸš¨ æ ¸å¿ƒè¯„ä¼°ç»“è®º
**å½±å“èŒƒå›´ï¼šHigh (é«˜)**
é‡æ„å°†ç›´æ¥â€œç²‰ç¢â€ç°æœ‰çš„ Agent åˆ†ç»„é€»è¾‘å’Œæ ‡ç­¾å­˜å‚¨é€»è¾‘ã€‚è¿™ä¸ä»…æ˜¯ä»£ç æ”¹åŠ¨ï¼Œæ›´æ˜¯æ•°æ®æ¨¡å‹çš„æ ¹æœ¬æ€§è¿ç§»ã€‚
æ¶‰åŠæ–‡ä»¶æ•°ï¼šçº¦ **8-10** ä¸ªå…³é”®æ–‡ä»¶ã€‚
å—å½±å“æ¨¡å—ï¼š`Model`, `Repository`, `Service`, `Handler`, `Tests`ã€‚

---

### 1. å—å½±å“ä»£ç æ¸…å• (The "Blast Radius")

#### A. æ•°æ®æ¨¡å‹ (Models)
*   **`neomaster/internal/model/agent/agent.go`** (åŠç›¸å…³æ–‡ä»¶)
    *   `Agent` ç»“æ„ä½“: å­—æ®µ `Tags` (`json`) å’Œ `Capabilities` (`json`) å°†è¢«åºŸå¼ƒã€‚
    *   `AgentGroup` ç»“æ„ä½“: **å°†è¢«å®Œå…¨åˆ é™¤**ã€‚
    *   `AgentGroupMember` ç»“æ„ä½“: **å°†è¢«å®Œå…¨åˆ é™¤**ã€‚
*   **`agent_scan_types` è¡¨**: éœ€è¦æ–°å¢ `tag_id` å­—æ®µã€‚

#### B. æ•°æ®è®¿é—®å±‚ (Repository)
*   **`neomaster/internal/repo/mysql/agent/agent_repo.go`**
    *   **æ‰€æœ‰åˆ†ç»„ç›¸å…³æ–¹æ³•å¤±æ•ˆ**: `CreateGroup`, `UpdateGroup`, `GetGroupList`, `IsAgentInGroup` ç­‰ã€‚
    *   **æ‰€æœ‰æ ‡ç­¾ç›¸å…³æ–¹æ³•å¤±æ•ˆ**: `AddTag`, `RemoveTag`, `GetTags` (ç›®å‰åŸºäº JSON æ“ä½œ)ã€‚

#### C. ä¸šåŠ¡é€»è¾‘å±‚ (Service)
*   **`neomaster/internal/service/agent/agent_manager_service.go`**
    *   åˆ†ç»„ç®¡ç†é€»è¾‘éœ€è¦é‡å†™ï¼Œæ”¹ä¸ºè°ƒç”¨ `TagService`ã€‚
    *   Agent åˆ—è¡¨æŸ¥è¯¢é€»è¾‘ï¼ˆæŒ‰æ ‡ç­¾/åˆ†ç»„ç­›é€‰ï¼‰éœ€è¦é‡å†™ï¼Œæ”¹ä¸ºåŸºäº `sys_entity_tags` çš„ JOIN æŸ¥è¯¢ã€‚
*   **`neomaster/internal/service/agent/agent_monitor_service.go`** (æˆ–å¿ƒè·³å¤„ç†é€»è¾‘)
    *   Agent å¿ƒè·³ä¸ŠæŠ¥ Capabilities çš„é€»è¾‘éœ€è¦ä¿®æ”¹ï¼Œä¸å†æ›´æ–° JSONï¼Œè€Œæ˜¯è°ƒç”¨ `TagService.SyncEntityTags`ã€‚

#### D. æ¥å£å±‚ (Handler)
*   **`neomaster/internal/handler/agent/agent_handler.go`**
    *   `/groups` ç›¸å…³ API éœ€è¦é‡æ–°æ˜ å°„åˆ°æ ‡ç­¾ç³»ç»Ÿã€‚
    *   `/tags` ç›¸å…³ API éœ€è¦é‡æ–°æ˜ å°„ã€‚

#### E. æµ‹è¯• (Tests)
*   **`test/20251114/20251114_Agent_GroupManagement_test.go`**: è¿™ä¸ªæµ‹è¯•æ–‡ä»¶å°†å®Œå…¨æŠ¥åºŸï¼Œéœ€è¦é‡å†™ã€‚

---

### 2. è§£å†³æ–¹æ¡ˆ (The Fix Strategy)

ä¸ºäº†ä¿è¯ "Never break userspace" (å°½é‡ä¿æŒ API å…¼å®¹æ€§)ï¼Œå»ºè®®é‡‡å–ä»¥ä¸‹ç­–ç•¥ï¼š

#### æ­¥éª¤ 1: åŸºç¡€è®¾æ–½å‡†å¤‡ (Infrastructure)
1.  ä¿®æ”¹ `AgentScanType` æ¨¡å‹ï¼Œå¢åŠ  `TagID`ã€‚
2.  åœ¨æ•°æ®åº“ä¸­æ‰§è¡Œè¿ç§»ï¼š
    *   å°† `AgentGroup` æ•°æ®è¿ç§»ä¸º `SysTag` (Category='agent_group')ã€‚
    *   å°† `Agent` çš„ `tags/capabilities` JSON æ•°æ®è¿ç§»åˆ° `sys_entity_tags`ã€‚

#### æ­¥éª¤ 2: æœåŠ¡å±‚å«æ¥ (Service Bridging)
**ä¸è¦ä¿®æ”¹ Repository å»ä¾èµ– TagRepo** (é‚£æ˜¯åæ¨¡å¼)ã€‚
åœ¨ `AgentManagerService` ä¸­æ³¨å…¥ `TagService`ã€‚

*   **åˆ†ç»„æ“ä½œé‡å®šå‘**:
    *   ç”¨æˆ·è°ƒç”¨ `CreateGroup("WebServers")` -> æœåŠ¡å±‚è°ƒç”¨ `TagService.CreateTag("/AgentGroup/WebServers")`ã€‚
*   **è¯»å–æ“ä½œå…¼å®¹**:
    *   åœ¨ `GetAgent` æ—¶ï¼Œå¦‚æœå‰ç«¯è¿˜éœ€è¦ `tags` å­—æ®µï¼ŒæœåŠ¡å±‚éœ€è¦æ‰‹åŠ¨è°ƒç”¨ `TagService.GetTagsByEntity`ï¼Œç„¶åå¡«å……åˆ° DTO (Data Transfer Object) ä¸­è¿”å›ç»™å‰ç«¯ã€‚**è¿™æ ·å‰ç«¯ API ä¸ä¼šå´©ã€‚**

#### æ­¥éª¤ 3: æ ¸å¿ƒé€»è¾‘æ›¿æ¢
*   **å¿ƒè·³ä¸ŠæŠ¥**:
    *   ä¿®æ”¹ `MonitorService`ï¼Œæ”¶åˆ° Agent å¿ƒè·³åï¼Œè§£æ Capabilitiesï¼Œè°ƒç”¨ `TagService.SyncEntityTags(..., "agent_report")`ã€‚

#### æ­¥éª¤ 4: æ¸…ç† (Cleanup)
*   åˆ é™¤ `Agent` è¡¨ä¸­çš„ JSON å­—æ®µã€‚
*   åˆ é™¤ `AgentGroup` è¡¨ã€‚

---

### 3. ç°åœ¨çš„è¡ŒåŠ¨è®¡åˆ’

**ä½ åŒæ„å¼€å§‹æ‰§è¡Œå—ï¼Ÿ** å¦‚æœåŒæ„ï¼Œæˆ‘å°†æŒ‰ä»¥ä¸‹é¡ºåºæ“ä½œï¼š
1.  **ä¿®æ”¹ Model**: è°ƒæ•´ `AgentScanType`ï¼Œæ ‡è®° `Agent` ä¸­çš„å­—æ®µä¸ºåºŸå¼ƒï¼ˆæˆ–ç›´æ¥åˆ é™¤ï¼‰ã€‚ã€è¿›è¡Œä¸­ï¼šScanTypeå·²åŠ TagIDï¼ŒAgentå­—æ®µæœªåˆ ã€‘
2.  **é‡æ„ Service**: ä¿®æ”¹ `AgentManagerService`ï¼Œå¼•å…¥ `TagService` ä¾èµ–ï¼Œæ›¿æ¢åˆ†ç»„é€»è¾‘ã€‚ã€å·²å®Œæˆï¼šåˆ†ç»„é€»è¾‘å·²ç§»é™¤ï¼Œè½¬ä¸ºTagèšåˆã€‘
3.  **ä¿®å¤ Repository**: åˆ é™¤æ— æ•ˆçš„ CRUD æ–¹æ³•ã€‚ã€å·²å®Œæˆï¼šåˆ é™¤äº†åˆ†ç»„Repoï¼Œå¢åŠ äº†Tagç­›é€‰æ”¯æŒã€‘

### 4. å‰©ä½™ä»»åŠ¡æ¸…å• (Pending Tasks)
1.  **[High] å¿ƒè·³èƒ½åŠ›åŒæ­¥**: ä¿®æ”¹ `monitor.go`ï¼Œå®ç°å¿ƒè·³ä¸ŠæŠ¥æ—¶è‡ªåŠ¨åŒæ­¥ `Capabilities` åˆ° `SysTag`ã€‚
2.  **[High] æ•°æ®è¿ç§»**: ç¼–å†™è„šæœ¬å°†æ—§ `AgentGroup` æ•°æ®è¿ç§»åˆ° `SysTag`ï¼Œå°†æ—§ `tags/capabilities` JSON è¿ç§»åˆ° `sys_entity_tags`ã€‚
3.  **[Medium] ScanType å¼•å¯¼**: å®ç° Master å¯åŠ¨æ—¶è‡ªåŠ¨æ£€æŸ¥å¹¶åˆ›å»º `ScanType` å¯¹åº”çš„ `SysTag`ã€‚
4.  **[Low] æœ€ç»ˆæ¸…ç†**: åˆ é™¤ `Agent` è¡¨ä¸­çš„ `tags` å’Œ `capabilities` å­—æ®µåŠç›¸å…³ä»£ç ã€‚