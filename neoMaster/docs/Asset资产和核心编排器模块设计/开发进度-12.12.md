# å¼€å‘è¿›åº¦è¯„ä¼° (æˆªè‡³ 2026-01-07)

åŸºäºé‡æ„æ–¹æ¡ˆä¸ä»£ç å®¡è®¡ï¼Œå½“å‰æ§åˆ¶é¢ï¼ˆControl Planeï¼‰çš„æ•´ä½“å®Œæˆåº¦å·²è¾¾åˆ° **90%**ï¼Œæ•°æ®é¢ï¼ˆData Planeï¼‰çš„"å·¦åŠè¾¹"ï¼ˆç›®æ ‡ç”Ÿæˆï¼‰ä¹Ÿå·²å®Œæˆã€‚ç›®å‰çš„ç³»ç»Ÿå·²ç»å…·å¤‡äº†å®Œæ•´çš„**ä»»åŠ¡è°ƒåº¦ã€ç­–ç•¥æ§åˆ¶ä¸åˆ†å‘èƒ½åŠ›**ï¼Œå¹¶æ”¯æŒçœŸæ­£çš„ **DAG å¹¶è¡Œæ‰§è¡Œ**ã€‚

æ•°æ®é¢ï¼ˆData Planeï¼‰çš„"å³åŠè¾¹"ï¼ˆç»“æœå›æµä¸æ¸…æ´—ï¼‰æ­£åœ¨å¿«é€Ÿæ¨è¿›ï¼ŒETL Merger æ ¸å¿ƒé€»è¾‘å·²å®Œæˆï¼ŒMapper åŸºç¡€æ¡†æ¶å·²å°±ç»ªã€‚

### 1. æ¨¡å—è¯¦ç»†è¯„ä¼°

| ç»„ä»¶ | å­æ¨¡å— | çŠ¶æ€ | è¯„ä¼°è¯¦æƒ… |
| :--- | :--- | :--- | :--- |
| **1.1 Orchestrator** | **ScheduleManager** | âœ… **å·²å®Œæˆ** | åŸºäº Cron çš„å®šæ—¶è§¦å‘é€»è¾‘å·²å®ç°ï¼ŒåŠŸèƒ½å®Œå¤‡ã€‚ |
| | **TransitionEngine** | âœ… **å·²å®Œæˆ** | **æ ¸å¿ƒäº®ç‚¹**: å®Œæ•´å®ç°äº†åŸºäº Predecessors çš„ DAG ä¾èµ–è§£æã€‚<br>**é‡å¤§æ”¹è¿›**: ç§»é™¤äº†å…¨å±€ Barrier (`hasRunning`) é™åˆ¶ã€‚ç³»ç»Ÿç°åœ¨æ”¯æŒçœŸæ­£çš„ç‰©ç†å¹¶è¡Œâ€”â€”å½“åˆ†æ”¯ A å®Œæˆæ—¶ï¼Œä¾èµ– A çš„åç»­ Stage ä¼šç«‹å³å¯åŠ¨ï¼Œæ— éœ€ç­‰å¾…åˆ†æ”¯ B (Long-running) å®Œæˆã€‚ |
| | **TaskGenerator** | âœ… **å·²å®Œæˆ** | å®ç°äº†åˆ†å— (`ChunkSize`)ã€ä¼˜å…ˆçº§è®¾ç½®å’Œ `AgentTask` çš„ç”Ÿæˆã€‚ |
| | **TaskDispatcher** | âœ… **å·²å®Œæˆ** | å®ç°äº†åŸºäº Pull æ¨¡å¼çš„ä»»åŠ¡åˆ†å‘ï¼Œé›†æˆäº†èµ„æºä¸ç­–ç•¥æ£€æŸ¥ï¼Œå…·å¤‡ CAS é˜²æŠ¢å æœºåˆ¶ã€‚ |
| **1.2 Policy Enforcer** | **ScopeValidator** | âœ… **å·²å®Œæˆ** | å®ç°äº†åŸºäº CIDRã€IPã€åŸŸåçš„èŒƒå›´åˆè§„æ£€æŸ¥ã€‚ |
| | **WhitelistChecker** | âœ… **å·²å®Œæˆ** | æ”¯æŒå¤šç»´åº¦çš„ç™½åå•é˜»æ–­ç­–ç•¥ã€‚ |
| | **SkipLogicEvaluator** | âœ… **å·²å®Œæˆ** | **äº®ç‚¹**: é›†æˆäº† `Matcher` å¼•æ“ï¼Œæ”¯æŒå¤æ‚çš„åŠ¨æ€è·³è¿‡è§„åˆ™ï¼ˆå¦‚æ—¶é—´çª—+ç¯å¢ƒæ ‡ç­¾ç»„åˆï¼‰ã€‚ |
| **1.3 Resource Allocator** | **AgentSelector** | ğŸŸ¡ **éƒ¨åˆ†å®Œæˆ** | å®ç°äº†åŸºäº Tag å’Œ Capability çš„åŒ¹é…æ¡†æ¶ã€‚ä½† `hasCapability` ç›®å‰ä¸»è¦ä¾èµ–æ¨¡æ‹Ÿæ•°æ®ï¼Œéœ€å¯¹æ¥çœŸå®çš„ Agent èƒ½åŠ›ä¸ŠæŠ¥ã€‚ |
| | **RateLimiter** | ğŸŸ¡ **éƒ¨åˆ†å®Œæˆ** | å®ç°äº†å¯¹ Agent çš„é¢‘ç‡é™åˆ¶ï¼ˆä¿æŠ¤ Masterï¼‰ã€‚**ç¼ºå¤±**: é’ˆå¯¹æ‰«æç›®æ ‡ IP æ®µçš„å…¨å±€é™é€Ÿï¼ˆä¿æŠ¤ç›®æ ‡ç½‘ç»œï¼‰ã€‚ |
| **3.1 Result Ingestor** | **ResultQueue** | âœ… **å·²å®Œæˆ** | å®ç°äº†åŸºäºå†…å­˜çš„ç¼“å†²é˜Ÿåˆ—ï¼Œå…·å¤‡å®¹é‡é™åˆ¶å’Œå‰Šå³°å¡«è°·èƒ½åŠ›ï¼Œå¹¶æ”¯æŒé…ç½®åŒ–ã€‚ |
| | **ResultValidator** | âœ… **å·²å®Œæˆ** | å®ç°äº†åŸºç¡€å­—æ®µæ ¡éªŒã€TaskID å­˜åœ¨æ€§æ£€æŸ¥ä»¥åŠ Agent èº«ä»½åˆæ³•æ€§éªŒè¯ã€‚ |
| | **EvidenceArchiver** | âœ… **å·²å®Œæˆ** | å®ç°äº†åŸºäºæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿçš„åŸå§‹è¯æ®å½’æ¡£ï¼Œæ”¯æŒæŒ‰ Task/Type/Timestamp ç»“æ„åŒ–å­˜å‚¨ã€‚ |
| | **ResultService** | âœ… **å·²å®Œæˆ** | å®ç°äº† SubmitResult æ ¸å¿ƒæµç¨‹ï¼šæ ¡éªŒ -> å½’æ¡£ -> å…¥é˜Ÿã€‚ |
| **2.1 Target Provider** | **Sources** | âœ… **å·²å®Œæˆ** | å®ç°äº† `Manual`, `File`, `Database`, `PreviousStage` (Pipelineæ ¸å¿ƒ) ç­‰å¤šç§ç›®æ ‡æºã€‚ |
| | **Logic** | âœ… **å·²å®Œæˆ** | å®Œæ•´çš„è§£æ -> å±€éƒ¨ç™½åå• -> å±€éƒ¨è·³è¿‡ -> å»é‡æµç¨‹ã€‚ |
| **3.2 Asset ETL Engine** | **Processor Framework** | âœ… **å·²å®Œæˆ** | `ResultProcessor` åç¨‹æ± æ¡†æ¶å·²å®ç°ï¼Œæ”¯æŒ Consumer æ¨¡å¼ã€‚ |
| | **Mapper** | âœ… **å·²å®Œæˆ** | `MapToAssetBundle` å·²å®ç°ï¼Œæ”¯æŒ IP/Port/Service ç­‰æ ¸å¿ƒç±»å‹çš„æ˜ å°„é€»è¾‘ã€‚å¾…æ‰©å±•æ›´å¤š ResultTypeã€‚ |
| | **Fingerprint Integration** | âœ… **å·²å®Œæˆ** | `FingerprintService` é›†æˆå·²å®Œæˆï¼Œæ”¯æŒ Agent ä¼˜å…ˆ + Master è¡¥å……çš„åŒé‡ç­–ç•¥ã€‚ |
| | **Merger** | âœ… **å·²å®Œæˆ** | å®ç°äº† Host/Service/Web/WebDetail çš„ Upsert é€»è¾‘ï¼›å®ç°äº† `syncToUnified`ï¼Œç¡®ä¿ Unified è¡¨ä¸èµ„äº§è¡¨åŒæ­¥ã€‚ |
| | **WebCrawlerDataHandler** | âœ… **å·²å®Œæˆ** | `Handle` æ–¹æ³•å·²å®ç°ï¼Œæ”¯æŒ Base64 æˆªå›¾è§£ç å­˜å‚¨ã€HTML Hash è®¡ç®—ä¸å»é‡ã€‚ |

### 2. ä¸‹ä¸€æ­¥å¼€å‘å»ºè®®

æ ¹æ® "é‡æ„è·¯çº¿å›¾ (Implementation Path)"ï¼Œç›®å‰ç³»ç»Ÿå¤„äº **Phase 4: The Cleaner (æ•°æ®æ¸…æ´—ä¸é—­ç¯)** çš„æ”»åšé˜¶æ®µã€‚

**æ¨èæ ¸å¿ƒä»»åŠ¡ï¼šå®Œæˆ Master-Agent æŒ‡çº¹åŒæ­¥æœºåˆ¶**

**å…·ä½“å¼€å‘ä»»åŠ¡æ¸…å•ï¼š**

1.  **Asset ETL Engine (æ”¶å°¾)**:
    *   **å•å…ƒæµ‹è¯•**: æ ¸å¿ƒé€»è¾‘ `Merger`, `WebCrawler`, `Mapper` å·²é€šè¿‡å•å…ƒæµ‹è¯•éªŒè¯ã€‚
    *   **Mapper æ‰©å±•**: `mapWebEndpoint` å·²å®ç°ã€‚å‰©ä½™ `mapVulnFinding` ç­‰æ˜ å°„é€»è¾‘å¾…è¡¥å……ã€‚

2.  **Master-Agent æŒ‡çº¹åŒæ­¥æœºåˆ¶**:
    *   **API å®ç°**: å®ç° Master ç«¯çš„æŒ‡çº¹ç‰ˆæœ¬æŸ¥è¯¢ä¸è§„åˆ™ä¸‹è½½æ¥å£ã€‚
    *   **è§„åˆ™ç®¡ç†**: ç¡®ä¿ Master ç«¯çš„æŒ‡çº¹åº“ (DB/File) æ˜¯æœ€æ–°çš„ï¼Œå¹¶ç»´æŠ¤ç‰ˆæœ¬å·ã€‚

3.  **Tool Adapter Layer (å·¥å…·é€‚é…)**:
    *   **API å®ç°**: å®ç° Master ç«¯çš„æŒ‡çº¹ç‰ˆæœ¬æŸ¥è¯¢ä¸è§„åˆ™ä¸‹è½½æ¥å£ã€‚
    *   **è§„åˆ™ç®¡ç†**: ç¡®ä¿ Master ç«¯çš„æŒ‡çº¹åº“ (DB/File) æ˜¯æœ€æ–°çš„ï¼Œå¹¶ç»´æŠ¤ç‰ˆæœ¬å·ã€‚

3.  **Tool Adapter Layer (å·¥å…·é€‚é…)**:
    *   **Command Factory**: å®ç° Nmap/Masscan ç­‰å·¥å…·çš„å‘½ä»¤æ¨¡æ¿ç”Ÿæˆã€‚
    *   **Output Normalizer**: ç¡®ä¿ Agent ä¸ŠæŠ¥çš„ JSON æ ¼å¼ä¸ Master çš„ Mapper å…¼å®¹ã€‚

**å†³ç­–**: ä¼˜å…ˆå®Œæˆ **WebCrawlerDataHandler** å’Œ **mapWebEndpoint**ï¼Œæ‰“é€š Web èµ„äº§çš„å…¥åº“æµç¨‹ï¼Œä»è€Œå®Œæˆæ•´ä¸ª Data Plane çš„é—­ç¯ã€‚
