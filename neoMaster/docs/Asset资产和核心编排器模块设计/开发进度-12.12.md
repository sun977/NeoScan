# 开发进度评估 (截至 2026-01-14)

基于重构方案与代码审计，当前控制面（Control Plane）的整体完成度约 **95%**：Orchestrator 已实现真正的 **DAG 并行执行**（基于 `Predecessors` 依赖解析），并且调度链路已具备 **目标解析 -> 策略拦截 -> 任务生成 -> Pull 分发 -> CAS 认领** 的完整闭环。

数据面（Data Plane）方面："左半边"（目标生成）已完成；"右半边"（结果回流与清洗）已具备 **摄入 + 队列 + Worker 框架 + Host/Service/Web/Unified 入库主链路**，并且 ETL Processor 已接入应用启动链路（随 Scheduler/LocalAgent 一起启动）。同时已补齐 **Vuln 真正落库与关联**、并重做了 **Web 与 WebDetail 的数据结构**（不再依赖“有 WebID 才写 Detail”）。

**最新进展 (2026-01-14)**:
- **Code Hygiene**: 完成了核心模块 (`rule_manager`) 的文件操作标准化，统一使用 `utils` 包，消除了对已弃用 `io/ioutil` 的依赖，提升了代码的可维护性。
- **ETL 错误处理闭环**: 实现了完整的 DLQ (Dead Letter Queue) 机制。失败任务不再静默丢弃，而是降级为 `AssetETLError` 并支持通过 API 重放。
- **Mapper 覆盖率**: 核心扫描类型 (`ip_alive`, `port_scan`, `fingerprint`, `vuln`, `poc`, `web`, `password`) 已全部支持，边缘类型 (`proxy`, `directory` 等) 已在代码层面显式标记为跳过 (Explicit Skip)，等待专属表设计。
- **指纹治理**: 离线指纹匹配逻辑 (`FingerprintMatcher`) 已就绪，支持从 Service 表提取数据进行再识别。

### 1. 模块详细评估

| 组件 | 子模块 | 状态 | 评估详情 |
| :--- | :--- | :--- | :--- |
| **1.1 Orchestrator** | **ScheduleManager** | ✅ **已完成** | 基于 Cron 的定时触发逻辑已实现，功能完备。 |
| | **TransitionEngine** | ✅ **已完成** | **核心亮点**: 完整实现了基于 Predecessors 的 DAG 依赖解析。<br>**重大改进**: 移除了全局 Barrier (`hasRunning`) 限制。系统现在支持真正的物理并行——当分支 A 完成时，依赖 A 的后续 Stage 会立即启动，无需等待分支 B (Long-running) 完成。 |
| | **TaskGenerator** | ✅ **已完成** | 实现了分块 (`ChunkSize`)、优先级设置和 `AgentTask` 的生成。 |
| | **TaskDispatcher** | ✅ **已完成** | 实现了基于 Pull 模式的任务分发，集成了资源与策略检查，具备 CAS 防抢占机制。 |
| **1.2 Policy Enforcer** | **ScopeValidator** | ✅ **已完成** | 实现了基于 CIDR、IP、域名的范围合规检查。 |
| | **WhitelistChecker** | ✅ **已完成** | 支持多维度的白名单阻断策略。 |
| | **SkipLogicEvaluator** | ✅ **已完成** | 集成了 `Matcher` 引擎，支持复杂的动态跳过规则（当前实现以 MatchRule 为主，时间窗/环境标签未进入生效逻辑）。 |
| **1.3 Resource Allocator** | **AgentSelector** | 🟡 **部分完成** | 实现了基于 Tag 和 Capability 的匹配框架。但 `hasCapability` 目前主要依赖模拟数据，需对接真实的 Agent 能力上报。 |
| | **RateLimiter** | 🟡 **部分完成** | 实现了对 Agent 的频率限制（保护 Master）。**缺失**: 针对扫描目标 IP 段的全局限速（保护目标网络）。 |
| **3.1 Result Ingestor** | **ResultQueue** | ✅ **已完成** | 实现了基于内存的缓冲队列，具备容量限制和削峰填谷能力，并支持配置化。 |
| | **ResultValidator** | ✅ **已完成** | 实现了基础字段校验、TaskID 存在性检查以及 Agent 身份合法性验证。 |
| | **EvidenceArchiver** | ✅ **已完成** | 实现了基于本地文件系统的原始证据归档，支持按 Task/Type/Timestamp 结构化存储。 |
| | **ResultService** | ✅ **已完成** | 实现了 SubmitResult 核心流程：校验 -> 归档 -> 入队。 |
| **2.1 Target Provider** | **Sources** | ✅ **已完成** | 实现了 `Manual`, `File`, `Database`, `PreviousStage` (Pipeline核心) 等多种目标源。 |
| | **Logic** | ✅ **已完成** | 完整的解析 -> 局部白名单 -> 局部跳过 -> 去重流程。 |
| **3.2 Asset ETL Engine** | **Processor Framework** | ✅ **已完成** | `ResultProcessor` 协程池框架已实现，已接入应用启动链路，**架构调整**: 已移除指纹识别依赖，回归纯粹的数据清洗与入库职责。 |
| | **Mapper** | ✅ **大部分完成** | `MapToAssetBundle` 分发框架已完成。核心支持: `ip_alive`, `port_scan`, `service_fingerprint`, `vuln_finding`, `poc_scan`, `web_endpoint`, `password_audit`。<br>**显式跳过**: `proxy`, `directory`, `subdomain`, `api`, `file` (待专门表设计)。 |
| | **Error Policy** | ✅ **已完成** | **闭环达成**: 实现了指数退避重试 (Transient) + 死信队列 (Persistent) + 重放接口 (Replay)。数据不再丢失。 |
| | **Merger** | ✅ **已完成** | Host/Service/Web(WebAssets)/WebDetail 的 Upsert 与 `syncToUnified` 主链路已完成，且已实现 Vuln 落库并建立 Host/Service/Web 的关联，Vuln 幂等性已升级为数据库唯一键约束 + Upsert；<br>**最新进展**: 修复了 `AssetHost` 更新时 `SourceStageIDs` 覆盖问题，实现了 ID 集合的并集去重逻辑。Host Tags 决定交由 TagSystem 独立处理，不在 ETL 中硬编码。 |
| | **WebCrawlerDataHandler** | ✅ **已完成** | `Handle` 方法已实现，支持 Base64 截图解码存储 (可配置路径)、HTML Hash 计算与去重。 |
| **2.4 Asset Enrichment** | **FingerprintMatcher** | ✅ **逻辑已完成** | **架构重构**: 原 Offline Governance 已迁移至此。负责存量资产的指纹再识别。已实现基于 `AssetService` 的批量指纹匹配，并支持可选的 TagSystem 联动 (AutoTag) 逻辑。**待办**: 集成 Cron Job 触发器。 |
| **1.4 Master-Agent Update** | **Rule Update Service** | ✅ **已完成** | **重构完成**: 将 `FingerprintSnapshot` 升级为通用的 `RuleSnapshot` 机制。支持 `fingerprint`, `poc`, `virus` 等多种规则类型的确定性打包与分发。API 已升级为支持通用类型，且保持了向下兼容。<br>**最新进展**: 完成了安全配置 (`security.agent`) 的基础设施建设与依赖注入，RuleManager 已具备密钥持有能力，为后续加密传输打下基础。 |
| | **Heartbeat Version Hint** | ✅ **已完成** | 心跳处理链路已集成 `RuleVersions` 字段，Master 自动比较文件 mtime 下发版本号，Agent 无需额外请求即可感知版本变更。 |
| | **Rule Snapshot Source** | 🟡 **部分完成** | 实现了基础的导出与路径映射逻辑。**注意**: 目前代码使用默认路径 (`rules/fingerprint`)，尚未完全对接 `config.yaml` 中的自定义路径配置。 |

### 2. 下一步开发建议

根据 "重构路线图 (Implementation Path)"，目前系统处于 **Phase 5 的落地期**。**ETL 数据闭环** 已基本达成（Mapper + Merger + Error Handling）。

**接下来的工作重点：**

1.  **指纹规则增强 (Fingerprint Rules Enhancement) - P0**:
    *   实现 **Custom Rules Upload** 接口，支持用户自定义指纹。
    *   实现 **True Rollback** 接口，支持回滚并删除错误导入的规则 (Diff & Sync)。

2.  **Asset Enrichment (资产丰富化 - 离线治理) - P1**:
    *   **Cron Job Integration**: 将 `FingerprintMatcher` 接入定时任务。

3.  **Secure Export (规则安全导出) - P1**:
    *   ✅ **已完成**。实现了基于 AES-GCM 加密 + HMAC-SHA256 签名的安全传输协议。详见 `internal/service/agent/SECURE_UPDATE_PROTOCOL.md`。

4.  **Tool Adapter Layer (工具适配) - P2**:
    *   完善 Command Factory 和 Output Normalizer。
