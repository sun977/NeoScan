# 开发进度评估 (截至 2026-01-11)

基于重构方案与代码审计，当前控制面（Control Plane）的整体完成度约 **90%**：Orchestrator 已实现真正的 **DAG 并行执行**（基于 `Predecessors` 依赖解析），并且调度链路已具备 **目标解析 -> 策略拦截 -> 任务生成 -> Pull 分发 -> CAS 认领** 的完整闭环。

数据面（Data Plane）方面："左半边"（目标生成）已完成；"右半边"（结果回流与清洗）已具备 **摄入 + 队列 + Worker 框架 + Host/Service/Web/Unified 入库主链路**，并且 ETL Processor 已接入应用启动链路（随 Scheduler/LocalAgent 一起启动）。同时已补齐 **Vuln 真正落库与关联**、并重做了 **Web 与 WebDetail 的数据结构**（不再依赖“有 WebID 才写 Detail”）。但 ETL 的映射覆盖率与工程化细节仍有缺口：

- 多个 ResultType 的 Mapper 仍是 TODO，且当前实现会导致对应结果被静默丢弃（返回 `nil, nil` -> Merger 直接跳过）。
- ETL 的错误处理策略仍是 TODO（死信队列/重试/告警），目前偏“记录日志后继续”。
- Host 的 Tags 与 SourceStageIDs 合并仍是 TODO（会影响资产画像与可追溯性）。

### 1. 模块详细评估

| 组件 | 子模块 | 状态 | 评估详情 |
| :--- | :--- | :--- | :--- |
| **1.1 Orchestrator** | **ScheduleManager** | ✅ **已完成** | 基于 Cron 的定时触发逻辑已实现，功能完备。 |
| | **TransitionEngine** | ✅ **已完成** | **核心亮点**: 完整实现了基于 Predecessors 的 DAG 依赖解析。<br>**重大改进**: 移除了全局 Barrier (`hasRunning`) 限制。系统现在支持真正的物理并行——当分支 A 完成时，依赖 A 的后续 Stage 会立即启动，无需等待分支 B (Long-running) 完成。 |
| | **TaskGenerator** | ✅ **已完成** | 实现了分块 (`ChunkSize`)、优先级设置和 `AgentTask` 的生成。 |
| | **TaskDispatcher** | ✅ **已完成** | 实现了基于 Pull 模式的任务分发，集成了资源与策略检查，具备 CAS 防抢占机制。 |
| **1.2 Policy Enforcer** | **ScopeValidator** | ✅ **已完成** | 实现了基于 CIDR、IP、域名的范围合规检查。 |
| | **WhitelistChecker** | ✅ **已完成** | 支持多维度的白名单阻断策略。 |
| | **SkipLogicEvaluator** | ✅ **已完成** | 集成了 `Matcher` 引擎，支持复杂的动态跳过规则（当前实现以 MatchRule 为主，时间窗/环境标签未进入生效逻辑）。 |
| **1.3 Resource Allocator** | **AgentSelector** | 🟡 **部分完成** | 实现了基于 Tag 和 Capability 的匹配框架。但 `hasCapability` 目前主要依赖模拟数据，需对接真实的 Agent 能力上报。 |
| | **RateLimiter** | 🟡 **部分完成** | 实现了对 Agent 的频率限制（保护 Master）。**缺失**: 针对扫描目标 IP 段的全局限速（保护目标网络）。 |
| **3.1 Result Ingestor** | **ResultQueue** | ✅ **已完成** | 实现了基于内存的缓冲队列，具备容量限制和削峰填谷能力，并支持配置化。 |
| | **ResultValidator** | ✅ **已完成** | 实现了基础字段校验、TaskID 存在性检查以及 Agent 身份合法性验证。 |
| | **EvidenceArchiver** | ✅ **已完成** | 实现了基于本地文件系统的原始证据归档，支持按 Task/Type/Timestamp 结构化存储。 |
| | **ResultService** | ✅ **已完成** | 实现了 SubmitResult 核心流程：校验 -> 归档 -> 入队。 |
| **2.1 Target Provider** | **Sources** | ✅ **已完成** | 实现了 `Manual`, `File`, `Database`, `PreviousStage` (Pipeline核心) 等多种目标源。 |
| | **Logic** | ✅ **已完成** | 完整的解析 -> 局部白名单 -> 局部跳过 -> 去重流程。 |
| **3.2 Asset ETL Engine** | **Processor Framework** | ✅ **已完成** | `ResultProcessor` 协程池框架已实现，已接入应用启动链路，**架构调整**: 已移除指纹识别依赖，回归纯粹的数据清洗与入库职责。 |
| | **Mapper** | 🟡 **部分完成** | `MapToAssetBundle` 分发框架已完成，Web/Vuln/PoC 等核心映射可用；但 `ip_alive/password_audit/proxy_detection/directory_scan/subdomain_discovery/api_discovery/file_discovery/other_scan` 等映射仍为 TODO，且当前会被静默丢弃。 |
| | **Fingerprint Integration** | 🔄 **已移出** | 根据最新架构，指纹再识别逻辑已移出 ETL 热路径，转为离线治理任务。 |
| | **Merger** | 🟡 **部分完成** | Host/Service/Web(WebAssets)/WebDetail 的 Upsert 与 `syncToUnified` 主链路已完成，且已实现 Vuln 落库并建立 Host/Service/Web 的关联；仍有待补齐：Host Tags/SourceStageIDs 合并、Vuln 去重的数据库约束与幂等策略（目前依赖查询去重，缺少唯一键保障）、入库失败的错误策略（重试/死信/告警）。 |
| | **WebCrawlerDataHandler** | ✅ **已完成** | `Handle` 方法已实现，支持 Base64 截图解码存储 (可配置路径)、HTML Hash 计算与去重。 |
| **2.4 Asset Enrichment** | **FingerprintMatcher** | ✅ **已完成** | **架构重构**: 原 Offline Governance 已迁移至此。负责存量资产的指纹再识别。已实现基于 `AssetService` 的批量指纹匹配，并支持可选的 TagSystem 联动 (AutoTag)。 |
| **1.4 Master-Agent Update** | **Fingerprint Sync API** | ✅ **已完成** | 已接线 Agent Pull 路由：`GET /api/v1/agent/fingerprint/version` 与 `GET /api/v1/agent/fingerprint/download`，支持规则目录快照打包（zip）与 `version_hash` 生成。 |
| | **Heartbeat Version Hint** | 🟡 **部分完成** | 心跳处理链路未返回 `version_hash`，当前依赖 Agent 额外调用 `/fingerprint/version` 获取版本。 |
| | **Rule Snapshot Source** | 🟡 **部分完成** | 当前快照来自配置的规则目录（默认 `rules/fingerprint`）。DB 中规则启用/禁用状态与快照的一致性、快照生成触发机制仍需补齐。 |

### 2. 下一步开发建议

根据 "重构路线图 (Implementation Path)"，目前系统处于 **Phase 5 的落地期**：调度与策略链路已基本就绪，且 **Master-Agent 指纹同步 API 已接线**；剩余的工作重点转向两类“真实缺口”——**数据闭环落库** 与 **跨端一致性/工程化**。

**推荐核心任务：先消灭“静默丢弃”，再推进跨端一致性与工程化**

**具体开发任务清单：**

1.  **Asset Enrichment (资产丰富化 - 离线治理)**:
    *   **FingerprintMatcher Job**: 实现后台任务，定期扫描 `AssetService` 中 `Product` 为空但 `Banner` 不为空的记录，调用指纹服务进行补全。**(✅ 已完成)**
    *   **Tag Linkage**: 实现指纹识别结果自动打标签 (TagSystem) 的逻辑，支持配置是否启用此联动。**(✅ 已完成)**

2.  **Master-Agent 指纹同步机制**:
    *   **API 实现**: 已实现并接线（`/api/v1/agent/fingerprint/version` 与 `/api/v1/agent/fingerprint/download`）。
    *   **心跳集成**: 将 `version_hash` 下发集成到心跳响应（减少额外请求），并明确鉴权与缓存策略。
    *   **规则来源一致性**: 明确快照生成的来源（DB 启用规则 vs 文件目录），并补齐“规则变更 -> 快照版本变更”的触发链路。

3.  **Asset ETL Engine (继续补齐)**:
    *   **Mapper 覆盖率**: 把所有 `return nil, nil` 的映射函数补齐，或至少改成“显式错误 + 可观测告警”，禁止静默丢弃。
    *   **错误策略**: 引入死信队列/错误表，明确重试策略与告警触发条件。

4.  **Tool Adapter Layer (工具适配)**:
    *   **Command Factory**: 实现 Nmap/Masscan 等工具的命令模板生成。
    *   **Output Normalizer**: 确保 Agent 上报的 JSON 格式与 Master 的 Mapper 兼容。

**决策**: 当前已补齐 **ETL 的真实落库链路**（Vuln 与 WebDetail 关联）；下一步优先消灭 **静默丢弃** 并补齐 Mapper 覆盖率与错误策略；随后把 **指纹同步** 做到“跨端一致 + 可运维”（心跳集成、缓存、版本触发）；最后再推进 **工具适配层** 与 **资源调度优化**。
