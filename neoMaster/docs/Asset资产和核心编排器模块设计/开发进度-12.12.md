# 开发进度评估 (截至 2026-01-06)

基于重构方案与代码审计，当前控制面（Control Plane）的整体完成度已达到 **90%**，数据面（Data Plane）的"左半边"（目标生成）也已完成。目前的系统已经具备了完整的**任务调度、策略控制与分发能力**，并支持真正的 **DAG 并行执行**。

### 1. 模块详细评估

| 组件 | 子模块 | 状态 | 评估详情 |
| :--- | :--- | :--- | :--- |
| **1.1 Orchestrator** | **ScheduleManager** | ✅ **已完成** | 基于 Cron 的定时触发逻辑已实现，功能完备。 |
| | **TransitionEngine** | ✅ **已完成** | **核心亮点**: 完整实现了基于 Predecessors 的 DAG 依赖解析。<br>**重大改进**: 移除了全局 Barrier (`hasRunning`) 限制。系统现在支持真正的物理并行——当分支 A 完成时，依赖 A 的后续 Stage 会立即启动，无需等待分支 B (Long-running) 完成。 |
| | **TaskGenerator** | ✅ **已完成** | 实现了分块 (`ChunkSize`)、优先级设置和 `AgentTask` 的生成。 |
| | **TaskDispatcher** | ✅ **已完成** | 实现了基于 Pull 模式的任务分发，集成了资源与策略检查，具备 CAS 防抢占机制。 |
| **1.2 Policy Enforcer** | **ScopeValidator** | ✅ **已完成** | 实现了基于 CIDR、IP、域名的范围合规检查。 |
| | **WhitelistChecker** | ✅ **已完成** | 支持多维度的白名单阻断策略。 |
| | **SkipLogicEvaluator** | ✅ **已完成** | **亮点**: 集成了 `Matcher` 引擎，支持复杂的动态跳过规则（如时间窗+环境标签组合）。 |
| **1.3 Resource Allocator** | **AgentSelector** | 🟡 **部分完成** | 实现了基于 Tag 和 Capability 的匹配框架。但 `hasCapability` 目前主要依赖模拟数据，需对接真实的 Agent 能力上报。 |
| | **RateLimiter** | 🟡 **部分完成** | 实现了对 Agent 的频率限制（保护 Master）。**缺失**: 针对扫描目标 IP 段的全局限速（保护目标网络）。 |
| **3.1 Result Ingestor** | **ResultQueue** | ✅ **已完成** | 实现了基于内存的缓冲队列，具备容量限制和削峰填谷能力，并支持配置化。 |
| | **ResultValidator** | ✅ **已完成** | 实现了基础字段校验、TaskID 存在性检查以及 Agent 身份合法性验证。 |
| | **EvidenceArchiver** | ✅ **已完成** | 实现了基于本地文件系统的原始证据归档，支持按 Task/Type/Timestamp 结构化存储。 |
| | **ResultService** | ✅ **已完成** | 实现了 SubmitResult 核心流程：校验 -> 归档 -> 入队。 |
| **2.1 Target Provider** | **Sources** | ✅ **已完成** | 实现了 `Manual`, `File`, `Database`, `PreviousStage` (Pipeline核心) 等多种目标源。 |
| | **Logic** | ✅ **已完成** | 完整的解析 -> 局部白名单 -> 局部跳过 -> 去重流程。 |

### 2. 下一步开发建议

根据 "重构路线图 (Implementation Path)"，目前系统处于"管杀不管埋"的状态——任务生成与分发体系已成熟，但任务结果的回流处理链路尚未建立。

**推荐核心任务：Phase 4: The Cleaner (数据清洗与闭环)**

**具体开发任务清单：**

1.  **Result Ingestor (结果摄入)**:
    *   **Result API**: 定义 HTTP 接口接收 `StageResult`。(待实现)
    *   **ResultQueue**: 实现缓冲队列 (Redis List/Channel) 以削峰填谷。(✅ 已完成)
    *   **ResultValidator**: 校验数据格式与签名。(✅ 已完成)
    *   **EvidenceArchiver**: 原始证据归档 (S3/Local)。(✅ 已完成)

2.  **Asset ETL Engine (核心清洗逻辑)**:
    *   **Merger**: 实现 `StageResult` -> `Asset` 的 Upsert 逻辑 (IP/Port/Service/Web)。
    *   **FingerprintMatcher**: 将杂乱的工具指纹统一映射为 CPE 标准格式。
    *   **WebCrawlerDataHandler**: 专用处理器，处理截图、HTML 等非结构化数据。
    *   **关联分析**: 建立 Host、Service、Web 应用之间的关联关系。

**次优先级任务 (优化项)**:
*   **完善资源调度**: 实现基于目标网段的全局限速器。
*   **ApiProvider**: 对接外部 CMDB 或云资源 API。

**决策**: 立即启动 **Phase 4** 的开发，打通 "扫描 -> 结果 -> 资产" 的完整闭环。
