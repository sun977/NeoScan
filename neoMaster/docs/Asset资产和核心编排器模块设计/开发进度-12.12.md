# å¼€å‘è¿›åº¦è¯„ä¼° (æˆªè‡³ 2026-01-14)

åŸºäºé‡æ„æ–¹æ¡ˆä¸ä»£ç å®¡è®¡ï¼Œå½“å‰æ§åˆ¶é¢ï¼ˆControl Planeï¼‰çš„æ•´ä½“å®Œæˆåº¦çº¦ **95%**ï¼šOrchestrator å·²å®ç°çœŸæ­£çš„ **DAG å¹¶è¡Œæ‰§è¡Œ**ï¼ˆåŸºäº `Predecessors` ä¾èµ–è§£æï¼‰ï¼Œå¹¶ä¸”è°ƒåº¦é“¾è·¯å·²å…·å¤‡ **ç›®æ ‡è§£æ -> ç­–ç•¥æ‹¦æˆª -> ä»»åŠ¡ç”Ÿæˆ -> Pull åˆ†å‘ -> CAS è®¤é¢†** çš„å®Œæ•´é—­ç¯ã€‚

æ•°æ®é¢ï¼ˆData Planeï¼‰æ–¹é¢ï¼š"å·¦åŠè¾¹"ï¼ˆç›®æ ‡ç”Ÿæˆï¼‰å·²å®Œæˆï¼›"å³åŠè¾¹"ï¼ˆç»“æœå›æµä¸æ¸…æ´—ï¼‰å·²å…·å¤‡ **æ‘„å…¥ + é˜Ÿåˆ— + Worker æ¡†æ¶ + Host/Service/Web/Unified å…¥åº“ä¸»é“¾è·¯**ï¼Œå¹¶ä¸” ETL Processor å·²æ¥å…¥åº”ç”¨å¯åŠ¨é“¾è·¯ï¼ˆéš Scheduler/LocalAgent ä¸€èµ·å¯åŠ¨ï¼‰ã€‚åŒæ—¶å·²è¡¥é½ **Vuln çœŸæ­£è½åº“ä¸å…³è”**ã€å¹¶é‡åšäº† **Web ä¸ WebDetail çš„æ•°æ®ç»“æ„**ï¼ˆä¸å†ä¾èµ–â€œæœ‰ WebID æ‰å†™ Detailâ€ï¼‰ã€‚

**æœ€æ–°è¿›å±• (2026-01-14)**:
- **Fingerprint Rules Enhancement**:
    - âœ… **Custom Rules Upload**: å®ç°äº†åŸºäº Source (System/Custom) éš”ç¦»çš„è‡ªå®šä¹‰è§„åˆ™ä¸Šä¼ æ¥å£ã€‚
    - âœ… **True Rollback**: å®ç°äº†åŸºäº `Diff & Sync` (Transaction + Truncate + Re-insert) çš„å¼ºä¸€è‡´æ€§å›æ»šæœºåˆ¶ï¼Œå½»åº•è§£å†³äº†è„æ•°æ®æ®‹ç•™é—®é¢˜ã€‚
    - âœ… **DB Schema**: `AssetFinger` å’Œ `AssetCPE` è¡¨æ–°å¢ `Source` å­—æ®µã€‚
- **Code Hygiene**: å®Œæˆäº†æ ¸å¿ƒæ¨¡å— (`rule_manager`) çš„æ–‡ä»¶æ“ä½œæ ‡å‡†åŒ–ï¼Œç»Ÿä¸€ä½¿ç”¨ `utils` åŒ…ï¼Œæ¶ˆé™¤äº†å¯¹å·²å¼ƒç”¨ `io/ioutil` çš„ä¾èµ–ï¼Œæå‡äº†ä»£ç çš„å¯ç»´æŠ¤æ€§ã€‚
- **ETL é”™è¯¯å¤„ç†é—­ç¯**: å®ç°äº†å®Œæ•´çš„ DLQ (Dead Letter Queue) æœºåˆ¶ã€‚å¤±è´¥ä»»åŠ¡ä¸å†é™é»˜ä¸¢å¼ƒï¼Œè€Œæ˜¯é™çº§ä¸º `AssetETLError` å¹¶æ”¯æŒé€šè¿‡ API é‡æ”¾ã€‚
- **Mapper è¦†ç›–ç‡**: æ ¸å¿ƒæ‰«æç±»å‹ (`ip_alive`, `port_scan`, `fingerprint`, `vuln`, `poc`, `web`, `password`) å·²å…¨éƒ¨æ”¯æŒï¼Œè¾¹ç¼˜ç±»å‹ (`proxy`, `directory` ç­‰) å·²åœ¨ä»£ç å±‚é¢æ˜¾å¼æ ‡è®°ä¸ºè·³è¿‡ (Explicit Skip)ï¼Œç­‰å¾…ä¸“å±è¡¨è®¾è®¡ã€‚
- **æŒ‡çº¹æ²»ç†**: ç¦»çº¿æŒ‡çº¹åŒ¹é…é€»è¾‘ (`FingerprintMatcher`) å·²å°±ç»ªï¼Œæ”¯æŒä» Service è¡¨æå–æ•°æ®è¿›è¡Œå†è¯†åˆ«ã€‚

### 1. æ¨¡å—è¯¦ç»†è¯„ä¼°

| ç»„ä»¶ | å­æ¨¡å— | çŠ¶æ€ | è¯„ä¼°è¯¦æƒ… |
| :--- | :--- | :--- | :--- |
| **1.1 Orchestrator** | **ScheduleManager** | âœ… **å·²å®Œæˆ** | åŸºäº Cron çš„å®šæ—¶è§¦å‘é€»è¾‘å·²å®ç°ï¼ŒåŠŸèƒ½å®Œå¤‡ã€‚ |
| | **TransitionEngine** | âœ… **å·²å®Œæˆ** | **æ ¸å¿ƒäº®ç‚¹**: å®Œæ•´å®ç°äº†åŸºäº Predecessors çš„ DAG ä¾èµ–è§£æã€‚<br>**é‡å¤§æ”¹è¿›**: ç§»é™¤äº†å…¨å±€ Barrier (`hasRunning`) é™åˆ¶ã€‚ç³»ç»Ÿç°åœ¨æ”¯æŒçœŸæ­£çš„ç‰©ç†å¹¶è¡Œâ€”â€”å½“åˆ†æ”¯ A å®Œæˆæ—¶ï¼Œä¾èµ– A çš„åç»­ Stage ä¼šç«‹å³å¯åŠ¨ï¼Œæ— éœ€ç­‰å¾…åˆ†æ”¯ B (Long-running) å®Œæˆã€‚ |
| | **TaskGenerator** | âœ… **å·²å®Œæˆ** | å®ç°äº†åˆ†å— (`ChunkSize`)ã€ä¼˜å…ˆçº§è®¾ç½®å’Œ `AgentTask` çš„ç”Ÿæˆã€‚ |
| | **TaskDispatcher** | âœ… **å·²å®Œæˆ** | å®ç°äº†åŸºäº Pull æ¨¡å¼çš„ä»»åŠ¡åˆ†å‘ï¼Œé›†æˆäº†èµ„æºä¸ç­–ç•¥æ£€æŸ¥ï¼Œå…·å¤‡ CAS é˜²æŠ¢å æœºåˆ¶ã€‚ |
| **1.2 Policy Enforcer** | **ScopeValidator** | âœ… **å·²å®Œæˆ** | å®ç°äº†åŸºäº CIDRã€IPã€åŸŸåçš„èŒƒå›´åˆè§„æ£€æŸ¥ã€‚ |
| | **WhitelistChecker** | âœ… **å·²å®Œæˆ** | æ”¯æŒå¤šç»´åº¦çš„ç™½åå•é˜»æ–­ç­–ç•¥ã€‚ |
| | **SkipLogicEvaluator** | âœ… **å·²å®Œæˆ** | é›†æˆäº† `Matcher` å¼•æ“ï¼Œæ”¯æŒå¤æ‚çš„åŠ¨æ€è·³è¿‡è§„åˆ™ï¼ˆå½“å‰å®ç°ä»¥ MatchRule ä¸ºä¸»ï¼Œæ—¶é—´çª—/ç¯å¢ƒæ ‡ç­¾æœªè¿›å…¥ç”Ÿæ•ˆé€»è¾‘ï¼‰ã€‚ |
| **1.3 Resource Allocator** | **AgentSelector** | ğŸŸ¡ **éƒ¨åˆ†å®Œæˆ** | å®ç°äº†åŸºäº Tag å’Œ Capability çš„åŒ¹é…æ¡†æ¶ã€‚ä½† `hasCapability` ç›®å‰ä¸»è¦ä¾èµ–æ¨¡æ‹Ÿæ•°æ®ï¼Œéœ€å¯¹æ¥çœŸå®çš„ Agent èƒ½åŠ›ä¸ŠæŠ¥ã€‚ |
| | **RateLimiter** | ğŸŸ¡ **éƒ¨åˆ†å®Œæˆ** | å®ç°äº†å¯¹ Agent çš„é¢‘ç‡é™åˆ¶ï¼ˆä¿æŠ¤ Masterï¼‰ã€‚**ç¼ºå¤±**: é’ˆå¯¹æ‰«æç›®æ ‡ IP æ®µçš„å…¨å±€é™é€Ÿï¼ˆä¿æŠ¤ç›®æ ‡ç½‘ç»œï¼‰ã€‚ |
| **3.1 Result Ingestor** | **ResultQueue** | âœ… **å·²å®Œæˆ** | å®ç°äº†åŸºäºå†…å­˜çš„ç¼“å†²é˜Ÿåˆ—ï¼Œå…·å¤‡å®¹é‡é™åˆ¶å’Œå‰Šå³°å¡«è°·èƒ½åŠ›ï¼Œå¹¶æ”¯æŒé…ç½®åŒ–ã€‚ |
| | **ResultValidator** | âœ… **å·²å®Œæˆ** | å®ç°äº†åŸºç¡€å­—æ®µæ ¡éªŒã€TaskID å­˜åœ¨æ€§æ£€æŸ¥ä»¥åŠ Agent èº«ä»½åˆæ³•æ€§éªŒè¯ã€‚ |
| | **EvidenceArchiver** | âœ… **å·²å®Œæˆ** | å®ç°äº†åŸºäºæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿçš„åŸå§‹è¯æ®å½’æ¡£ï¼Œæ”¯æŒæŒ‰ Task/Type/Timestamp ç»“æ„åŒ–å­˜å‚¨ã€‚ |
| | **ResultService** | âœ… **å·²å®Œæˆ** | å®ç°äº† SubmitResult æ ¸å¿ƒæµç¨‹ï¼šæ ¡éªŒ -> å½’æ¡£ -> å…¥é˜Ÿã€‚ |
| **2.1 Target Provider** | **Sources** | âœ… **å·²å®Œæˆ** | å®ç°äº† `Manual`, `File`, `Database`, `PreviousStage` (Pipelineæ ¸å¿ƒ) ç­‰å¤šç§ç›®æ ‡æºã€‚ |
| | **Logic** | âœ… **å·²å®Œæˆ** | å®Œæ•´çš„è§£æ -> å±€éƒ¨ç™½åå• -> å±€éƒ¨è·³è¿‡ -> å»é‡æµç¨‹ã€‚ |
| **3.2 Asset ETL Engine** | **Processor Framework** | âœ… **å·²å®Œæˆ** | `ResultProcessor` åç¨‹æ± æ¡†æ¶å·²å®ç°ï¼Œå·²æ¥å…¥åº”ç”¨å¯åŠ¨é“¾è·¯ï¼Œ**æ¶æ„è°ƒæ•´**: å·²ç§»é™¤æŒ‡çº¹è¯†åˆ«ä¾èµ–ï¼Œå›å½’çº¯ç²¹çš„æ•°æ®æ¸…æ´—ä¸å…¥åº“èŒè´£ã€‚ |
| | **Mapper** | âœ… **å¤§éƒ¨åˆ†å®Œæˆ** | `MapToAssetBundle` åˆ†å‘æ¡†æ¶å·²å®Œæˆã€‚æ ¸å¿ƒæ”¯æŒ: `ip_alive`, `port_scan`, `service_fingerprint`, `vuln_finding`, `poc_scan`, `web_endpoint`, `password_audit`ã€‚<br>**æ˜¾å¼è·³è¿‡**: `proxy`, `directory`, `subdomain`, `api`, `file` (å¾…ä¸“é—¨è¡¨è®¾è®¡)ã€‚ |
| | **Error Policy** | âœ… **å·²å®Œæˆ** | **é—­ç¯è¾¾æˆ**: å®ç°äº†æŒ‡æ•°é€€é¿é‡è¯• (Transient) + æ­»ä¿¡é˜Ÿåˆ— (Persistent) + é‡æ”¾æ¥å£ (Replay)ã€‚æ•°æ®ä¸å†ä¸¢å¤±ã€‚ |
| | **Merger** | âœ… **å·²å®Œæˆ** | Host/Service/Web(WebAssets)/WebDetail çš„ Upsert ä¸ `syncToUnified` ä¸»é“¾è·¯å·²å®Œæˆï¼Œä¸”å·²å®ç° Vuln è½åº“å¹¶å»ºç«‹ Host/Service/Web çš„å…³è”ï¼ŒVuln å¹‚ç­‰æ€§å·²å‡çº§ä¸ºæ•°æ®åº“å”¯ä¸€é”®çº¦æŸ + Upsertï¼›<br>**æœ€æ–°è¿›å±•**: ä¿®å¤äº† `AssetHost` æ›´æ–°æ—¶ `SourceStageIDs` è¦†ç›–é—®é¢˜ï¼Œå®ç°äº† ID é›†åˆçš„å¹¶é›†å»é‡é€»è¾‘ã€‚Host Tags å†³å®šäº¤ç”± TagSystem ç‹¬ç«‹å¤„ç†ï¼Œä¸åœ¨ ETL ä¸­ç¡¬ç¼–ç ã€‚ |
| | **WebCrawlerDataHandler** | âœ… **å·²å®Œæˆ** | `Handle` æ–¹æ³•å·²å®ç°ï¼Œæ”¯æŒ Base64 æˆªå›¾è§£ç å­˜å‚¨ (å¯é…ç½®è·¯å¾„)ã€HTML Hash è®¡ç®—ä¸å»é‡ã€‚ |
| **2.4 Asset Enrichment** | **FingerprintMatcher** | âœ… **é€»è¾‘å·²å®Œæˆ** | **æ¶æ„é‡æ„**: åŸ Offline Governance å·²è¿ç§»è‡³æ­¤ã€‚è´Ÿè´£å­˜é‡èµ„äº§çš„æŒ‡çº¹å†è¯†åˆ«ã€‚å·²å®ç°åŸºäº `AssetService` çš„æ‰¹é‡æŒ‡çº¹åŒ¹é…ï¼Œå¹¶æ”¯æŒå¯é€‰çš„ TagSystem è”åŠ¨ (AutoTag) é€»è¾‘ã€‚**å¾…åŠ**: é›†æˆ Cron Job è§¦å‘å™¨ã€‚ |
| **1.4 Master-Agent Update** | **Rule Update Service** | âœ… **å·²å®Œæˆ** | **é‡æ„å®Œæˆ**: å°† `FingerprintSnapshot` å‡çº§ä¸ºé€šç”¨çš„ `RuleSnapshot` æœºåˆ¶ã€‚æ”¯æŒ `fingerprint`, `poc`, `virus` ç­‰å¤šç§è§„åˆ™ç±»å‹çš„ç¡®å®šæ€§æ‰“åŒ…ä¸åˆ†å‘ã€‚API å·²å‡çº§ä¸ºæ”¯æŒé€šç”¨ç±»å‹ï¼Œä¸”ä¿æŒäº†å‘ä¸‹å…¼å®¹ã€‚<br>**æœ€æ–°è¿›å±•**: å®Œæˆäº†å®‰å…¨é…ç½® (`security.agent`) çš„åŸºç¡€è®¾æ–½å»ºè®¾ä¸ä¾èµ–æ³¨å…¥ï¼ŒRuleManager å·²å…·å¤‡å¯†é’¥æŒæœ‰èƒ½åŠ›ï¼Œä¸ºåç»­åŠ å¯†ä¼ è¾“æ‰“ä¸‹åŸºç¡€ã€‚ |
| | **Heartbeat Version Hint** | âœ… **å·²å®Œæˆ** | å¿ƒè·³å¤„ç†é“¾è·¯å·²é›†æˆ `RuleVersions` å­—æ®µï¼ŒMaster è‡ªåŠ¨æ¯”è¾ƒæ–‡ä»¶ mtime ä¸‹å‘ç‰ˆæœ¬å·ï¼ŒAgent æ— éœ€é¢å¤–è¯·æ±‚å³å¯æ„ŸçŸ¥ç‰ˆæœ¬å˜æ›´ã€‚ |
| | **Rule Snapshot Source** | âœ… **å·²å®Œæˆ** | å®ç°äº†åŸºç¡€çš„å¯¼å‡ºä¸è·¯å¾„æ˜ å°„é€»è¾‘ã€‚**æœ€æ–°è¿›å±•**: å¯¹æ¥äº† `config.yaml` ä¸”ä¼˜åŒ–äº†å¤‡ä»½ç›®å½•ç»“æ„ (`rules/backups/fingerprint`)ï¼Œä¸å†ä½¿ç”¨ç¡¬ç¼–ç è·¯å¾„ã€‚ |

### 2. ä¸‹ä¸€æ­¥å¼€å‘å»ºè®®

æ ¹æ® "é‡æ„è·¯çº¿å›¾ (Implementation Path)"ï¼Œç›®å‰ç³»ç»Ÿå¤„äº **Phase 5 çš„è½åœ°æœŸ**ã€‚**ETL æ•°æ®é—­ç¯** å·²åŸºæœ¬è¾¾æˆï¼ˆMapper + Merger + Error Handlingï¼‰ã€‚

**æ¥ä¸‹æ¥çš„å·¥ä½œé‡ç‚¹ï¼š**

1.  **æŒ‡çº¹è§„åˆ™å¢å¼º (Fingerprint Rules Enhancement) - P0**:
    *   âœ… **Custom Rules Upload**: å·²å®ç°ã€‚
    *   âœ… **True Rollback**: å·²å®ç°ã€‚

2.  **Asset Enrichment (èµ„äº§ä¸°å¯ŒåŒ– - ç¦»çº¿æ²»ç†) - P1**:
    *   **Cron Job Integration**: å°† `FingerprintMatcher` æ¥å…¥å®šæ—¶ä»»åŠ¡ã€‚

3.  **Secure Export (è§„åˆ™å®‰å…¨å¯¼å‡º) - P1**:
    *   âœ… **å·²å®Œæˆ**ã€‚å®ç°äº†åŸºäº AES-GCM åŠ å¯† + HMAC-SHA256 ç­¾åçš„å®‰å…¨ä¼ è¾“åè®®ã€‚è¯¦è§ `internal/service/agent/SECURE_UPDATE_PROTOCOL.md`ã€‚

4.  **Tool Adapter Layer (å·¥å…·é€‚é…) - P2**:
    *   å®Œå–„ Command Factory å’Œ Output Normalizerã€‚
