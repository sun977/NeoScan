   
# 控制面 ("大脑") 完成度评估报告

基于重构方案与代码审计，当前控制面（Control Plane）的整体完成度约为 **85%**。核心骨架已搭建完毕，关键的决策、合规与分发逻辑均已实现。

### 1. 模块详细评估

| 组件 | 子模块 | 状态 | 评估详情 |
| :--- | :--- | :--- | :--- |
| **1.1 Orchestrator** | **ScheduleManager** | ✅ **已完成** | 基于 Cron 的定时触发逻辑已实现，功能完备。 |
| | **TransitionEngine** | 🟡 **基本完成** | **核心亮点**: 完整实现了基于 Predecessors 的 DAG 依赖解析。<br>**不足**: 存在全局 Barrier (`hasRunning`)，导致同一项目内即使是无依赖的平行 Stage 也无法真正并行执行。目前的调度是"逻辑并行，物理串行"。 |
| | **TaskDispatcher** | ✅ **已完成** | 实现了基于 Pull 模式的任务分发，集成了资源与策略检查，具备 CAS 防抢占机制。 |
| **1.2 Policy Enforcer** | **ScopeValidator** | ✅ **已完成** | 实现了基于 CIDR、IP、域名的范围合规检查。 |
| | **WhitelistChecker** | ✅ **已完成** | 支持多维度的白名单阻断策略。 |
| | **SkipLogicEvaluator** | ✅ **已完成** | **亮点**: 集成了 `Matcher` 引擎，支持复杂的动态跳过规则（如时间窗+环境标签组合）。 |
| **1.3 Resource Allocator** | **AgentSelector** | 🟡 **部分完成** | 实现了基于 Tag 和 Capability 的匹配框架。但 `hasCapability` 目前主要依赖模拟数据，需对接真实的 Agent 能力上报。 |
| | **RateLimiter** | 🟡 **部分完成** | 实现了对 Agent 的频率限制（保护 Master）。**缺失**: 针对扫描目标 IP 段的全局限速（保护目标网络）。 |

### 2. 下一步开发建议

根据 "重构路线图 (Implementation Path)"，Phase 1 (数据结构) 和 Phase 3 (大脑/控制面) 已基本就绪。

**推荐下一步核心任务：Phase 4: The Cleaner (数据清洗与闭环)**

虽然"大脑"已经能发号施令，但目前系统处于"管杀不管埋"的状态——任务结果（StageResult）虽然被 Agent 上报了，但还没有被系统化地清洗、合并并转化为持久化的资产数据（Asset）。

**具体开发任务清单：**

1.  **Result Ingestor (结果摄入)**:
    *   完善 `ResultQueue` 消费逻辑。
    *   实现 `ResultValidator`，确保 Agent 上报的数据格式合法。

2.  **Asset ETL Engine (核心清洗逻辑)**:
    *   **Merger**: 实现 `IP/Port` -> `AssetService` 的 Upsert 逻辑（存在更新，不存在插入）。
    *   **FingerprintMatcher**: 将杂乱的工具指纹（Nmap/Masscan/Nuclei）统一映射为 CPE 标准格式。
    *   **关联分析**: 建立 Host、Service、Web 应用之间的关联关系。

**次优先级任务 (优化项)**:
*   **解锁 DAG 并行**: 优化 `ProcessProject` 中的锁机制，允许无依赖的 Stage 物理并行执行。
*   **完善资源调度**: 实现基于目标网段的全局限速器。

**决策**: 建议立即启动 **Phase 4** 的开发，打通 "扫描 -> 结果 -> 资产" 的完整闭环。