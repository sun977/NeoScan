# NeoScan扫描工程设计方案

## 1. 概述

扫描工程方案是NeoScan系统的核心概念，它定义了一个完整的、可重复执行的扫描任务集合。通过工程方案，用户可以配置复杂的扫描流程，包括数据源、扫描工具、执行策略、结果处理和通知机制等。

## 2. 核心概念

### 2.1 工程方案 (Project Scheme)
工程方案是一个完整的扫描工作流程配置，包含从数据获取到结果输出的全过程定义。

### 2.2 非工程方案 (Ad-hoc Scan)
针对特定目标的一次性扫描任务，无需创建完整工程方案。

### 2.3 工作流 (Workflow)
定义扫描任务的执行顺序和逻辑关系，包括工具链、处理节点等。

## 3. 工程方案详细设计

### 3.1 时间周期配置

工程方案支持多种时间调度模式：

```go
type ScheduleConfig struct {
    Type      string     `json:"type"` // immediate, scheduled, recurring
    StartTime *time.Time `json:"start_time"`
    CronExpr  string     `json:"cron_expr"`  // Cron表达式，用于周期性任务
    Enabled   bool       `json:"enabled"`
    EndTime   *time.Time `json:"end_time"`   // 可选的结束时间
}

// 支持的调度类型：
// 1. 立即执行 (immediate) - 创建后立即执行
// 2. 定时执行 (scheduled) - 在指定时间执行一次
// 3. 周期执行 (recurring) - 按Cron表达式周期执行
```


### 3.2 数据源配置

支持多种数据源类型，便于灵活获取扫描目标：

```go
type DataSourceConfig struct {
    Type        string      `json:"type"` // database, api, file, manual
    Source      string      `json:"source"`
    Query       string      `json:"query"`      // 数据库查询语句
    APIConfig   APIConfig   `json:"api_config"` // API配置
    FileConfig  FileConfig  `json:"file_config"` // 文件配置
    ManualData  []string    `json:"manual_data"` // 手动输入数据
}

type APIConfig struct {
    URL         string            `json:"url"`
    Method      string            `json:"method"`
    Headers     map[string]string `json:"headers"`
    Body        string            `json:"body"`
    AuthType    string            `json:"auth_type"` // none, basic, bearer, api_key
    AuthConfig  map[string]string `json:"auth_config"`
    ResponsePath string           `json:"response_path"` // 从响应中提取目标的JSON路径
}

type FileConfig struct {
    Path        string `json:"path"`
    Format      string `json:"format"` // csv, json, txt
    TargetField string `json:"target_field"` // 目标字段名
}
```


### 3.3 扫描工作流配置

定义扫描任务的执行流程和工具链：

```go
type WorkflowConfig struct {
    Stages      []WorkflowStage `json:"stages"`       // 扫描阶段
    Tools       []ToolConfig    `json:"tools"`        // 工具配置
    ResultHandlers []ResultHandlerConfig `json:"result_handlers"` // 结果处理器
}

type WorkflowStage struct {
    Name        string   `json:"name"`
    Type        string   `json:"type"` // discovery, port_scan, vuln_scan, web_scan
    Order       int      `json:"order"`
    Enabled     bool     `json:"enabled"`
    Dependencies []string `json:"dependencies"` // 依赖的前置阶段
}

type ToolConfig struct {
    ID          string            `json:"id"`
    Name        string            `json:"name"`        // 工具名称 (nmap, nuclei等)
    Version     string            `json:"version"`
    Parameters  map[string]string `json:"parameters"`  // 工具参数
    Stage       string            `json:"stage"`       // 所属阶段
    Enabled     bool              `json:"enabled"`
    Timeout     int               `json:"timeout"`     // 超时时间(秒)
    Concurrency int               `json:"concurrency"` // 并发数
}

type ResultHandlerConfig struct {
    ID          string            `json:"id"`
    Name        string            `json:"name"`
    Type        string            `json:"type"` // filter, transform, enrich, dedup
    Config      map[string]string `json:"config"`
    Enabled     bool              `json:"enabled"`
}
```


### 3.4 扫描策略配置

定义扫描过程中的各种策略和规则：

```go
type StrategyConfig struct {
    Whitelist      []string     `json:"whitelist"`       // 白名单
    Blacklist      []string     `json:"blacklist"`       // 黑名单
    SkipRules      []SkipRule   `json:"skip_rules"`      // 跳过规则
    Timeout        int          `json:"timeout"`         // 总超时时间(秒)
    UseProxy       bool         `json:"use_proxy"`       // 是否使用代理
    ProxyConfig    ProxyConfig  `json:"proxy_config"`    // 代理配置
    RateLimit      RateLimit    `json:"rate_limit"`      // 速率限制
    RetryConfig    RetryConfig  `json:"retry_config"`    // 重试配置
}

type SkipRule struct {
    Condition   string `json:"condition"` // 条件表达式
    Action      string `json:"action"`    // skip, pause, alert
    Description string `json:"description"`
}

type ProxyConfig struct {
    Type     string `json:"type"` // http, socks5
    Address  string `json:"address"`
    Username string `json:"username"`
    Password string `json:"password"`
}

type RateLimit struct {
    RequestsPerSecond int `json:"requests_per_second"`
    Burst             int `json:"burst"`
}

type RetryConfig struct {
    MaxRetries    int `json:"max_retries"`
    RetryInterval int `json:"retry_interval"` // 重试间隔(秒)
}
```


### 3.5 结果存储配置

定义扫描结果的存储方式和位置：

```go
type StorageConfig struct {
    Type          string        `json:"type"` // database, file, remote
    Path          string        `json:"path"`
    Format        string        `json:"format"` // json, xml, csv
    Compression   bool          `json:"compression"`
    Encryption    bool          `json:"encryption"`
    Retention     RetentionPolicy `json:"retention"` // 保留策略
    PostProcessors []PostProcessorConfig `json:"post_processors"` // 后处理配置
}

type RetentionPolicy struct {
    Days      int  `json:"days"`       // 保留天数
    AutoClean bool `json:"auto_clean"` // 是否自动清理
}

type PostProcessorConfig struct {
    Name   string            `json:"name"`
    Type   string            `json:"type"` // report, export, notify
    Config map[string]string `json:"config"`
}
```


### 3.6 通知配置

定义扫描完成后的通知方式和内容：

```go
type NotificationConfig struct {
    Enabled    bool              `json:"enabled"`
    Channels   []string          `json:"channels"`   // email, webhook, sms, slack
    Recipients []string          `json:"recipients"`
    Template   NotificationTemplate `json:"template"`
    Conditions []NotificationCondition `json:"conditions"` // 触发条件
}

type NotificationTemplate struct {
    Subject string `json:"subject"`
    Body    string `json:"body"`
    Format  string `json:"format"` // text, html
}

type NotificationCondition struct {
    Type     string `json:"type"`     // always, on_failure, on_success, on_threshold
    Severity string `json:"severity"` // critical, high, medium, low
    Count    int    `json:"count"`    // 漏洞数量阈值
}
```


## 4. 非工程方案设计

针对临时、一次性扫描需求：

```go
type AdHocScan struct {
    ID          string         `json:"id" gorm:"primaryKey"`
    Name        string         `json:"name"`
    Description string         `json:"description"`
    Targets     []string       `json:"targets"`
    ScanType    string         `json:"scan_type"` // port_scan, web_scan, vuln_scan
    Tools       []ToolConfig   `json:"tools"`
    Strategy    StrategyConfig `json:"strategy"`
    Storage     StorageConfig  `json:"storage"`
    Notification NotificationConfig `json:"notification"`
    CreatedAt   time.Time      `json:"created_at"`
    CreatedBy   string         `json:"created_by"`
    Status      string         `json:"status"` // pending, running, completed, failed
}
```


## 5. 高级功能：可视化工作流设计

支持通过拖拽方式自定义扫描流程：

### 5.1 工作流节点定义

```go
type WorkflowNode struct {
    ID          string      `json:"id"`
    Type        string      `json:"type"` // data_source, scanner, processor, decision, output
    Name        string      `json:"name"`
    Config      interface{} `json:"config"`
    Position    Position    `json:"position"`
    InputPorts  []Port      `json:"input_ports"`
    OutputPorts []Port      `json:"output_ports"`
}

type Position struct {
    X int `json:"x"`
    Y int `json:"y"`
}

type Port struct {
    ID   string `json:"id"`
    Name string `json:"name"`
    Type string `json:"type"` // input, output
}

// 不同类型的节点配置
type DataSourceNodeConfig struct {
    DataSourceConfig DataSourceConfig `json:"data_source_config"`
}

type ScannerNodeConfig struct {
    ToolConfig ToolConfig `json:"tool_config"`
}

type ProcessorNodeConfig struct {
    Type   string            `json:"type"` // filter, transform, enrich
    Config map[string]string `json:"config"`
}

type DecisionNodeConfig struct {
    Conditions []Condition `json:"conditions"`
}

type Condition struct {
    Expression string `json:"expression"`
    NextNode   string `json:"next_node"`
}

type OutputNodeConfig struct {
    StorageConfig StorageConfig `json:"storage_config"`
}
```


### 5.2 节点连接

```go
type NodeConnection struct {
    ID     string `json:"id"`
    From   PortRef `json:"from"` // 源节点端口
    To     PortRef `json:"to"`   // 目标节点端口
    Condition string `json:"condition"` // 条件表达式（用于决策节点）
}

type PortRef struct {
    NodeID string `json:"node_id"`
    PortID string `json:"port_id"`
}
```


### 5.3 自定义工作流

```go
type CustomWorkflow struct {
    ID          string           `json:"id" gorm:"primaryKey"`
    Name        string           `json:"name"`
    Description string           `json:"description"`
    Nodes       []WorkflowNode   `json:"nodes"`
    Connections []NodeConnection `json:"connections"`
    CreatedAt   time.Time        `json:"created_at"`
    UpdatedAt   time.Time        `json:"updated_at"`
    CreatedBy   string           `json:"created_by"`
    Version     string           `json:"version"`
}
```


## 6. 实现建议

### 6.1 分阶段实现

1. **第一阶段**：实现基础的工程方案和非工程方案功能
2. **第二阶段**：完善各种配置选项和策略控制
3. **第三阶段**：开发可视化工作流编辑器

### 6.2 数据模型设计

建议在`internal/model/`目录下创建以下模型：
- `project_scheme.go` - 工程方案模型
- `adhoc_scan.go` - 非工程方案模型
- `workflow.go` - 工作流模型
- `scan_template.go` - 扫描模板模型

### 6.3 API设计

建议在`internal/handler/`目录下创建以下处理器：
- `project_scheme_handler.go` - 工程方案API处理器
- `adhoc_scan_handler.go` - 非工程方案API处理器
- `workflow_handler.go` - 工作流API处理器

### 6.4 服务层设计

建议在`internal/service/`目录下创建以下服务：
- `project_scheme_service.go` - 工程方案业务逻辑
- `adhoc_scan_service.go` - 非工程方案业务逻辑
- `workflow_service.go` - 工作流业务逻辑

## 7. 总结

该设计方案充分考虑了你提出的需求，并结合NeoScan系统的现有架构进行了扩展。通过工程方案、非工程方案和可视化工作流三种方式，可以满足从简单到复杂的各种扫描需求。同时，该设计具有良好的扩展性，便于后续功能增强和优化。