# setup 目录启动与初始化说明

本文件用于说明 neoMaster 项目中 `internal/app/master/setup` 目录的定位、职责与使用方式，帮助后续维护者在不破坏既有架构约束的前提下，快速理解并扩展系统的启动初始化流程。

## 1. 目录定位（为什么需要 setup）
- 统一承载“模块级初始化与依赖装配”的代码，减少 `router_manager.go` 中的样板代码与耦合。
- 严格遵守分层调用关系：Controller/Handler → Service → Repository → Database。`setup` 负责“组装”，不直接承载业务逻辑。
- 支持模块化输出，将同域内的 Handler、Service 聚合为 Module，供路由层集中注册与中间件装配。
- 与现有项目约束对齐：
  - Web 框架：Gin
  - 依赖管理：go mod
  - ORM：gorm
  - 日志：统一使用 `internal/pkg/logger`
  - 类型转换：统一使用 `internal/pkg/convert`

## 2. 关键文件与职责

- `types.go`
  - 定义模块聚合结构体，用于对外暴露同域的 Handler 与 Service。
  - 目前包含：
    - `AuthModule`：认证域聚合（运行时授权校验、会话、JWT、密码、用户相关处理器与服务）。
    - `SystemRBACModule`：系统管理域聚合（角色与权限的 CRUD 管理处理器与服务）。

- `auth.go`
  - 构建“认证域（Auth）”模块的初始化函数：`BuildAuthModule`。
  - 典型装配流程：
    1) 初始化安全管理器：JWTManager、PasswordManager。
    2) 初始化仓库：SessionRepository（通常为 Redis）、UserRepository（gorm/MySQL）。
    3) 初始化服务：UserService、RBACService（认证域运行时授权）、SessionService、JWTService、PasswordService。
    4) 初始化处理器：LoginHandler、LogoutHandler、RefreshHandler、RegisterHandler。
    5) 组装并返回 `AuthModule`。
  - 注意：此处的 `RBACService` 属于“认证域”，用于中间件与会话流程的运行时权限判定，依赖 `UserService` 与认证链路（JWT/Session）。

- `rbac.go`
  - 构建“系统管理域（System RBAC）”模块的初始化函数：`BuildSystemRBACModule`。
  - 典型装配流程：
    1) 初始化仓库：RoleRepository、PermissionRepository。
    2) 初始化服务：RoleService、PermissionService。
    3) 初始化处理器：RoleHandler、PermissionHandler。
    4) 组装并返回 `SystemRBACModule`。
  - 注意：此处的角色/权限服务属于“系统管理域”的配置治理，不参与每次请求的运行时权限判定，不依赖 Redis/Session/JWT。

## 3. 与路由层（router_manager.go）的协作方式
- 路由层通过调用 `setup.BuildAuthModule` 获取认证域的 `SessionService`、`RBACService`、`JWTService`，用于构造 `MiddlewareManager` 并注册认证相关路由。
- 路由层通过调用 `setup.BuildSystemRBACModule` 获取系统管理域的 `RoleHandler`、`PermissionHandler`，用于注册后台管理接口（角色/权限的 CRUD）。
- 日志要求：在 Handler 层记录 `path`（c.Request.URL.String()）、并在 Service 层记录 `operation` 与 `option`，`func_name` 使用“.”连接的完整路径（例如 `handler.auth.register.Register`）。统一使用 `internal/pkg/logger`。

## 4. 认证域与系统管理域的边界说明（避免混淆）
- 认证域（Auth）：面向“请求管道”的运行时逻辑，负责登录、会话、JWT/密码校验与权限判定。其 `RBACService` 依赖 `UserService` 与会话管理，是中间件的关键输入。
- 系统管理域（System RBAC）：面向“运营配置”的静态治理，负责角色/权限的 CRUD 与分配，不参与每次请求的中间件校验。其服务仅依赖数据库仓库。
- 调用关系：系统管理域写入权限配置数据 → 认证域在运行时读取并执行权限校验。保持两者分离能避免跨域耦合与循环依赖，降低测试与维护成本。

## 5. 扩展与新增模块的建议流程
1) 在 `types.go` 中为新域定义聚合结构体（例如 `ScanModule`）。
2) 在 `setup` 下新增对应的构建文件（例如 `scan.go`），按“Repository → Service → Handler”的顺序初始化并聚合为 Module。
3) 在 `router_manager.go` 中调用新的 `BuildXXXModule`，集中完成中间件装配与路由注册。
4) 日志与类型转换统一使用项目封装：`internal/pkg/logger` 与 `internal/pkg/convert`。
5) 测试用例放在 `neoMaster/test/日期目录` 下（例如 `test/20251014/xxx_test.go`），优先覆盖正常流程、边界条件与异常情况。

## 6. 基础设施初始化的可选抽取（建议）
- 若多个模块需要复用相同的基础设施构造逻辑（例如 Redis 客户端、JWT/Password 管理器），可在 `setup` 层新增 `common/infra.go` 辅助构造函数，并在各模块的 `BuildXXXModule` 中调用。
- 保持“模块职责边界”不变：认证域与系统管理域的组装仍在各自文件中完成，避免将两者合并到同一构建函数。

## 7. 编译与运行
- 编译：请在项目根路径切换到 `neoMaster` 目录后执行
  - `go build cmd/master -o neoMaster.exe`
- 注意事项：
  - `debug` 目录下是完整的测试代码（含 main.go），日常编译忽略 `debug` 下的代码，仅在特殊测试时使用。
  - 确保 `.env` 与配置文件（`configs/config.yaml` 等）已按环境正确设置，敏感信息放置在 `.env` 中且不要提交到 Git。

## 8. 常见问题（FAQ）
- 问：为什么 `auth.go` 里也有 `rbacService` 初始化？
  - 答：该 `RBACService` 属于“认证域”，用于中间件与会话流程的运行时权限判定，依赖 `UserService` 与 Session/JWT 链路，必须与 Auth 一起初始化。`rbac.go` 中的角色/权限服务属于“系统管理域”的配置治理，两者职责不同。
- 问：是否需要统一抽取数据库与 Redis 初始化？
  - 答：在不破坏模块边界的前提下，可以仅抽取“通用基础设施构造”到 `setup/common/infra.go`，供需要的模块调用；不建议把认证域与系统管理域的初始化合并到一个文件。
- 问：遇到编译错误 `非声明语句出现在函数体之外` 怎么办？
  - 答：检查新改动的文件是否存在不可见字符或导入块格式问题，必要时对文件进行标准化重写（统一导入顺序与注释块），再重新编译。

## 9. 质量与规范对齐
- 代码风格：遵循现有项目风格与命名约定，添加必要注释与文档。
- 安全规范：API 密钥等敏感信息使用 `.env` 管理，实施输入验证与输出编码，避免硬编码敏感信息。
- 文档同步：`setup` 变更需同步更新本说明及相关模块设计文档（`neoMaster/docs`）。
- 测试策略：测试优先，覆盖正常流程、边界条件与异常情况；集成测试确保模块间正确集成。

---
维护建议：当新增或调整模块初始化时，优先考虑是否会破坏已有的域边界与依赖闭环；若存在不确定性，请在 `docs/rbac` 或相关设计文档中记录决策与变更原因，以便团队协作与后续维护。