package agent

import (
	"fmt"
	"net/http"

	"github.com/gin-gonic/gin"

	"neomaster/internal/model/system"
	"neomaster/internal/pkg/logger"
	"neomaster/internal/pkg/utils"
)

// FetchTasks 获取Agent需执行的任务
// 路由: GET /api/v1/agent/tasks?agent_id=xxx
func (h *AgentHandler) FetchTasks(c *gin.Context) {
	clientIP := utils.GetClientIP(c)
	XRequestID := c.GetHeader("X-Request-ID")
	pathUrl := c.Request.URL.String()

	agentID := c.Param("id")
	if agentID == "" {
		agentID = c.Query("agent_id") // Fallback for query param if needed
	}
	if agentID == "" {
		logger.LogBusinessError(
			fmt.Errorf("agent_id is required"),
			XRequestID,
			0,
			clientIP,
			pathUrl,
			"GET",
			map[string]interface{}{
				"operation": "fetch_tasks",
				"option":    "paramValidation",
			},
		)
		c.JSON(http.StatusBadRequest, system.APIResponse{
			Code:    http.StatusBadRequest,
			Status:  "failed",
			Message: "agent_id is required",
		})
		return
	}

	tasks, err := h.agentTaskService.GetAgentTasks(agentID)
	if err != nil {
		logger.LogBusinessError(
			err,
			XRequestID,
			0,
			clientIP,
			pathUrl,
			"GET",
			map[string]interface{}{
				"operation": "fetch_tasks",
				"option":    "service.GetAgentTasks",
				"agent_id":  agentID,
			},
		)
		c.JSON(http.StatusInternalServerError, system.APIResponse{
			Code:    http.StatusInternalServerError,
			Status:  "failed",
			Message: "Failed to fetch tasks",
			Error:   err.Error(),
		})
		return
	}

	c.JSON(http.StatusOK, system.APIResponse{
		Code:    http.StatusOK,
		Status:  "success",
		Message: "Tasks fetched successfully",
		Data:    tasks,
	})
}

// UpdateTaskStatus 更新任务状态
// 路由: POST /api/v1/agent/tasks/:task_id/status
func (h *AgentHandler) UpdateTaskStatus(c *gin.Context) {
	clientIP := utils.GetClientIP(c)
	XRequestID := c.GetHeader("X-Request-ID")
	pathUrl := c.Request.URL.String()

	taskID := c.Param("task_id")
	if taskID == "" {
		c.JSON(http.StatusBadRequest, system.APIResponse{
			Code:    http.StatusBadRequest,
			Status:  "failed",
			Message: "task_id is required",
		})
		return
	}

	var req struct {
		Status   string `json:"status" binding:"required"`
		Result   string `json:"result"`    // Optional result JSON
		ErrorMsg string `json:"error_msg"` // Optional error message
	}
	if err := c.ShouldBindJSON(&req); err != nil {
		logger.LogBusinessError(
			err,
			XRequestID,
			0,
			clientIP,
			pathUrl,
			"POST",
			map[string]interface{}{
				"operation": "update_task_status",
				"option":    "bind_json",
			},
		)
		c.JSON(http.StatusBadRequest, system.APIResponse{
			Code:    http.StatusBadRequest,
			Status:  "failed",
			Message: "Invalid request body",
			Error:   err.Error(),
		})
		return
	}

	if err := h.agentTaskService.UpdateTaskStatus(taskID, req.Status, req.Result, req.ErrorMsg); err != nil {
		logger.LogBusinessError(
			err,
			XRequestID,
			0,
			clientIP,
			pathUrl,
			"POST",
			map[string]interface{}{
				"operation": "update_task_status",
				"option":    "service.UpdateTaskStatus",
				"task_id":   taskID,
				"status":    req.Status,
			},
		)
		c.JSON(http.StatusInternalServerError, system.APIResponse{
			Code:    http.StatusInternalServerError,
			Status:  "failed",
			Message: "Failed to update task status",
			Error:   err.Error(),
		})
		return
	}

	c.JSON(http.StatusOK, system.APIResponse{
		Code:    http.StatusOK,
		Status:  "success",
		Message: "Task status updated successfully",
	})
}
