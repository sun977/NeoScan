# NeoScan扫描工程设计方案v2.0

## 1. 概述

扫描工程方案是NeoScan系统的核心概念，它定义了一个完整的、可重复执行的扫描任务集合。通过工程方案，用户可以配置复杂的扫描流程，包括数据源、扫描工具、执行策略、结果处理和通知机制等。

## 2. 核心概念

### 2.1 工程方案 (Project Scheme)
工程方案是一个完整的扫描工作流程配置，包含从数据获取到结果输出的全过程定义。它支持定时执行和周期性执行，可以对接各种数据源，并定义完整的扫描策略。

### 2.2 非工程方案 (Ad-hoc Scan)
针对特定目标的一次性扫描任务，无需创建完整工程方案，适用于临时的、紧急的扫描需求。

### 2.3 工作流 (Workflow)
定义扫描任务的执行顺序和逻辑关系，包括工具链、处理节点等。支持可视化拖拽方式自定义复杂的工作流程。

## 3. 工程方案详细设计

### 3.1 时间周期配置

工程方案支持灵活的时间调度模式，满足不同场景的需求：

```json
{
  "schedule": {
    "type": "recurring",
    "start_time": "2025-01-01T00:00:00Z",
    "cron_expr": "0 0 * * *",
    "enabled": true,
    "end_time": "2025-12-31T23:59:59Z"
  }
}
```


支持的调度类型：
- **立即执行 (immediate)** - 创建后立即执行
- **定时执行 (scheduled)** - 在指定时间执行一次
- **周期执行 (recurring)** - 按Cron表达式周期执行

### 3.2 数据源配置

支持多种数据源类型，便于灵活获取扫描目标：

```json
{
  "data_source": {
    "type": "api",
    "source": "https://cmdb.example.com/api/assets",
    "query": "SELECT ip FROM assets WHERE type='web_server'",
    "api_config": {
      "url": "https://cmdb.example.com/api/assets",
      "method": "GET",
      "headers": {
        "Authorization": "Bearer token123",
        "Content-Type": "application/json"
      },
      "auth_type": "bearer",
      "response_path": "$.data[*].ip"
    },
    "file_config": {
      "path": "/data/targets.csv",
      "format": "csv",
      "target_field": "ip"
    },
    "manual_data": ["192.168.1.1", "example.com"]
  }
}
```


支持的数据源类型：
- **系统内置数据库** - 直接查询NeoScan系统内的资产数据
- **第三方API** - 通过API接口获取目标数据
- **第三方数据库** - 连接外部数据库获取扫描目标
- **文件导入** - 从CSV、JSON等文件中读取目标
- **手动输入** - 直接输入扫描目标列表

### 3.3 扫描工作流配置

定义扫描任务的执行流程和工具链：

```json
{
  "workflow": {
    "stages": [
      {
        "name": "资产发现",
        "type": "discovery",
        "order": 1,
        "enabled": true,
        "dependencies": []
      },
      {
        "name": "端口扫描",
        "type": "port_scan",
        "order": 2,
        "enabled": true,
        "dependencies": ["资产发现"]
      }
    ],
    "tools": [
      {
        "id": "nmap_001",
        "name": "nmap",
        "version": "7.94",
        "parameters": {
          "ports": "1-1000",
          "scan_type": "syn",
          "timing": "T3"
        },
        "stage": "端口扫描",
        "enabled": true,
        "timeout": 3600,
        "concurrency": 10
      }
    ],
    "result_handlers": [
      {
        "id": "filter_001",
        "name": "开放端口过滤器",
        "type": "filter",
        "config": {
          "filter_condition": "port.state == 'open'"
        },
        "enabled": true
      }
    ]
  }
}
```


工作流包含以下要素：
- **扫描阶段 (Stages)** - 定义扫描的逻辑阶段，如资产发现、端口扫描、漏洞扫描等
- **扫描工具 (Tools)** - 配置每个阶段使用的具体工具及其参数
- **结果处理器 (Result Handlers)** - 定义扫描结果的处理方式，如过滤、转换、丰富等

### 3.4 扫描策略配置

定义扫描过程中的各种策略和规则：

```json
{
  "strategy": {
    "whitelist": ["192.168.0.0/16"],
    "blacklist": ["10.0.0.0/8"],
    "skip_rules": [
      {
        "condition": "asset.type == 'network_device'",
        "action": "skip",
        "description": "跳过网络设备扫描"
      },
      {
        "condition": "service.name == 'CDN'",
        "action": "skip",
        "description": "跳过CDN节点扫描"
      }
    ],
    "timeout": 7200,
    "use_proxy": true,
    "proxy_config": {
      "type": "http",
      "address": "proxy.example.com:8080",
      "username": "user",
      "password": "pass"
    },
    "rate_limit": {
      "requests_per_second": 10,
      "burst": 20
    },
    "retry_config": {
      "max_retries": 3,
      "retry_interval": 60
    }
  }
}
```


策略配置包括：
- **白名单/黑名单** - 定义需要扫描或跳过的目标范围
- **跳过规则** - 根据资产类型、服务类型等条件跳过特定目标
- **超时控制** - 设置扫描任务的总体超时时间
- **代理配置** - 支持通过代理服务器进行扫描
- **速率限制** - 控制扫描请求的发送频率
- **重试机制** - 配置失败任务的重试策略

### 3.5 结果存储配置

定义扫描结果的存储方式和位置：

```json
{
  "storage": {
    "type": "database",
    "path": "/results/project_001",
    "format": "json",
    "compression": true,
    "encryption": false,
    "retention": {
      "days": 90,
      "auto_clean": true
    },
    "post_processors": [
      {
        "name": "漏洞报告生成器",
        "type": "report",
        "config": {
          "template": "vulnerability_report",
          "format": "pdf"
        }
      }
    ]
  }
}
```


存储配置包括：
- **存储类型** - 支持数据库、文件系统、远程存储等
- **存储路径** - 定义结果存储的具体位置
- **格式压缩** - 支持结果数据的格式化和压缩
- **数据加密** - 对敏感结果数据进行加密存储
- **保留策略** - 自动清理过期的扫描结果
- **后处理** - 结果生成后的进一步处理，如生成报告

### 3.6 通知配置

定义扫描完成后的通知方式和内容：

```json
{
  "notification": {
    "enabled": true,
    "channels": ["email", "webhook"],
    "recipients": ["admin@example.com", "security@example.com"],
    "template": {
      "subject": "扫描任务 {{task_name}} 完成",
      "body": "任务 {{task_name}} 已完成，发现 {{vuln_count}} 个漏洞",
      "format": "html"
    },
    "conditions": [
      {
        "type": "on_threshold",
        "severity": "high",
        "count": 5
      }
    ]
  }
}
```


通知配置包括：
- **通知渠道** - 支持邮件、Webhook、短信等多种通知方式
- **接收人员** - 定义通知的接收者列表
- **通知模板** - 自定义通知内容的模板
- **触发条件** - 根据扫描结果决定是否发送通知

## 4. 非工程方案设计

针对临时、一次性扫描需求：

```json
{
  "adhoc_scan": {
    "id": "adhoc_001",
    "name": "紧急漏洞扫描",
    "description": "对新上线系统进行紧急安全扫描",
    "targets": ["192.168.1.100", "test.example.com"],
    "scan_type": "vuln_scan",
    "tools": [
      {
        "name": "nuclei",
        "parameters": {
          "templates": "cves/",
          "severity": "critical,high"
        }
      }
    ],
    "strategy": {
      "timeout": 1800,
      "use_proxy": false
    },
    "storage": {
      "type": "file",
      "path": "/tmp/adhoc_results"
    },
    "notification": {
      "enabled": true,
      "channels": ["email"],
      "recipients": ["admin@example.com"]
    }
  }
}
```


非工程方案特点：
- 简化配置，快速执行
- 适用于临时、紧急扫描任务
- 无需创建完整的工作流程定义
- 支持快速结果查看和处理

## 5. 高级功能：可视化工作流设计

支持通过拖拽方式自定义扫描流程，实现完全自定义的处理节点和任务：

### 5.1 工作流节点定义

```json
{
  "workflow_nodes": [
    {
      "id": "node_001",
      "type": "data_source",
      "name": "CMDB数据源",
      "config": {
        "data_source_config": {
          "type": "api",
          "api_config": {
            "url": "https://cmdb.example.com/api/web_servers",
            "method": "GET"
          }
        }
      },
      "position": {"x": 100, "y": 100}
    },
    {
      "id": "node_002",
      "type": "scanner",
      "name": "Nmap端口扫描",
      "config": {
        "tool_config": {
          "name": "nmap",
          "parameters": {
            "ports": "1-1000"
          }
        }
      },
      "position": {"x": 300, "y": 100}
    },
    {
      "id": "node_003",
      "type": "decision",
      "name": "开放端口判断",
      "config": {
        "conditions": [
          {
            "expression": "port.state == 'open'",
            "next_node": "node_004"
          }
        ]
      },
      "position": {"x": 500, "y": 100}
    },
    {
      "id": "node_004",
      "type": "processor",
      "name": "漏洞扫描",
      "config": {
        "type": "transform",
        "config": {
          "action": "nuclei_scan"
        }
      },
      "position": {"x": 700, "y": 100}
    }
  ]
}
```


支持的节点类型：
- **数据源节点** - 获取扫描目标数据
- **扫描器节点** - 执行具体扫描任务
- **处理器节点** - 处理扫描结果数据
- **决策节点** - 根据条件决定执行路径
- **输出节点** - 定义结果存储方式

### 5.2 节点连接

```json
{
  "connections": [
    {
      "id": "conn_001",
      "from": {"node_id": "node_001", "port_id": "output_1"},
      "to": {"node_id": "node_002", "port_id": "input_1"}
    },
    {
      "id": "conn_002",
      "from": {"node_id": "node_002", "port_id": "output_1"},
      "to": {"node_id": "node_003", "port_id": "input_1"}
    }
  ]
}
```


### 5.3 自定义工作流

```json
{
  "custom_workflow": {
    "id": "workflow_001",
    "name": "智能资产扫描流程",
    "description": "根据资产类型自动选择扫描策略",
    "nodes": ["node_001", "node_002", "node_003", "node_004"],
    "connections": ["conn_001", "conn_002"],
    "version": "1.0"
  }
}
```


可视化工作流特点：
- **节点拖拽** - 通过可视化界面拖拽节点构建工作流
- **连接配置** - 通过连线定义节点间的数据流
- **条件判断** - 支持复杂的条件判断和分支处理
- **完全自定义** - 不受内置工作流限制，可实现任意复杂逻辑

## 6. 实现建议

### 6.1 分阶段实现

1. **第一阶段**：实现基础的工程方案和非工程方案功能
2. **第二阶段**：完善各种配置选项和策略控制
3. **第三阶段**：开发可视化工作流编辑器

### 6.2 功能优先级

1. **核心功能** - 工程方案的创建、执行和管理
2. **数据源集成** - 支持多种数据源接入方式
3. **策略控制** - 完善的扫描策略配置
4. **可视化编辑** - 拖拽式工作流设计界面
5. **高级特性** - AI辅助决策、智能调度等

## 7. 总结

该设计方案充分考虑了用户需求，并结合NeoScan系统的现有架构进行了扩展。通过工程方案、非工程方案和可视化工作流三种方式，可以满足从简单到复杂的各种扫描需求。同时，该设计具有良好的扩展性，便于后续功能增强和优化。